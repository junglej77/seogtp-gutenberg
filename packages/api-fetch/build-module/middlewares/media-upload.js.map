{"version":3,"names":["__","parseAndThrowError","parseResponseAndNormalizeError","isMediaUploadRequest","options","isCreateMethod","method","isMediaEndpoint","path","indexOf","url","mediaUploadMiddleware","next","retries","maxRetries","postProcess","attachmentId","data","action","parse","catch","Promise","reject","response","headers","get","status","code","message","then"],"sources":["@wordpress/api-fetch/src/middlewares/media-upload.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { __ } from '@wordpress/i18n';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport {\r\n\tparseAndThrowError,\r\n\tparseResponseAndNormalizeError,\r\n} from '../utils/response';\r\n\r\n/**\r\n * @param {import('../types').APIFetchOptions} options\r\n * @return {boolean} True if the request is for media upload.\r\n */\r\nfunction isMediaUploadRequest( options ) {\r\n\tconst isCreateMethod = !! options.method && options.method === 'POST';\r\n\tconst isMediaEndpoint =\r\n\t\t( !! options.path && options.path.indexOf( '/wp/v2/media' ) !== -1 ) ||\r\n\t\t( !! options.url && options.url.indexOf( '/wp/v2/media' ) !== -1 );\r\n\r\n\treturn isMediaEndpoint && isCreateMethod;\r\n}\r\n\r\n/**\r\n * Middleware handling media upload failures and retries.\r\n *\r\n * @type {import('../types').APIFetchMiddleware}\r\n */\r\nconst mediaUploadMiddleware = ( options, next ) => {\r\n\tif ( ! isMediaUploadRequest( options ) ) {\r\n\t\treturn next( options );\r\n\t}\r\n\r\n\tlet retries = 0;\r\n\tconst maxRetries = 5;\r\n\r\n\t/**\r\n\t * @param {string} attachmentId\r\n\t * @return {Promise<any>} Processed post response.\r\n\t */\r\n\tconst postProcess = ( attachmentId ) => {\r\n\t\tretries++;\r\n\t\treturn next( {\r\n\t\t\tpath: `/wp/v2/media/${ attachmentId }/post-process`,\r\n\t\t\tmethod: 'POST',\r\n\t\t\tdata: { action: 'create-image-subsizes' },\r\n\t\t\tparse: false,\r\n\t\t} ).catch( () => {\r\n\t\t\tif ( retries < maxRetries ) {\r\n\t\t\t\treturn postProcess( attachmentId );\r\n\t\t\t}\r\n\t\t\tnext( {\r\n\t\t\t\tpath: `/wp/v2/media/${ attachmentId }?force=true`,\r\n\t\t\t\tmethod: 'DELETE',\r\n\t\t\t} );\r\n\r\n\t\t\treturn Promise.reject();\r\n\t\t} );\r\n\t};\r\n\r\n\treturn next( { ...options, parse: false } )\r\n\t\t.catch( ( response ) => {\r\n\t\t\t// `response` could actually be an error thrown by `defaultFetchHandler`.\r\n\t\t\tif ( ! response.headers ) {\r\n\t\t\t\treturn Promise.reject( response );\r\n\t\t\t}\r\n\r\n\t\t\tconst attachmentId = response.headers.get(\r\n\t\t\t\t'x-wp-upload-attachment-id'\r\n\t\t\t);\r\n\t\t\tif (\r\n\t\t\t\tresponse.status >= 500 &&\r\n\t\t\t\tresponse.status < 600 &&\r\n\t\t\t\tattachmentId\r\n\t\t\t) {\r\n\t\t\t\treturn postProcess( attachmentId ).catch( () => {\r\n\t\t\t\t\tif ( options.parse !== false ) {\r\n\t\t\t\t\t\treturn Promise.reject( {\r\n\t\t\t\t\t\t\tcode: 'post_process',\r\n\t\t\t\t\t\t\tmessage: __(\r\n\t\t\t\t\t\t\t\t'Media upload failed. If this is a photo or a large image, please scale it down and try again.'\r\n\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t} );\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn Promise.reject( response );\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\t\t\treturn parseAndThrowError( response, options.parse );\r\n\t\t} )\r\n\t\t.then( ( response ) =>\r\n\t\t\tparseResponseAndNormalizeError( response, options.parse )\r\n\t\t);\r\n};\r\n\r\nexport default mediaUploadMiddleware;\r\n"],"mappings":"AAAA;AACA;AACA;AACA,SAASA,EAAE,QAAQ,iBAAiB;;AAEpC;AACA;AACA;AACA,SACCC,kBAAkB,EAClBC,8BAA8B,QACxB,mBAAmB;;AAE1B;AACA;AACA;AACA;AACA,SAASC,oBAAoBA,CAAEC,OAAO,EAAG;EACxC,MAAMC,cAAc,GAAG,CAAC,CAAED,OAAO,CAACE,MAAM,IAAIF,OAAO,CAACE,MAAM,KAAK,MAAM;EACrE,MAAMC,eAAe,GAClB,CAAC,CAAEH,OAAO,CAACI,IAAI,IAAIJ,OAAO,CAACI,IAAI,CAACC,OAAO,CAAE,cAAe,CAAC,KAAK,CAAC,CAAC,IAChE,CAAC,CAAEL,OAAO,CAACM,GAAG,IAAIN,OAAO,CAACM,GAAG,CAACD,OAAO,CAAE,cAAe,CAAC,KAAK,CAAC,CAAG;EAEnE,OAAOF,eAAe,IAAIF,cAAc;AACzC;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAMM,qBAAqB,GAAGA,CAAEP,OAAO,EAAEQ,IAAI,KAAM;EAClD,IAAK,CAAET,oBAAoB,CAAEC,OAAQ,CAAC,EAAG;IACxC,OAAOQ,IAAI,CAAER,OAAQ,CAAC;EACvB;EAEA,IAAIS,OAAO,GAAG,CAAC;EACf,MAAMC,UAAU,GAAG,CAAC;;EAEpB;AACD;AACA;AACA;EACC,MAAMC,WAAW,GAAKC,YAAY,IAAM;IACvCH,OAAO,EAAE;IACT,OAAOD,IAAI,CAAE;MACZJ,IAAI,EAAG,gBAAgBQ,YAAc,eAAc;MACnDV,MAAM,EAAE,MAAM;MACdW,IAAI,EAAE;QAAEC,MAAM,EAAE;MAAwB,CAAC;MACzCC,KAAK,EAAE;IACR,CAAE,CAAC,CAACC,KAAK,CAAE,MAAM;MAChB,IAAKP,OAAO,GAAGC,UAAU,EAAG;QAC3B,OAAOC,WAAW,CAAEC,YAAa,CAAC;MACnC;MACAJ,IAAI,CAAE;QACLJ,IAAI,EAAG,gBAAgBQ,YAAc,aAAY;QACjDV,MAAM,EAAE;MACT,CAAE,CAAC;MAEH,OAAOe,OAAO,CAACC,MAAM,CAAC,CAAC;IACxB,CAAE,CAAC;EACJ,CAAC;EAED,OAAOV,IAAI,CAAE;IAAE,GAAGR,OAAO;IAAEe,KAAK,EAAE;EAAM,CAAE,CAAC,CACzCC,KAAK,CAAIG,QAAQ,IAAM;IACvB;IACA,IAAK,CAAEA,QAAQ,CAACC,OAAO,EAAG;MACzB,OAAOH,OAAO,CAACC,MAAM,CAAEC,QAAS,CAAC;IAClC;IAEA,MAAMP,YAAY,GAAGO,QAAQ,CAACC,OAAO,CAACC,GAAG,CACxC,2BACD,CAAC;IACD,IACCF,QAAQ,CAACG,MAAM,IAAI,GAAG,IACtBH,QAAQ,CAACG,MAAM,GAAG,GAAG,IACrBV,YAAY,EACX;MACD,OAAOD,WAAW,CAAEC,YAAa,CAAC,CAACI,KAAK,CAAE,MAAM;QAC/C,IAAKhB,OAAO,CAACe,KAAK,KAAK,KAAK,EAAG;UAC9B,OAAOE,OAAO,CAACC,MAAM,CAAE;YACtBK,IAAI,EAAE,cAAc;YACpBC,OAAO,EAAE5B,EAAE,CACV,+FACD;UACD,CAAE,CAAC;QACJ;QAEA,OAAOqB,OAAO,CAACC,MAAM,CAAEC,QAAS,CAAC;MAClC,CAAE,CAAC;IACJ;IACA,OAAOtB,kBAAkB,CAAEsB,QAAQ,EAAEnB,OAAO,CAACe,KAAM,CAAC;EACrD,CAAE,CAAC,CACFU,IAAI,CAAIN,QAAQ,IAChBrB,8BAA8B,CAAEqB,QAAQ,EAAEnB,OAAO,CAACe,KAAM,CACzD,CAAC;AACH,CAAC;AAED,eAAeR,qBAAqB","ignoreList":[]}