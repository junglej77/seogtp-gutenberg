{"version":3,"names":["useRefEffect","useSelect","getScrollContainer","useCallback","useLayoutEffect","useMemo","useState","store","blockEditorStore","useBlockElement","hasStickyOrFixedPositionValue","getVisibleElementBounds","COMMON_PROPS","placement","DEFAULT_PROPS","flip","shift","RESTRICTED_HEIGHT_PROPS","getProps","contentElement","selectedBlockElement","scrollContainer","toolbarHeight","isSticky","scrollTop","blockRect","contentRect","getBoundingClientRect","topOfContentElementInViewport","top","viewportHeight","ownerDocument","documentElement","clientHeight","restrictedTopArea","hasSpaceForToolbarAbove","isBlockTallerThanViewport","height","useBlockToolbarPopoverProps","clientId","setToolbarHeight","blockIndex","select","getBlockIndex","getBlockAttributes","props","setProps","popoverRef","popoverNode","offsetHeight","updateProps","contentView","defaultView","addEventHandler","resizeObserver","blockView","ResizeObserver","observe","removeEventHandler","disconnect","ref"],"sources":["@wordpress/block-editor/src/components/block-tools/use-block-toolbar-popover-props.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useRefEffect } from '@wordpress/compose';\r\nimport { useSelect } from '@wordpress/data';\r\nimport { getScrollContainer } from '@wordpress/dom';\r\nimport {\r\n\tuseCallback,\r\n\tuseLayoutEffect,\r\n\tuseMemo,\r\n\tuseState,\r\n} from '@wordpress/element';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../store';\r\nimport { useBlockElement } from '../block-list/use-block-props/use-block-refs';\r\nimport { hasStickyOrFixedPositionValue } from '../../hooks/position';\r\nimport { getVisibleElementBounds } from '../../utils/dom';\r\n\r\nconst COMMON_PROPS = {\r\n\tplacement: 'top-start',\r\n};\r\n\r\n// By default the toolbar sets the `shift` prop. If the user scrolls the page\r\n// down the toolbar will stay on screen by adopting a sticky position at the\r\n// top of the viewport.\r\nconst DEFAULT_PROPS = {\r\n\t...COMMON_PROPS,\r\n\tflip: false,\r\n\tshift: true,\r\n};\r\n\r\n// When there isn't enough height between the top of the block and the editor\r\n// canvas, the `shift` prop is set to `false`, as it will cause the block to be\r\n// obscured. The `flip` behavior is enabled, which positions the toolbar below\r\n// the block. This only happens if the block is smaller than the viewport, as\r\n// otherwise the toolbar will be off-screen.\r\nconst RESTRICTED_HEIGHT_PROPS = {\r\n\t...COMMON_PROPS,\r\n\tflip: true,\r\n\tshift: false,\r\n};\r\n\r\n/**\r\n * Get the popover props for the block toolbar, determined by the space at the top of the canvas and the toolbar height.\r\n *\r\n * @param {Element} contentElement       The DOM element that represents the editor content or canvas.\r\n * @param {Element} selectedBlockElement The outer DOM element of the first selected block.\r\n * @param {Element} scrollContainer      The scrollable container for the contentElement.\r\n * @param {number}  toolbarHeight        The height of the toolbar in pixels.\r\n * @param {boolean} isSticky             Whether or not the selected block is sticky or fixed.\r\n *\r\n * @return {Object} The popover props used to determine the position of the toolbar.\r\n */\r\nfunction getProps(\r\n\tcontentElement,\r\n\tselectedBlockElement,\r\n\tscrollContainer,\r\n\ttoolbarHeight,\r\n\tisSticky\r\n) {\r\n\tif ( ! contentElement || ! selectedBlockElement ) {\r\n\t\treturn DEFAULT_PROPS;\r\n\t}\r\n\r\n\t// Get how far the content area has been scrolled.\r\n\tconst scrollTop = scrollContainer?.scrollTop || 0;\r\n\r\n\tconst blockRect = getVisibleElementBounds( selectedBlockElement );\r\n\tconst contentRect = contentElement.getBoundingClientRect();\r\n\r\n\t// Get the vertical position of top of the visible content area.\r\n\tconst topOfContentElementInViewport = scrollTop + contentRect.top;\r\n\r\n\t// The document element's clientHeight represents the viewport height.\r\n\tconst viewportHeight =\r\n\t\tcontentElement.ownerDocument.documentElement.clientHeight;\r\n\r\n\t// The restricted height area is calculated as the sum of the\r\n\t// vertical position of the visible content area, plus the height\r\n\t// of the block toolbar.\r\n\tconst restrictedTopArea = topOfContentElementInViewport + toolbarHeight;\r\n\tconst hasSpaceForToolbarAbove = blockRect.top > restrictedTopArea;\r\n\r\n\tconst isBlockTallerThanViewport =\r\n\t\tblockRect.height > viewportHeight - toolbarHeight;\r\n\r\n\t// Sticky blocks are treated as if they will never have enough space for the toolbar above.\r\n\tif (\r\n\t\t! isSticky &&\r\n\t\t( hasSpaceForToolbarAbove || isBlockTallerThanViewport )\r\n\t) {\r\n\t\treturn DEFAULT_PROPS;\r\n\t}\r\n\r\n\treturn RESTRICTED_HEIGHT_PROPS;\r\n}\r\n\r\n/**\r\n * Determines the desired popover positioning behavior, returning a set of appropriate props.\r\n *\r\n * @param {Object}  elements\r\n * @param {Element} elements.contentElement The DOM element that represents the editor content or canvas.\r\n * @param {string}  elements.clientId       The clientId of the first selected block.\r\n *\r\n * @return {Object} The popover props used to determine the position of the toolbar.\r\n */\r\nexport default function useBlockToolbarPopoverProps( {\r\n\tcontentElement,\r\n\tclientId,\r\n} ) {\r\n\tconst selectedBlockElement = useBlockElement( clientId );\r\n\tconst [ toolbarHeight, setToolbarHeight ] = useState( 0 );\r\n\tconst { blockIndex, isSticky } = useSelect(\r\n\t\t( select ) => {\r\n\t\t\tconst { getBlockIndex, getBlockAttributes } =\r\n\t\t\t\tselect( blockEditorStore );\r\n\t\t\treturn {\r\n\t\t\t\tblockIndex: getBlockIndex( clientId ),\r\n\t\t\t\tisSticky: hasStickyOrFixedPositionValue(\r\n\t\t\t\t\tgetBlockAttributes( clientId )\r\n\t\t\t\t),\r\n\t\t\t};\r\n\t\t},\r\n\t\t[ clientId ]\r\n\t);\r\n\tconst scrollContainer = useMemo( () => {\r\n\t\tif ( ! contentElement ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\treturn getScrollContainer( contentElement );\r\n\t}, [ contentElement ] );\r\n\tconst [ props, setProps ] = useState( () =>\r\n\t\tgetProps(\r\n\t\t\tcontentElement,\r\n\t\t\tselectedBlockElement,\r\n\t\t\tscrollContainer,\r\n\t\t\ttoolbarHeight,\r\n\t\t\tisSticky\r\n\t\t)\r\n\t);\r\n\r\n\tconst popoverRef = useRefEffect( ( popoverNode ) => {\r\n\t\tsetToolbarHeight( popoverNode.offsetHeight );\r\n\t}, [] );\r\n\r\n\tconst updateProps = useCallback(\r\n\t\t() =>\r\n\t\t\tsetProps(\r\n\t\t\t\tgetProps(\r\n\t\t\t\t\tcontentElement,\r\n\t\t\t\t\tselectedBlockElement,\r\n\t\t\t\t\tscrollContainer,\r\n\t\t\t\t\ttoolbarHeight,\r\n\t\t\t\t\tisSticky\r\n\t\t\t\t)\r\n\t\t\t),\r\n\t\t[ contentElement, selectedBlockElement, scrollContainer, toolbarHeight ]\r\n\t);\r\n\r\n\t// Update props when the block is moved. This also ensures the props are\r\n\t// correct on initial mount, and when the selected block or content element\r\n\t// changes (since the callback ref will update).\r\n\tuseLayoutEffect( updateProps, [ blockIndex, updateProps ] );\r\n\r\n\t// Update props when the viewport is resized or the block is resized.\r\n\tuseLayoutEffect( () => {\r\n\t\tif ( ! contentElement || ! selectedBlockElement ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Update the toolbar props on viewport resize.\r\n\t\tconst contentView = contentElement?.ownerDocument?.defaultView;\r\n\t\tcontentView?.addEventHandler?.( 'resize', updateProps );\r\n\r\n\t\t// Update the toolbar props on block resize.\r\n\t\tlet resizeObserver;\r\n\t\tconst blockView = selectedBlockElement?.ownerDocument?.defaultView;\r\n\t\tif ( blockView.ResizeObserver ) {\r\n\t\t\tresizeObserver = new blockView.ResizeObserver( updateProps );\r\n\t\t\tresizeObserver.observe( selectedBlockElement );\r\n\t\t}\r\n\r\n\t\treturn () => {\r\n\t\t\tcontentView?.removeEventHandler?.( 'resize', updateProps );\r\n\r\n\t\t\tif ( resizeObserver ) {\r\n\t\t\t\tresizeObserver.disconnect();\r\n\t\t\t}\r\n\t\t};\r\n\t}, [ updateProps, contentElement, selectedBlockElement ] );\r\n\r\n\treturn {\r\n\t\t...props,\r\n\t\tref: popoverRef,\r\n\t};\r\n}\r\n"],"mappings":"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","ignoreList":[]}