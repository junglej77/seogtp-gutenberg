{"version":3,"names":["fastDeepEqual","useRef","useLayoutEffect","useSelect","useDispatch","synchronizeBlocksWithTemplate","store","blockEditorStore","useInnerBlockTemplateSync","clientId","template","templateLock","templateInsertUpdatesSelection","getBlocks","getSelectedBlocksInitialCaretPosition","isBlockSelected","replaceInnerBlocks","__unstableMarkNextChangeAsNotPersistent","existingTemplateRef","isCancelled","window","queueMicrotask","currentInnerBlocks","shouldApplyTemplate","length","hasTemplateChanged","current","nextBlocks"],"sources":["@wordpress/block-editor/src/components/inner-blocks/use-inner-block-template-sync.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport fastDeepEqual from 'fast-deep-equal/es6';\r\n\r\n/**\r\n * WordPress dependencies\r\n */\r\nimport { useRef, useLayoutEffect } from '@wordpress/element';\r\nimport { useSelect, useDispatch } from '@wordpress/data';\r\nimport { synchronizeBlocksWithTemplate } from '@wordpress/blocks';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../store';\r\n\r\n/**\r\n * This hook makes sure that a block's inner blocks stay in sync with the given\r\n * block \"template\". The template is a block hierarchy to which inner blocks must\r\n * conform. If the blocks get \"out of sync\" with the template and the template\r\n * is meant to be locked (e.g. templateLock = \"all\" or templateLock = \"contentOnly\"),\r\n * then we replace the inner blocks with the correct value after synchronizing it with the template.\r\n *\r\n * @param {string}  clientId                       The block client ID.\r\n * @param {Object}  template                       The template to match.\r\n * @param {string}  templateLock                   The template lock state for the inner blocks. For\r\n *                                                 example, if the template lock is set to \"all\",\r\n *                                                 then the inner blocks will stay in sync with the\r\n *                                                 template. If not defined or set to false, then\r\n *                                                 the inner blocks will not be synchronized with\r\n *                                                 the given template.\r\n * @param {boolean} templateInsertUpdatesSelection Whether or not to update the\r\n *                                                 block-editor selection state when inner blocks\r\n *                                                 are replaced after template synchronization.\r\n */\r\nexport default function useInnerBlockTemplateSync(\r\n\tclientId,\r\n\ttemplate,\r\n\ttemplateLock,\r\n\ttemplateInsertUpdatesSelection\r\n) {\r\n\t// Instead of adding a useSelect mapping here, please add to the useSelect\r\n\t// mapping in InnerBlocks! Every subscription impacts performance.\r\n\r\n\tconst {\r\n\t\tgetBlocks,\r\n\t\tgetSelectedBlocksInitialCaretPosition,\r\n\t\tisBlockSelected,\r\n\t} = useSelect( blockEditorStore );\r\n\tconst { replaceInnerBlocks, __unstableMarkNextChangeAsNotPersistent } =\r\n\t\tuseDispatch( blockEditorStore );\r\n\r\n\t// Maintain a reference to the previous value so we can do a deep equality check.\r\n\tconst existingTemplateRef = useRef( null );\r\n\r\n\tuseLayoutEffect( () => {\r\n\t\tlet isCancelled = false;\r\n\r\n\t\t// There's an implicit dependency between useInnerBlockTemplateSync and useNestedSettingsUpdate\r\n\t\t// The former needs to happen after the latter and since the latter is using microtasks to batch updates (performance optimization),\r\n\t\t// we need to schedule this one in a microtask as well.\r\n\t\t// Example: If you remove queueMicrotask here, ctrl + click to insert quote block won't close the inserter.\r\n\t\twindow.queueMicrotask( () => {\r\n\t\t\tif ( isCancelled ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Only synchronize innerBlocks with template if innerBlocks are empty\r\n\t\t\t// or a locking \"all\" or \"contentOnly\" exists directly on the block.\r\n\t\t\tconst currentInnerBlocks = getBlocks( clientId );\r\n\t\t\tconst shouldApplyTemplate =\r\n\t\t\t\tcurrentInnerBlocks.length === 0 ||\r\n\t\t\t\ttemplateLock === 'all' ||\r\n\t\t\t\ttemplateLock === 'contentOnly';\r\n\r\n\t\t\tconst hasTemplateChanged = ! fastDeepEqual(\r\n\t\t\t\ttemplate,\r\n\t\t\t\texistingTemplateRef.current\r\n\t\t\t);\r\n\r\n\t\t\tif ( ! shouldApplyTemplate || ! hasTemplateChanged ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\texistingTemplateRef.current = template;\r\n\t\t\tconst nextBlocks = synchronizeBlocksWithTemplate(\r\n\t\t\t\tcurrentInnerBlocks,\r\n\t\t\t\ttemplate\r\n\t\t\t);\r\n\r\n\t\t\tif ( ! fastDeepEqual( nextBlocks, currentInnerBlocks ) ) {\r\n\t\t\t\t__unstableMarkNextChangeAsNotPersistent();\r\n\t\t\t\treplaceInnerBlocks(\r\n\t\t\t\t\tclientId,\r\n\t\t\t\t\tnextBlocks,\r\n\t\t\t\t\tcurrentInnerBlocks.length === 0 &&\r\n\t\t\t\t\t\ttemplateInsertUpdatesSelection &&\r\n\t\t\t\t\t\tnextBlocks.length !== 0 &&\r\n\t\t\t\t\t\tisBlockSelected( clientId ),\r\n\t\t\t\t\t// This ensures the \"initialPosition\" doesn't change when applying the template\r\n\t\t\t\t\t// If we're supposed to focus the block, we'll focus the first inner block\r\n\t\t\t\t\t// otherwise, we won't apply any auto-focus.\r\n\t\t\t\t\t// This ensures for instance that the focus stays in the inserter when inserting the \"buttons\" block.\r\n\t\t\t\t\tgetSelectedBlocksInitialCaretPosition()\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t} );\r\n\r\n\t\treturn () => {\r\n\t\t\tisCancelled = true;\r\n\t\t};\r\n\t}, [ template, templateLock, clientId ] );\r\n}\r\n"],"mappings":"AAAA;AACA;AACA;AACA,OAAOA,aAAa,MAAM,qBAAqB;;AAE/C;AACA;AACA;AACA,SAASC,MAAM,EAAEC,eAAe,QAAQ,oBAAoB;AAC5D,SAASC,SAAS,EAAEC,WAAW,QAAQ,iBAAiB;AACxD,SAASC,6BAA6B,QAAQ,mBAAmB;;AAEjE;AACA;AACA;AACA,SAASC,KAAK,IAAIC,gBAAgB,QAAQ,aAAa;;AAEvD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,SAASC,yBAAyBA,CAChDC,QAAQ,EACRC,QAAQ,EACRC,YAAY,EACZC,8BAA8B,EAC7B;EACD;EACA;;EAEA,MAAM;IACLC,SAAS;IACTC,qCAAqC;IACrCC;EACD,CAAC,GAAGZ,SAAS,CAAEI,gBAAiB,CAAC;EACjC,MAAM;IAAES,kBAAkB;IAAEC;EAAwC,CAAC,GACpEb,WAAW,CAAEG,gBAAiB,CAAC;;EAEhC;EACA,MAAMW,mBAAmB,GAAGjB,MAAM,CAAE,IAAK,CAAC;EAE1CC,eAAe,CAAE,MAAM;IACtB,IAAIiB,WAAW,GAAG,KAAK;;IAEvB;IACA;IACA;IACA;IACAC,MAAM,CAACC,cAAc,CAAE,MAAM;MAC5B,IAAKF,WAAW,EAAG;QAClB;MACD;;MAEA;MACA;MACA,MAAMG,kBAAkB,GAAGT,SAAS,CAAEJ,QAAS,CAAC;MAChD,MAAMc,mBAAmB,GACxBD,kBAAkB,CAACE,MAAM,KAAK,CAAC,IAC/Bb,YAAY,KAAK,KAAK,IACtBA,YAAY,KAAK,aAAa;MAE/B,MAAMc,kBAAkB,GAAG,CAAEzB,aAAa,CACzCU,QAAQ,EACRQ,mBAAmB,CAACQ,OACrB,CAAC;MAED,IAAK,CAAEH,mBAAmB,IAAI,CAAEE,kBAAkB,EAAG;QACpD;MACD;MAEAP,mBAAmB,CAACQ,OAAO,GAAGhB,QAAQ;MACtC,MAAMiB,UAAU,GAAGtB,6BAA6B,CAC/CiB,kBAAkB,EAClBZ,QACD,CAAC;MAED,IAAK,CAAEV,aAAa,CAAE2B,UAAU,EAAEL,kBAAmB,CAAC,EAAG;QACxDL,uCAAuC,CAAC,CAAC;QACzCD,kBAAkB,CACjBP,QAAQ,EACRkB,UAAU,EACVL,kBAAkB,CAACE,MAAM,KAAK,CAAC,IAC9BZ,8BAA8B,IAC9Be,UAAU,CAACH,MAAM,KAAK,CAAC,IACvBT,eAAe,CAAEN,QAAS,CAAC;QAC5B;QACA;QACA;QACA;QACAK,qCAAqC,CAAC,CACvC,CAAC;MACF;IACD,CAAE,CAAC;IAEH,OAAO,MAAM;MACZK,WAAW,GAAG,IAAI;IACnB,CAAC;EACF,CAAC,EAAE,CAAET,QAAQ,EAAEC,YAAY,EAAEF,QAAQ,CAAG,CAAC;AAC1C","ignoreList":[]}