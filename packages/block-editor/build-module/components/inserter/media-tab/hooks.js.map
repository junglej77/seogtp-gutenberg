{"version":3,"names":["useEffect","useState","useRef","useSelect","store","blockEditorStore","unlock","useMediaResults","category","query","mediaList","setMediaList","isLoading","setIsLoading","lastRequestRef","key","JSON","stringify","name","current","_media","fetch","Object","values","useMediaCategories","rootClientId","categories","setCategories","inserterMediaCategories","select","getInserterMediaCategories","canInsertImage","canInsertVideo","canInsertAudio","canInsertBlockType","_categories","categoriesHaveMedia","Map","Promise","all","map","isExternalResource","results","per_page","e","length","canInsertMediaType","image","video","audio","forEach","mediaType","get","push"],"sources":["@wordpress/block-editor/src/components/inserter/media-tab/hooks.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useEffect, useState, useRef } from '@wordpress/element';\r\nimport { useSelect } from '@wordpress/data';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../../store';\r\nimport { unlock } from '../../../lock-unlock';\r\n\r\n/** @typedef {import('../../../store/actions').InserterMediaRequest} InserterMediaRequest */\r\n/** @typedef {import('../../../store/actions').InserterMediaItem} InserterMediaItem */\r\n\r\n/**\r\n * Fetches media items based on the provided category.\r\n * Each media category is responsible for providing a `fetch` function.\r\n *\r\n * @param {Object}               category The media category to fetch results for.\r\n * @param {InserterMediaRequest} query    The query args to use for the request.\r\n * @return {InserterMediaItem[]} The media results.\r\n */\r\nexport function useMediaResults( category, query = {} ) {\r\n\tconst [ mediaList, setMediaList ] = useState();\r\n\tconst [ isLoading, setIsLoading ] = useState( false );\r\n\t// We need to keep track of the last request made because\r\n\t// multiple request can be fired without knowing the order\r\n\t// of resolution, and we need to ensure we are showing\r\n\t// the results of the last request.\r\n\t// In the future we could use AbortController to cancel previous\r\n\t// requests, but we don't for now as it involves adding support\r\n\t// for this to `core-data` package.\r\n\tconst lastRequestRef = useRef();\r\n\tuseEffect( () => {\r\n\t\t( async () => {\r\n\t\t\tconst key = JSON.stringify( {\r\n\t\t\t\tcategory: category.name,\r\n\t\t\t\t...query,\r\n\t\t\t} );\r\n\t\t\tlastRequestRef.current = key;\r\n\t\t\tsetIsLoading( true );\r\n\t\t\tsetMediaList( [] ); // Empty the previous results.\r\n\t\t\tconst _media = await category.fetch?.( query );\r\n\t\t\tif ( key === lastRequestRef.current ) {\r\n\t\t\t\tsetMediaList( _media );\r\n\t\t\t\tsetIsLoading( false );\r\n\t\t\t}\r\n\t\t} )();\r\n\t}, [ category.name, ...Object.values( query ) ] );\r\n\treturn { mediaList, isLoading };\r\n}\r\n\r\nexport function useMediaCategories( rootClientId ) {\r\n\tconst [ categories, setCategories ] = useState( [] );\r\n\r\n\tconst inserterMediaCategories = useSelect(\r\n\t\t( select ) =>\r\n\t\t\tunlock( select( blockEditorStore ) ).getInserterMediaCategories(),\r\n\t\t[]\r\n\t);\r\n\tconst { canInsertImage, canInsertVideo, canInsertAudio } = useSelect(\r\n\t\t( select ) => {\r\n\t\t\tconst { canInsertBlockType } = select( blockEditorStore );\r\n\t\t\treturn {\r\n\t\t\t\tcanInsertImage: canInsertBlockType(\r\n\t\t\t\t\t'core/image',\r\n\t\t\t\t\trootClientId\r\n\t\t\t\t),\r\n\t\t\t\tcanInsertVideo: canInsertBlockType(\r\n\t\t\t\t\t'core/video',\r\n\t\t\t\t\trootClientId\r\n\t\t\t\t),\r\n\t\t\t\tcanInsertAudio: canInsertBlockType(\r\n\t\t\t\t\t'core/audio',\r\n\t\t\t\t\trootClientId\r\n\t\t\t\t),\r\n\t\t\t};\r\n\t\t},\r\n\t\t[ rootClientId ]\r\n\t);\r\n\tuseEffect( () => {\r\n\t\t( async () => {\r\n\t\t\tconst _categories = [];\r\n\t\t\t// If `inserterMediaCategories` is not defined in\r\n\t\t\t// block editor settings, do not show any media categories.\r\n\t\t\tif ( ! inserterMediaCategories ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// Loop through categories to check if they have at least one media item.\r\n\t\t\tconst categoriesHaveMedia = new Map(\r\n\t\t\t\tawait Promise.all(\r\n\t\t\t\t\tinserterMediaCategories.map( async ( category ) => {\r\n\t\t\t\t\t\t// Some sources are external and we don't need to make a request.\r\n\t\t\t\t\t\tif ( category.isExternalResource ) {\r\n\t\t\t\t\t\t\treturn [ category.name, true ];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tlet results = [];\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tresults = await category.fetch( {\r\n\t\t\t\t\t\t\t\tper_page: 1,\r\n\t\t\t\t\t\t\t} );\r\n\t\t\t\t\t\t} catch ( e ) {\r\n\t\t\t\t\t\t\t// If the request fails, we shallow the error and just don't show\r\n\t\t\t\t\t\t\t// the category, in order to not break the media tab.\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn [ category.name, !! results.length ];\r\n\t\t\t\t\t} )\r\n\t\t\t\t)\r\n\t\t\t);\r\n\t\t\t// We need to filter out categories that don't have any media items or\r\n\t\t\t// whose corresponding block type is not allowed to be inserted, based\r\n\t\t\t// on the category's `mediaType`.\r\n\t\t\tconst canInsertMediaType = {\r\n\t\t\t\timage: canInsertImage,\r\n\t\t\t\tvideo: canInsertVideo,\r\n\t\t\t\taudio: canInsertAudio,\r\n\t\t\t};\r\n\t\t\tinserterMediaCategories.forEach( ( category ) => {\r\n\t\t\t\tif (\r\n\t\t\t\t\tcanInsertMediaType[ category.mediaType ] &&\r\n\t\t\t\t\tcategoriesHaveMedia.get( category.name )\r\n\t\t\t\t) {\r\n\t\t\t\t\t_categories.push( category );\r\n\t\t\t\t}\r\n\t\t\t} );\r\n\t\t\tif ( !! _categories.length ) {\r\n\t\t\t\tsetCategories( _categories );\r\n\t\t\t}\r\n\t\t} )();\r\n\t}, [\r\n\t\tcanInsertImage,\r\n\t\tcanInsertVideo,\r\n\t\tcanInsertAudio,\r\n\t\tinserterMediaCategories,\r\n\t] );\r\n\treturn categories;\r\n}\r\n"],"mappings":"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","ignoreList":[]}