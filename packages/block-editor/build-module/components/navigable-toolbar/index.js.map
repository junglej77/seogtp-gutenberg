{"version":3,"names":["NavigableMenu","Toolbar","useState","useRef","useLayoutEffect","useEffect","useCallback","useSelect","deprecated","focus","useShortcut","ESCAPE","store","blockEditorStore","unlock","jsx","_jsx","hasOnlyToolbarItem","elements","dataProp","some","element","dataset","getAllFocusableToolbarItemsIn","container","Array","from","querySelectorAll","hasFocusWithin","contains","ownerDocument","activeElement","focusFirstTabbableIn","firstTabbable","tabbable","find","preventScroll","useIsAccessibleToolbar","toolbarRef","initialAccessibleToolbarState","isAccessibleToolbar","setIsAccessibleToolbar","determineIsAccessibleToolbar","tabbables","current","onlyToolbarItem","since","alternative","link","observer","window","MutationObserver","observe","childList","subtree","disconnect","useToolbarFocus","focusOnMount","defaultIndex","onIndexChange","shouldUseKeyboardFocusShortcut","focusEditorOnEscape","initialFocusOnMount","initialIndex","focusToolbar","focusToolbarViaShortcut","navigableToolbarRef","raf","requestAnimationFrame","items","index","cancelAnimationFrame","findIndex","item","tabIndex","getLastFocus","handleKeyDown","event","lastFocus","keyCode","preventDefault","addEventListener","removeEventListener","NavigableToolbar","children","__experimentalInitialIndex","__experimentalOnIndexChange","orientation","props","label","ref","role"],"sources":["@wordpress/block-editor/src/components/navigable-toolbar/index.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { NavigableMenu, Toolbar } from '@wordpress/components';\r\nimport {\r\n\tuseState,\r\n\tuseRef,\r\n\tuseLayoutEffect,\r\n\tuseEffect,\r\n\tuseCallback,\r\n} from '@wordpress/element';\r\nimport { useSelect } from '@wordpress/data';\r\nimport deprecated from '@wordpress/deprecated';\r\nimport { focus } from '@wordpress/dom';\r\nimport { useShortcut } from '@wordpress/keyboard-shortcuts';\r\nimport { ESCAPE } from '@wordpress/keycodes';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../store';\r\nimport { unlock } from '../../lock-unlock';\r\n\r\nfunction hasOnlyToolbarItem( elements ) {\r\n\tconst dataProp = 'toolbarItem';\r\n\treturn ! elements.some( ( element ) => ! ( dataProp in element.dataset ) );\r\n}\r\n\r\nfunction getAllFocusableToolbarItemsIn( container ) {\r\n\treturn Array.from(\r\n\t\tcontainer.querySelectorAll( '[data-toolbar-item]:not([disabled])' )\r\n\t);\r\n}\r\n\r\nfunction hasFocusWithin( container ) {\r\n\treturn container.contains( container.ownerDocument.activeElement );\r\n}\r\n\r\nfunction focusFirstTabbableIn( container ) {\r\n\tconst [ firstTabbable ] = focus.tabbable.find( container );\r\n\r\n\tif ( firstTabbable ) {\r\n\t\tfirstTabbable.focus( {\r\n\t\t\t// When focusing newly mounted toolbars,\r\n\t\t\t// the position of the popover is often not right on the first render\r\n\t\t\t// This prevents the layout shifts when focusing the dialogs.\r\n\t\t\tpreventScroll: true,\r\n\t\t} );\r\n\t}\r\n}\r\n\r\nfunction useIsAccessibleToolbar( toolbarRef ) {\r\n\t/*\r\n\t * By default, we'll assume the starting accessible state of the Toolbar\r\n\t * is true, as it seems to be the most common case.\r\n\t *\r\n\t * Transitioning from an (initial) false to true state causes the\r\n\t * <Toolbar /> component to mount twice, which is causing undesired\r\n\t * side-effects. These side-effects appear to only affect certain\r\n\t * E2E tests.\r\n\t *\r\n\t * This was initial discovered in this pull-request:\r\n\t * https://github.com/WordPress/gutenberg/pull/23425\r\n\t */\r\n\tconst initialAccessibleToolbarState = true;\r\n\r\n\t// By default, it's gonna render NavigableMenu. If all the tabbable elements\r\n\t// inside the toolbar are ToolbarItem components (or derived components like\r\n\t// ToolbarButton), then we can wrap them with the accessible Toolbar\r\n\t// component.\r\n\tconst [ isAccessibleToolbar, setIsAccessibleToolbar ] = useState(\r\n\t\tinitialAccessibleToolbarState\r\n\t);\r\n\r\n\tconst determineIsAccessibleToolbar = useCallback( () => {\r\n\t\tconst tabbables = focus.tabbable.find( toolbarRef.current );\r\n\t\tconst onlyToolbarItem = hasOnlyToolbarItem( tabbables );\r\n\t\tif ( ! onlyToolbarItem ) {\r\n\t\t\tdeprecated( 'Using custom components as toolbar controls', {\r\n\t\t\t\tsince: '5.6',\r\n\t\t\t\talternative:\r\n\t\t\t\t\t'ToolbarItem, ToolbarButton or ToolbarDropdownMenu components',\r\n\t\t\t\tlink: 'https://developer.wordpress.org/block-editor/components/toolbar-button/#inside-blockcontrols',\r\n\t\t\t} );\r\n\t\t}\r\n\t\tsetIsAccessibleToolbar( onlyToolbarItem );\r\n\t}, [ toolbarRef ] );\r\n\r\n\tuseLayoutEffect( () => {\r\n\t\t// Toolbar buttons may be rendered asynchronously, so we use\r\n\t\t// MutationObserver to check if the toolbar subtree has been modified.\r\n\t\tconst observer = new window.MutationObserver(\r\n\t\t\tdetermineIsAccessibleToolbar\r\n\t\t);\r\n\t\tobserver.observe( toolbarRef.current, {\r\n\t\t\tchildList: true,\r\n\t\t\tsubtree: true,\r\n\t\t} );\r\n\t\treturn () => observer.disconnect();\r\n\t}, [ determineIsAccessibleToolbar, isAccessibleToolbar, toolbarRef ] );\r\n\r\n\treturn isAccessibleToolbar;\r\n}\r\n\r\nfunction useToolbarFocus( {\r\n\ttoolbarRef,\r\n\tfocusOnMount,\r\n\tisAccessibleToolbar,\r\n\tdefaultIndex,\r\n\tonIndexChange,\r\n\tshouldUseKeyboardFocusShortcut,\r\n\tfocusEditorOnEscape,\r\n} ) {\r\n\t// Make sure we don't use modified versions of this prop.\r\n\tconst [ initialFocusOnMount ] = useState( focusOnMount );\r\n\tconst [ initialIndex ] = useState( defaultIndex );\r\n\r\n\tconst focusToolbar = useCallback( () => {\r\n\t\tfocusFirstTabbableIn( toolbarRef.current );\r\n\t}, [ toolbarRef ] );\r\n\r\n\tconst focusToolbarViaShortcut = () => {\r\n\t\tif ( shouldUseKeyboardFocusShortcut ) {\r\n\t\t\tfocusToolbar();\r\n\t\t}\r\n\t};\r\n\r\n\t// Focus on toolbar when pressing alt+F10 when the toolbar is visible.\r\n\tuseShortcut( 'core/block-editor/focus-toolbar', focusToolbarViaShortcut );\r\n\r\n\tuseEffect( () => {\r\n\t\tif ( initialFocusOnMount ) {\r\n\t\t\tfocusToolbar();\r\n\t\t}\r\n\t}, [ isAccessibleToolbar, initialFocusOnMount, focusToolbar ] );\r\n\r\n\tuseEffect( () => {\r\n\t\t// Store ref so we have access on useEffect cleanup: https://legacy.reactjs.org/blog/2020/08/10/react-v17-rc.html#effect-cleanup-timing\r\n\t\tconst navigableToolbarRef = toolbarRef.current;\r\n\t\t// If initialIndex is passed, we focus on that toolbar item when the\r\n\t\t// toolbar gets mounted and initial focus is not forced.\r\n\t\t// We have to wait for the next browser paint because block controls aren't\r\n\t\t// rendered right away when the toolbar gets mounted.\r\n\t\tlet raf = 0;\r\n\r\n\t\t// If the toolbar already had focus before the render, we don't want to move it.\r\n\t\t// https://github.com/WordPress/gutenberg/issues/58511\r\n\t\tif (\r\n\t\t\t! initialFocusOnMount &&\r\n\t\t\t! hasFocusWithin( navigableToolbarRef )\r\n\t\t) {\r\n\t\t\traf = window.requestAnimationFrame( () => {\r\n\t\t\t\tconst items =\r\n\t\t\t\t\tgetAllFocusableToolbarItemsIn( navigableToolbarRef );\r\n\t\t\t\tconst index = initialIndex || 0;\r\n\t\t\t\tif ( items[ index ] && hasFocusWithin( navigableToolbarRef ) ) {\r\n\t\t\t\t\titems[ index ].focus( {\r\n\t\t\t\t\t\t// When focusing newly mounted toolbars,\r\n\t\t\t\t\t\t// the position of the popover is often not right on the first render\r\n\t\t\t\t\t\t// This prevents the layout shifts when focusing the dialogs.\r\n\t\t\t\t\t\tpreventScroll: true,\r\n\t\t\t\t\t} );\r\n\t\t\t\t}\r\n\t\t\t} );\r\n\t\t}\r\n\t\treturn () => {\r\n\t\t\twindow.cancelAnimationFrame( raf );\r\n\t\t\tif ( ! onIndexChange || ! navigableToolbarRef ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// When the toolbar element is unmounted and onIndexChange is passed, we\r\n\t\t\t// pass the focused toolbar item index so it can be hydrated later.\r\n\t\t\tconst items = getAllFocusableToolbarItemsIn( navigableToolbarRef );\r\n\t\t\tconst index = items.findIndex( ( item ) => item.tabIndex === 0 );\r\n\t\t\tonIndexChange( index );\r\n\t\t};\r\n\t}, [ initialIndex, initialFocusOnMount, onIndexChange, toolbarRef ] );\r\n\r\n\tconst { getLastFocus } = unlock( useSelect( blockEditorStore ) );\r\n\t/**\r\n\t * Handles returning focus to the block editor canvas when pressing escape.\r\n\t */\r\n\tuseEffect( () => {\r\n\t\tconst navigableToolbarRef = toolbarRef.current;\r\n\r\n\t\tif ( focusEditorOnEscape ) {\r\n\t\t\tconst handleKeyDown = ( event ) => {\r\n\t\t\t\tconst lastFocus = getLastFocus();\r\n\t\t\t\tif ( event.keyCode === ESCAPE && lastFocus?.current ) {\r\n\t\t\t\t\t// Focus the last focused element when pressing escape.\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tlastFocus.current.focus();\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tnavigableToolbarRef.addEventListener( 'keydown', handleKeyDown );\r\n\t\t\treturn () => {\r\n\t\t\t\tnavigableToolbarRef.removeEventListener(\r\n\t\t\t\t\t'keydown',\r\n\t\t\t\t\thandleKeyDown\r\n\t\t\t\t);\r\n\t\t\t};\r\n\t\t}\r\n\t}, [ focusEditorOnEscape, getLastFocus, toolbarRef ] );\r\n}\r\n\r\nexport default function NavigableToolbar( {\r\n\tchildren,\r\n\tfocusOnMount,\r\n\tfocusEditorOnEscape = false,\r\n\tshouldUseKeyboardFocusShortcut = true,\r\n\t__experimentalInitialIndex: initialIndex,\r\n\t__experimentalOnIndexChange: onIndexChange,\r\n\torientation = 'horizontal',\r\n\t...props\r\n} ) {\r\n\tconst toolbarRef = useRef();\r\n\tconst isAccessibleToolbar = useIsAccessibleToolbar( toolbarRef );\r\n\r\n\tuseToolbarFocus( {\r\n\t\ttoolbarRef,\r\n\t\tfocusOnMount,\r\n\t\tdefaultIndex: initialIndex,\r\n\t\tonIndexChange,\r\n\t\tisAccessibleToolbar,\r\n\t\tshouldUseKeyboardFocusShortcut,\r\n\t\tfocusEditorOnEscape,\r\n\t} );\r\n\r\n\tif ( isAccessibleToolbar ) {\r\n\t\treturn (\r\n\t\t\t<Toolbar\r\n\t\t\t\tlabel={ props[ 'aria-label' ] }\r\n\t\t\t\tref={ toolbarRef }\r\n\t\t\t\torientation={ orientation }\r\n\t\t\t\t{ ...props }\r\n\t\t\t>\r\n\t\t\t\t{ children }\r\n\t\t\t</Toolbar>\r\n\t\t);\r\n\t}\r\n\r\n\treturn (\r\n\t\t<NavigableMenu\r\n\t\t\torientation={ orientation }\r\n\t\t\trole=\"toolbar\"\r\n\t\t\tref={ toolbarRef }\r\n\t\t\t{ ...props }\r\n\t\t>\r\n\t\t\t{ children }\r\n\t\t</NavigableMenu>\r\n\t);\r\n}\r\n"],"mappings":"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","ignoreList":[]}