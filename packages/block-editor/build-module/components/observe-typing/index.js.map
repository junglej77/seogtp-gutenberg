{"version":3,"names":["useRefEffect","useMergeRefs","useSelect","useDispatch","isTextField","UP","RIGHT","DOWN","LEFT","ENTER","BACKSPACE","ESCAPE","TAB","store","blockEditorStore","jsx","_jsx","KEY_DOWN_ELIGIBLE_KEY_CODES","Set","isKeyDownEligibleForStartTyping","event","keyCode","shiftKey","has","useMouseMoveTypingReset","isTyping","select","stopTyping","node","ownerDocument","lastClientX","lastClientY","stopTypingOnMouseMove","clientX","clientY","addEventListener","removeEventListener","useTypingObserver","_isTyping","startTyping","ref1","ref2","defaultView","selection","getSelection","timerId","stopTypingOnNonTextField","target","setTimeout","stopTypingOnEscapeKey","stopTypingOnSelectionUncollapse","isCollapsed","clearTimeout","startTypingInTextField","type","contains","ObserveTyping","children","ref"],"sources":["@wordpress/block-editor/src/components/observe-typing/index.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useRefEffect, useMergeRefs } from '@wordpress/compose';\r\nimport { useSelect, useDispatch } from '@wordpress/data';\r\nimport { isTextField } from '@wordpress/dom';\r\nimport {\r\n\tUP,\r\n\tRIGHT,\r\n\tDOWN,\r\n\tLEFT,\r\n\tENTER,\r\n\tBACKSPACE,\r\n\tESCAPE,\r\n\tTAB,\r\n} from '@wordpress/keycodes';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../store';\r\n\r\n/**\r\n * Set of key codes upon which typing is to be initiated on a keydown event.\r\n *\r\n * @type {Set<number>}\r\n */\r\nconst KEY_DOWN_ELIGIBLE_KEY_CODES = new Set( [\r\n\tUP,\r\n\tRIGHT,\r\n\tDOWN,\r\n\tLEFT,\r\n\tENTER,\r\n\tBACKSPACE,\r\n] );\r\n\r\n/**\r\n * Returns true if a given keydown event can be inferred as intent to start\r\n * typing, or false otherwise. A keydown is considered eligible if it is a\r\n * text navigation without shift active.\r\n *\r\n * @param {KeyboardEvent} event Keydown event to test.\r\n *\r\n * @return {boolean} Whether event is eligible to start typing.\r\n */\r\nfunction isKeyDownEligibleForStartTyping( event ) {\r\n\tconst { keyCode, shiftKey } = event;\r\n\treturn ! shiftKey && KEY_DOWN_ELIGIBLE_KEY_CODES.has( keyCode );\r\n}\r\n\r\n/**\r\n * Removes the `isTyping` flag when the mouse moves in the document of the given\r\n * element.\r\n */\r\nexport function useMouseMoveTypingReset() {\r\n\tconst isTyping = useSelect(\r\n\t\t( select ) => select( blockEditorStore ).isTyping(),\r\n\t\t[]\r\n\t);\r\n\tconst { stopTyping } = useDispatch( blockEditorStore );\r\n\r\n\treturn useRefEffect(\r\n\t\t( node ) => {\r\n\t\t\tif ( ! isTyping ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst { ownerDocument } = node;\r\n\t\t\tlet lastClientX;\r\n\t\t\tlet lastClientY;\r\n\r\n\t\t\t/**\r\n\t\t\t * On mouse move, unset typing flag if user has moved cursor.\r\n\t\t\t *\r\n\t\t\t * @param {MouseEvent} event Mousemove event.\r\n\t\t\t */\r\n\t\t\tfunction stopTypingOnMouseMove( event ) {\r\n\t\t\t\tconst { clientX, clientY } = event;\r\n\r\n\t\t\t\t// We need to check that the mouse really moved because Safari\r\n\t\t\t\t// triggers mousemove events when shift or ctrl are pressed.\r\n\t\t\t\tif (\r\n\t\t\t\t\tlastClientX &&\r\n\t\t\t\t\tlastClientY &&\r\n\t\t\t\t\t( lastClientX !== clientX || lastClientY !== clientY )\r\n\t\t\t\t) {\r\n\t\t\t\t\tstopTyping();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlastClientX = clientX;\r\n\t\t\t\tlastClientY = clientY;\r\n\t\t\t}\r\n\r\n\t\t\townerDocument.addEventListener(\r\n\t\t\t\t'mousemove',\r\n\t\t\t\tstopTypingOnMouseMove\r\n\t\t\t);\r\n\r\n\t\t\treturn () => {\r\n\t\t\t\townerDocument.removeEventListener(\r\n\t\t\t\t\t'mousemove',\r\n\t\t\t\t\tstopTypingOnMouseMove\r\n\t\t\t\t);\r\n\t\t\t};\r\n\t\t},\r\n\t\t[ isTyping, stopTyping ]\r\n\t);\r\n}\r\n\r\n/**\r\n * Sets and removes the `isTyping` flag based on user actions:\r\n *\r\n * - Sets the flag if the user types within the given element.\r\n * - Removes the flag when the user selects some text, focusses a non-text\r\n *   field, presses ESC or TAB, or moves the mouse in the document.\r\n */\r\nexport function useTypingObserver() {\r\n\tconst { isTyping } = useSelect( ( select ) => {\r\n\t\tconst { isTyping: _isTyping } = select( blockEditorStore );\r\n\t\treturn {\r\n\t\t\tisTyping: _isTyping(),\r\n\t\t};\r\n\t}, [] );\r\n\tconst { startTyping, stopTyping } = useDispatch( blockEditorStore );\r\n\r\n\tconst ref1 = useMouseMoveTypingReset();\r\n\tconst ref2 = useRefEffect(\r\n\t\t( node ) => {\r\n\t\t\tconst { ownerDocument } = node;\r\n\t\t\tconst { defaultView } = ownerDocument;\r\n\t\t\tconst selection = defaultView.getSelection();\r\n\r\n\t\t\t// Listeners to stop typing should only be added when typing.\r\n\t\t\t// Listeners to start typing should only be added when not typing.\r\n\t\t\tif ( isTyping ) {\r\n\t\t\t\tlet timerId;\r\n\r\n\t\t\t\t/**\r\n\t\t\t\t * Stops typing when focus transitions to a non-text field element.\r\n\t\t\t\t *\r\n\t\t\t\t * @param {FocusEvent} event Focus event.\r\n\t\t\t\t */\r\n\t\t\t\tfunction stopTypingOnNonTextField( event ) {\r\n\t\t\t\t\tconst { target } = event;\r\n\r\n\t\t\t\t\t// Since focus to a non-text field via arrow key will trigger\r\n\t\t\t\t\t// before the keydown event, wait until after current stack\r\n\t\t\t\t\t// before evaluating whether typing is to be stopped. Otherwise,\r\n\t\t\t\t\t// typing will re-start.\r\n\t\t\t\t\ttimerId = defaultView.setTimeout( () => {\r\n\t\t\t\t\t\tif ( ! isTextField( target ) ) {\r\n\t\t\t\t\t\t\tstopTyping();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} );\r\n\t\t\t\t}\r\n\r\n\t\t\t\t/**\r\n\t\t\t\t * Unsets typing flag if user presses Escape while typing flag is\r\n\t\t\t\t * active.\r\n\t\t\t\t *\r\n\t\t\t\t * @param {KeyboardEvent} event Keypress or keydown event to\r\n\t\t\t\t *                              interpret.\r\n\t\t\t\t */\r\n\t\t\t\tfunction stopTypingOnEscapeKey( event ) {\r\n\t\t\t\t\tconst { keyCode } = event;\r\n\r\n\t\t\t\t\tif ( keyCode === ESCAPE || keyCode === TAB ) {\r\n\t\t\t\t\t\tstopTyping();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t/**\r\n\t\t\t\t * On selection change, unset typing flag if user has made an\r\n\t\t\t\t * uncollapsed (shift) selection.\r\n\t\t\t\t */\r\n\t\t\t\tfunction stopTypingOnSelectionUncollapse() {\r\n\t\t\t\t\tif ( ! selection.isCollapsed ) {\r\n\t\t\t\t\t\tstopTyping();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnode.addEventListener( 'focus', stopTypingOnNonTextField );\r\n\t\t\t\tnode.addEventListener( 'keydown', stopTypingOnEscapeKey );\r\n\r\n\t\t\t\townerDocument.addEventListener(\r\n\t\t\t\t\t'selectionchange',\r\n\t\t\t\t\tstopTypingOnSelectionUncollapse\r\n\t\t\t\t);\r\n\r\n\t\t\t\treturn () => {\r\n\t\t\t\t\tdefaultView.clearTimeout( timerId );\r\n\t\t\t\t\tnode.removeEventListener(\r\n\t\t\t\t\t\t'focus',\r\n\t\t\t\t\t\tstopTypingOnNonTextField\r\n\t\t\t\t\t);\r\n\t\t\t\t\tnode.removeEventListener(\r\n\t\t\t\t\t\t'keydown',\r\n\t\t\t\t\t\tstopTypingOnEscapeKey\r\n\t\t\t\t\t);\r\n\t\t\t\t\townerDocument.removeEventListener(\r\n\t\t\t\t\t\t'selectionchange',\r\n\t\t\t\t\t\tstopTypingOnSelectionUncollapse\r\n\t\t\t\t\t);\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\t/**\r\n\t\t\t * Handles a keypress or keydown event to infer intention to start\r\n\t\t\t * typing.\r\n\t\t\t *\r\n\t\t\t * @param {KeyboardEvent} event Keypress or keydown event to interpret.\r\n\t\t\t */\r\n\t\t\tfunction startTypingInTextField( event ) {\r\n\t\t\t\tconst { type, target } = event;\r\n\r\n\t\t\t\t// Abort early if already typing, or key press is incurred outside a\r\n\t\t\t\t// text field (e.g. arrow-ing through toolbar buttons).\r\n\t\t\t\t// Ignore typing if outside the current DOM container\r\n\t\t\t\tif ( ! isTextField( target ) || ! node.contains( target ) ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Special-case keydown because certain keys do not emit a keypress\r\n\t\t\t\t// event. Conversely avoid keydown as the canonical event since\r\n\t\t\t\t// there are many keydown which are explicitly not targeted for\r\n\t\t\t\t// typing.\r\n\t\t\t\tif (\r\n\t\t\t\t\ttype === 'keydown' &&\r\n\t\t\t\t\t! isKeyDownEligibleForStartTyping( event )\r\n\t\t\t\t) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tstartTyping();\r\n\t\t\t}\r\n\r\n\t\t\tnode.addEventListener( 'keypress', startTypingInTextField );\r\n\t\t\tnode.addEventListener( 'keydown', startTypingInTextField );\r\n\r\n\t\t\treturn () => {\r\n\t\t\t\tnode.removeEventListener( 'keypress', startTypingInTextField );\r\n\t\t\t\tnode.removeEventListener( 'keydown', startTypingInTextField );\r\n\t\t\t};\r\n\t\t},\r\n\t\t[ isTyping, startTyping, stopTyping ]\r\n\t);\r\n\r\n\treturn useMergeRefs( [ ref1, ref2 ] );\r\n}\r\n\r\nfunction ObserveTyping( { children } ) {\r\n\treturn <div ref={ useTypingObserver() }>{ children }</div>;\r\n}\r\n\r\n/**\r\n * @see https://github.com/WordPress/gutenberg/blob/HEAD/packages/block-editor/src/components/observe-typing/README.md\r\n */\r\nexport default ObserveTyping;\r\n"],"mappings":"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","ignoreList":[]}