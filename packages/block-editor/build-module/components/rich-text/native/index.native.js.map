{"version":3,"names":["View","Platform","Dimensions","memize","colord","RCTAztecView","showUserSuggestions","showXpostSuggestions","BlockFormatControls","getPxFromCssUnit","Component","compose","debounce","withPreferredColorScheme","withSelect","childrenBlock","decodeEntities","BACKSPACE","DELETE","ENTER","isURL","atSymbol","plus","__","applyFormat","getActiveFormat","getActiveFormats","insert","getTextContent","isEmpty","create","toHTMLString","isCollapsed","remove","useFormatTypes","FormatEdit","getFormatColors","styles","ToolbarButtonWithOptions","Fragment","_Fragment","jsx","_jsx","jsxs","_jsxs","flatColorPalettes","colorsPalettes","theme","custom","default","getSelectionColor","currentSelectionColor","defaultSelectionColor","baseGlobalStyles","isBlockBasedTheme","selectionColor","colordTextColor","colordBackgroundColor","color","background","isColordTextReadable","isReadable","text","gutenbergFormatNamesToAztec","EMPTY_PARAGRAPH_TAGS","DEFAULT_FONT_SIZE","MIN_LINE_HEIGHT","RichText","constructor","value","selectionStart","selectionEnd","arguments","isIOS","OS","createRecord","bind","onChangeFromAztec","onKeyDown","handleEnter","handleDelete","onPaste","onFocus","onBlur","onTextUpdate","onContentSizeChange","onFormatChange","formatToValue","maxSize","debounceCreateUndoLevel","onCreateUndoLevel","onSelectionChange","onSelectionChangeFromAztec","valueToFormat","getHtmlToRender","handleSuggestionFunc","handleUserSuggestion","handleXpostSuggestion","suggestionOptions","insertString","manipulateEventCounterToForceNativeToRefresh","shouldDropEventFromAztec","state","activeFormats","selectedFormat","height","currentFontSize","getFontSize","needsSelectionUpdate","savedContent","isTouched","lastAztecEventType","lastHistoryValue","getRecord","start","end","colorPalette","props","currentValue","formats","replacements","newFormats","preserveWhiteSpace","html","range","Math","min","length","removeRootTagsProducedByAztec","getActiveFormatNames","record","formatTypes","map","name","filter","undefined","Boolean","changeHandlers","Object","fromEntries","entries","key","startsWith","values","forEach","changeHandler","onChange","setState","string","toInsert","__unstableOnCreateUndoLevel","toString","result","removeRootTag","tagName","tagsToEliminate","element","removeTag","tag","openingTagRegexp","RegExp","closingTagRegexp","replace","event","contentWithoutRootTag","nativeEvent","__unstableInputRule","currentValuePosition","lastEventCount","eventCount","comesFromAztec","firedAfterTextChanged","refresh","contentSize","defaultPrevented","customEditableOnKeyDown","preventDefault","KeyCodes","keyCode","handleTriggerKeyCodes","onEnter","shiftKey","isReverse","onDelete","hasActiveFormats","newValue","triggeredOption","find","option","triggeredKeyCode","triggerChar","charCodeAt","useTrigger","charAt","onClick","areMentionsSupported","areXPostsSupported","allOptions","supported","title","label","icon","op","suggestionFunction","prefix","then","suggestion","catch","pastedText","pastedHtml","files","currentRecord","trimmedText","trim","linkedRecord","type","attributes","href","window","console","log","plainText","unstableOnFocus","hasChanged","isManual","logText","shouldDrop","shouldFocusTextInputAfterMerge","prevProps","__unstableIsSelected","isSelected","blockIsSelected","__unstableMobileNoFocusOnMount","prevIsSelected","prevBlockIsSelected","noSelectionValues","textInputWasNotFocused","realStart","realEnd","max","Array","isArray","toHTML","format","shouldComponentUpdate","nextProps","nextState","reversed","fontSize","style","lineHeight","componentDidMount","_editor","focus","componentDidUpdate","_this$value$toString$","lastCharacterPosition","blur","currentFontSizeStyle","getParsedFontSize","prevFontSizeStyle","isDifferentTag","componentWillUnmount","clearCurrentSelectionOnUnmount","isFocused","extraAttributes","getEditableProps","className","_getPxFromCssUnit","width","get","cssUnitOptions","selectedPxValue","parseFloat","tagNameFontSize","elements","typography","newFontSize","getLineHeight","tagNameLineHeight","newLineHeight","getIsBlockBasedTheme","isNaN","getBlockUseDefaultFont","tagsToMatch","test","getLinkTextColor","defaultColor","customColor","linkColor","isValid","toHex","getPlaceholderTextColor","_ref","_ref2","getStylesFromColorScheme","placeholderTextColor","placeholderStyle","richTextPlaceholder","richTextPlaceholderDark","defaultPlaceholderTextColor","placeholderOpacity","inheritPlaceholderColor","placeholderColor","globalStylesPlaceholderColor","render","children","minWidth","maxWidth","parentBlockStyles","accessibilityLabel","disableEditingMenu","disableSuggestions","containerWidth","editableProps","blockUseDefaultFont","textDecorationColor","defaultTextDecorationColor","fontFamily","defaultFontFamily","richText","richTextDark","linkTextColor","currentSelectionStart","currentSelectionEnd","selection","brBeforeParaMatches","match","warn","count","newSelectionStart","newSelectionEnd","containerStyles","padding","backgroundColor","EditableView","editableTagName","ref","nativeEditorRef","minHeight","placeholder","deleteEnter","triggerKeyCodes","blockType","maxImagesWidth","fontWeight","fontStyle","isMultiline","textAlign","id","disableAutocorrection","forwardedRef","options","defaultProps","withFormatTypes","WrappedComponent","clientId","identifier","withoutInteractiveFormatting","allowedFormats","select","getBlockParents","getBlock","getSettings","parents","parentBlock","childrenStyles","settings","__experimentalGlobalStylesBaseStyles","colorPalettes","__experimentalFeatures","palette","colors","capabilities","mentions","xposts"],"sources":["@wordpress/block-editor/src/components/rich-text/native/index.native.js"],"sourcesContent":["/* eslint no-console: [\"error\", { allow: [\"warn\"] }] */\r\n\r\n/**\r\n * External dependencies\r\n */\r\nimport { View, Platform, Dimensions } from 'react-native';\r\nimport memize from 'memize';\r\nimport { colord } from 'colord';\r\n\r\n/**\r\n * WordPress dependencies\r\n */\r\nimport RCTAztecView from '@wordpress/react-native-aztec';\r\nimport {\r\n\tshowUserSuggestions,\r\n\tshowXpostSuggestions,\r\n} from '@wordpress/react-native-bridge';\r\nimport { BlockFormatControls } from '@wordpress/block-editor';\r\nimport { getPxFromCssUnit } from '@wordpress/components';\r\nimport { Component } from '@wordpress/element';\r\nimport {\r\n\tcompose,\r\n\tdebounce,\r\n\twithPreferredColorScheme,\r\n} from '@wordpress/compose';\r\nimport { withSelect } from '@wordpress/data';\r\nimport { childrenBlock } from '@wordpress/blocks';\r\nimport { decodeEntities } from '@wordpress/html-entities';\r\nimport { BACKSPACE, DELETE, ENTER } from '@wordpress/keycodes';\r\nimport { isURL } from '@wordpress/url';\r\nimport { atSymbol, plus } from '@wordpress/icons';\r\nimport { __ } from '@wordpress/i18n';\r\nimport {\r\n\tapplyFormat,\r\n\tgetActiveFormat,\r\n\tgetActiveFormats,\r\n\tinsert,\r\n\tgetTextContent,\r\n\tisEmpty,\r\n\tcreate,\r\n\ttoHTMLString,\r\n\tisCollapsed,\r\n\tremove,\r\n} from '@wordpress/rich-text';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { useFormatTypes } from './use-format-types';\r\nimport FormatEdit from './format-edit';\r\nimport { getFormatColors } from './get-format-colors';\r\nimport styles from './style.scss';\r\nimport ToolbarButtonWithOptions from './toolbar-button-with-options';\r\n\r\n// The flattened color palettes array is memoized to ensure that the same array instance is\r\n// returned for the colors palettes. This value might be used as a prop, so having the same\r\n// instance will prevent unnecessary re-renders of the RichText component.\r\nconst flatColorPalettes = memize( ( colorsPalettes ) => [\r\n\t...( colorsPalettes?.theme || [] ),\r\n\t...( colorsPalettes?.custom || [] ),\r\n\t...( colorsPalettes?.default || [] ),\r\n] );\r\n\r\nconst getSelectionColor = memize(\r\n\t(\r\n\t\tcurrentSelectionColor,\r\n\t\tdefaultSelectionColor,\r\n\t\tbaseGlobalStyles,\r\n\t\tisBlockBasedTheme\r\n\t) => {\r\n\t\tlet selectionColor = defaultSelectionColor;\r\n\t\tif ( currentSelectionColor ) {\r\n\t\t\tselectionColor = currentSelectionColor;\r\n\t\t}\r\n\r\n\t\tif ( isBlockBasedTheme ) {\r\n\t\t\tconst colordTextColor = colord( selectionColor );\r\n\t\t\tconst colordBackgroundColor = colord(\r\n\t\t\t\tbaseGlobalStyles?.color?.background\r\n\t\t\t);\r\n\t\t\tconst isColordTextReadable = colordTextColor.isReadable(\r\n\t\t\t\tcolordBackgroundColor\r\n\t\t\t);\r\n\t\t\tif ( ! isColordTextReadable ) {\r\n\t\t\t\tselectionColor = baseGlobalStyles?.color?.text;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn selectionColor;\r\n\t}\r\n);\r\n\r\nconst gutenbergFormatNamesToAztec = {\r\n\t'core/bold': 'bold',\r\n\t'core/italic': 'italic',\r\n\t'core/strikethrough': 'strikethrough',\r\n\t'core/text-color': 'mark',\r\n};\r\n\r\nconst EMPTY_PARAGRAPH_TAGS = '<p></p>';\r\nconst DEFAULT_FONT_SIZE = 16;\r\nconst MIN_LINE_HEIGHT = 1;\r\n\r\nexport class RichText extends Component {\r\n\tconstructor( { value, selectionStart, selectionEnd } ) {\r\n\t\tsuper( ...arguments );\r\n\r\n\t\tthis.isIOS = Platform.OS === 'ios';\r\n\t\tthis.createRecord = this.createRecord.bind( this );\r\n\t\tthis.onChangeFromAztec = this.onChangeFromAztec.bind( this );\r\n\t\tthis.onKeyDown = this.onKeyDown.bind( this );\r\n\t\tthis.handleEnter = this.handleEnter.bind( this );\r\n\t\tthis.handleDelete = this.handleDelete.bind( this );\r\n\t\tthis.onPaste = this.onPaste.bind( this );\r\n\t\tthis.onFocus = this.onFocus.bind( this );\r\n\t\tthis.onBlur = this.onBlur.bind( this );\r\n\t\tthis.onTextUpdate = this.onTextUpdate.bind( this );\r\n\t\tthis.onContentSizeChange = this.onContentSizeChange.bind( this );\r\n\t\tthis.onFormatChange = this.onFormatChange.bind( this );\r\n\t\tthis.formatToValue = memize( this.formatToValue.bind( this ), {\r\n\t\t\tmaxSize: 1,\r\n\t\t} );\r\n\t\tthis.debounceCreateUndoLevel = debounce( this.onCreateUndoLevel, 1000 );\r\n\t\t// This prevents a bug in Aztec which triggers onSelectionChange twice on format change.\r\n\t\tthis.onSelectionChange = this.onSelectionChange.bind( this );\r\n\t\tthis.onSelectionChangeFromAztec =\r\n\t\t\tthis.onSelectionChangeFromAztec.bind( this );\r\n\t\tthis.valueToFormat = this.valueToFormat.bind( this );\r\n\t\tthis.getHtmlToRender = this.getHtmlToRender.bind( this );\r\n\t\tthis.handleSuggestionFunc = this.handleSuggestionFunc.bind( this );\r\n\t\tthis.handleUserSuggestion = this.handleSuggestionFunc(\r\n\t\t\tshowUserSuggestions,\r\n\t\t\t'@'\r\n\t\t).bind( this );\r\n\t\tthis.handleXpostSuggestion = this.handleSuggestionFunc(\r\n\t\t\tshowXpostSuggestions,\r\n\t\t\t'+'\r\n\t\t).bind( this );\r\n\t\tthis.suggestionOptions = this.suggestionOptions.bind( this );\r\n\t\tthis.insertString = this.insertString.bind( this );\r\n\t\tthis.manipulateEventCounterToForceNativeToRefresh =\r\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh.bind( this );\r\n\t\tthis.shouldDropEventFromAztec =\r\n\t\t\tthis.shouldDropEventFromAztec.bind( this );\r\n\t\tthis.state = {\r\n\t\t\tactiveFormats: [],\r\n\t\t\tselectedFormat: null,\r\n\t\t\theight: 0,\r\n\t\t\tcurrentFontSize: this.getFontSize( arguments[ 0 ] ),\r\n\t\t};\r\n\t\tthis.needsSelectionUpdate = false;\r\n\t\tthis.savedContent = '';\r\n\t\tthis.isTouched = false;\r\n\t\tthis.lastAztecEventType = null;\r\n\r\n\t\tthis.lastHistoryValue = value;\r\n\r\n\t\t// Internal values that are update synchronously, unlike props.\r\n\t\tthis.value = value;\r\n\t\tthis.selectionStart = selectionStart;\r\n\t\tthis.selectionEnd = selectionEnd;\r\n\t}\r\n\r\n\t/**\r\n\t * Get the current record (value and selection) from props and state.\r\n\t *\r\n\t * @return {Object} The current record (value and selection).\r\n\t */\r\n\tgetRecord() {\r\n\t\tconst {\r\n\t\t\tselectionStart: start,\r\n\t\t\tselectionEnd: end,\r\n\t\t\tcolorPalette,\r\n\t\t} = this.props;\r\n\t\tconst { value } = this.props;\r\n\t\tconst currentValue = this.formatToValue( value );\r\n\r\n\t\tconst { formats, replacements, text } = currentValue;\r\n\t\tconst { activeFormats } = this.state;\r\n\t\tconst newFormats = getFormatColors( formats, colorPalette );\r\n\r\n\t\treturn {\r\n\t\t\tformats: newFormats,\r\n\t\t\treplacements,\r\n\t\t\ttext,\r\n\t\t\tstart,\r\n\t\t\tend,\r\n\t\t\tactiveFormats,\r\n\t\t};\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a RichText value \"record\" from the current content and selection\r\n\t * information\r\n\t *\r\n\t *\r\n\t * @return {Object} A RichText value with formats and selection.\r\n\t */\r\n\tcreateRecord() {\r\n\t\tconst { preserveWhiteSpace } = this.props;\r\n\t\tconst value = {\r\n\t\t\tstart: this.selectionStart,\r\n\t\t\tend: this.selectionEnd,\r\n\t\t\t...create( {\r\n\t\t\t\thtml: this.value,\r\n\t\t\t\trange: null,\r\n\t\t\t\tpreserveWhiteSpace,\r\n\t\t\t} ),\r\n\t\t};\r\n\t\tconst start = Math.min( this.selectionStart, value.text.length );\r\n\t\tconst end = Math.min( this.selectionEnd, value.text.length );\r\n\t\treturn { ...value, start, end };\r\n\t}\r\n\r\n\tvalueToFormat( value ) {\r\n\t\t// Remove the outer root tags.\r\n\t\treturn this.removeRootTagsProducedByAztec( toHTMLString( { value } ) );\r\n\t}\r\n\r\n\tgetActiveFormatNames( record ) {\r\n\t\tconst { formatTypes } = this.props;\r\n\r\n\t\treturn formatTypes\r\n\t\t\t.map( ( { name } ) => name )\r\n\t\t\t.filter( ( name ) => {\r\n\t\t\t\treturn getActiveFormat( record, name ) !== undefined;\r\n\t\t\t} )\r\n\t\t\t.map( ( name ) => gutenbergFormatNamesToAztec[ name ] )\r\n\t\t\t.filter( Boolean );\r\n\t}\r\n\r\n\tonFormatChange( record ) {\r\n\t\tconst { start = 0, end = 0, activeFormats = [] } = record;\r\n\t\tconst changeHandlers = Object.fromEntries(\r\n\t\t\tObject.entries( this.props ).filter( ( [ key ] ) =>\r\n\t\t\t\tkey.startsWith( 'format_on_change_functions_' )\r\n\t\t\t)\r\n\t\t);\r\n\r\n\t\tObject.values( changeHandlers ).forEach( ( changeHandler ) => {\r\n\t\t\tchangeHandler( record.formats, record.text );\r\n\t\t} );\r\n\r\n\t\tthis.value = this.valueToFormat( record );\r\n\t\tthis.props.onChange( this.value );\r\n\t\tthis.setState( { activeFormats } );\r\n\t\tthis.props.onSelectionChange( start, end );\r\n\t\tthis.selectionStart = start;\r\n\t\tthis.selectionEnd = end;\r\n\r\n\t\tthis.onCreateUndoLevel();\r\n\r\n\t\tthis.lastAztecEventType = 'format change';\r\n\t}\r\n\r\n\tinsertString( record, string ) {\r\n\t\tif ( record && string ) {\r\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\r\n\t\t\tconst toInsert = insert( record, string );\r\n\t\t\tthis.onFormatChange( toInsert );\r\n\t\t}\r\n\t}\r\n\r\n\tonCreateUndoLevel() {\r\n\t\tconst { __unstableOnCreateUndoLevel: onCreateUndoLevel } = this.props;\r\n\t\t// If the content is the same, no level needs to be created.\r\n\t\tif ( this.lastHistoryValue?.toString() === this.value?.toString() ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tonCreateUndoLevel();\r\n\t\tthis.lastHistoryValue = this.value;\r\n\t}\r\n\r\n\t/*\r\n\t * Cleans up any root tags produced by aztec.\r\n\t * TODO: This should be removed on a later version when aztec doesn't return the top tag of the text being edited\r\n\t */\r\n\tremoveRootTagsProducedByAztec( html ) {\r\n\t\tlet result = this.removeRootTag( this.props.tagName, html );\r\n\r\n\t\tif ( this.props.tagsToEliminate ) {\r\n\t\t\tthis.props.tagsToEliminate.forEach( ( element ) => {\r\n\t\t\t\tresult = this.removeTag( element, result );\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tremoveRootTag( tag, html ) {\r\n\t\tconst openingTagRegexp = RegExp( '^<' + tag + '[^>]*>', 'gim' );\r\n\t\tconst closingTagRegexp = RegExp( '</' + tag + '>$', 'gim' );\r\n\r\n\t\treturn html\r\n\t\t\t.replace( openingTagRegexp, '' )\r\n\t\t\t.replace( closingTagRegexp, '' );\r\n\t}\r\n\r\n\tremoveTag( tag, html ) {\r\n\t\tconst openingTagRegexp = RegExp( '<' + tag + '>', 'gim' );\r\n\t\tconst closingTagRegexp = RegExp( '</' + tag + '>', 'gim' );\r\n\t\treturn html\r\n\t\t\t.replace( openingTagRegexp, '' )\r\n\t\t\t.replace( closingTagRegexp, '' );\r\n\t}\r\n\r\n\t/*\r\n\t * Handles any case where the content of the AztecRN instance has changed\r\n\t */\r\n\tonChangeFromAztec( event ) {\r\n\t\tif ( this.shouldDropEventFromAztec( event, 'onChange' ) ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst contentWithoutRootTag = this.removeRootTagsProducedByAztec(\r\n\t\t\tevent.nativeEvent.text\r\n\t\t);\r\n\r\n\t\tconst { __unstableInputRule } = this.props;\r\n\t\tconst currentValuePosition = {\r\n\t\t\tend: this.isIOS ? this.selectionEnd : this.selectionEnd + 1,\r\n\t\t\tstart: this.isIOS ? this.selectionStart : this.selectionStart + 1,\r\n\t\t};\r\n\r\n\t\tif (\r\n\t\t\t__unstableInputRule &&\r\n\t\t\t__unstableInputRule( {\r\n\t\t\t\t...currentValuePosition,\r\n\t\t\t\t...this.formatToValue( contentWithoutRootTag ),\r\n\t\t\t} )\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// On iOS, onChange can be triggered after selection changes, even though there are no content changes.\r\n\t\tif ( contentWithoutRootTag === this.value?.toString() ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.lastEventCount = event.nativeEvent.eventCount;\r\n\t\tthis.comesFromAztec = true;\r\n\t\tthis.firedAfterTextChanged = true; // The onChange event always fires after the fact.\r\n\t\tthis.onTextUpdate( event );\r\n\t\tthis.lastAztecEventType = 'input';\r\n\t}\r\n\r\n\tonTextUpdate( event ) {\r\n\t\tconst contentWithoutRootTag = this.removeRootTagsProducedByAztec(\r\n\t\t\tevent.nativeEvent.text\r\n\t\t);\r\n\r\n\t\tthis.debounceCreateUndoLevel();\r\n\t\tconst refresh = this.value?.toString() !== contentWithoutRootTag;\r\n\t\tthis.value = contentWithoutRootTag;\r\n\r\n\t\t// We don't want to refresh if our goal is just to create a record.\r\n\t\tif ( refresh ) {\r\n\t\t\tthis.props.onChange( contentWithoutRootTag );\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\t * Handles any case where the content of the AztecRN instance has changed in size\r\n\t */\r\n\tonContentSizeChange( contentSize ) {\r\n\t\tthis.setState( contentSize );\r\n\t\tthis.lastAztecEventType = 'content size change';\r\n\t}\r\n\r\n\tonKeyDown( event ) {\r\n\t\tif ( event.defaultPrevented ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Add stubs for conformance in downstream autocompleters logic.\r\n\t\tthis.customEditableOnKeyDown?.( {\r\n\t\t\tpreventDefault: () => undefined,\r\n\t\t\t...event,\r\n\t\t\tkey: RCTAztecView.KeyCodes[ event?.keyCode ],\r\n\t\t} );\r\n\r\n\t\tthis.handleDelete( event );\r\n\t\tthis.handleEnter( event );\r\n\t\tthis.handleTriggerKeyCodes( event );\r\n\t}\r\n\r\n\thandleEnter( event ) {\r\n\t\tif ( event.keyCode !== ENTER ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst { onEnter } = this.props;\r\n\r\n\t\tif ( ! onEnter ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tonEnter( {\r\n\t\t\tvalue: this.createRecord(),\r\n\t\t\tonChange: this.onFormatChange,\r\n\t\t\tshiftKey: event.shiftKey,\r\n\t\t} );\r\n\t\tthis.lastAztecEventType = 'input';\r\n\t}\r\n\r\n\thandleDelete( event ) {\r\n\t\tif ( this.shouldDropEventFromAztec( event, 'handleDelete' ) ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst { keyCode } = event;\r\n\r\n\t\tif ( keyCode !== DELETE && keyCode !== BACKSPACE ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst isReverse = keyCode === BACKSPACE;\r\n\r\n\t\tconst { onDelete } = this.props;\r\n\t\tthis.lastEventCount = event.nativeEvent.eventCount;\r\n\t\tthis.comesFromAztec = true;\r\n\t\tthis.firedAfterTextChanged = event.nativeEvent.firedAfterTextChanged;\r\n\t\tconst value = this.createRecord();\r\n\t\tconst { start, end, text, activeFormats } = value;\r\n\t\tconst hasActiveFormats = activeFormats && !! activeFormats.length;\r\n\t\tlet newValue;\r\n\r\n\t\t// Always handle full content deletion ourselves.\r\n\t\tif ( start === 0 && end !== 0 && end >= text.length ) {\r\n\t\t\tnewValue = remove( value );\r\n\t\t\tthis.onFormatChange( newValue );\r\n\t\t\tevent.preventDefault();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Only process delete if the key press occurs at an uncollapsed edge.\r\n\t\tif (\r\n\t\t\t! isCollapsed( value ) ||\r\n\t\t\thasActiveFormats ||\r\n\t\t\t( isReverse && start !== 0 ) ||\r\n\t\t\t( ! isReverse && end !== text.length )\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ( onDelete ) {\r\n\t\t\tonDelete( { isReverse, value } );\r\n\t\t}\r\n\r\n\t\tevent.preventDefault();\r\n\t\tthis.lastAztecEventType = 'input';\r\n\t}\r\n\r\n\thandleTriggerKeyCodes( event ) {\r\n\t\tconst { keyCode } = event;\r\n\t\tconst triggeredOption = this.suggestionOptions().find( ( option ) => {\r\n\t\t\tconst triggeredKeyCode = option.triggerChar.charCodeAt( 0 );\r\n\t\t\treturn triggeredKeyCode === keyCode;\r\n\t\t} );\r\n\r\n\t\tif ( triggeredOption ) {\r\n\t\t\tconst record = this.getRecord();\r\n\t\t\tconst text = getTextContent( record );\r\n\t\t\t// Only respond to the trigger if the selection is on the start of text or line\r\n\t\t\t// or if the character before is a space.\r\n\t\t\tconst useTrigger =\r\n\t\t\t\ttext.length === 0 ||\r\n\t\t\t\trecord.start === 0 ||\r\n\t\t\t\ttext.charAt( record.start - 1 ) === '\\n' ||\r\n\t\t\t\ttext.charAt( record.start - 1 ) === ' ';\r\n\r\n\t\t\tif ( useTrigger && triggeredOption.onClick ) {\r\n\t\t\t\ttriggeredOption.onClick();\r\n\t\t\t} else {\r\n\t\t\t\tthis.insertString( record, triggeredOption.triggerChar );\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tsuggestionOptions() {\r\n\t\tconst { areMentionsSupported, areXPostsSupported } = this.props;\r\n\t\tconst allOptions = [\r\n\t\t\t{\r\n\t\t\t\tsupported: areMentionsSupported,\r\n\t\t\t\ttitle: __( 'Insert mention' ),\r\n\t\t\t\tonClick: this.handleUserSuggestion,\r\n\t\t\t\ttriggerChar: '@',\r\n\t\t\t\tvalue: 'mention',\r\n\t\t\t\tlabel: __( 'Mention' ),\r\n\t\t\t\ticon: atSymbol,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tsupported: areXPostsSupported,\r\n\t\t\t\ttitle: __( 'Insert crosspost' ),\r\n\t\t\t\tonClick: this.handleXpostSuggestion,\r\n\t\t\t\ttriggerChar: '+',\r\n\t\t\t\tvalue: 'crosspost',\r\n\t\t\t\tlabel: __( 'Crosspost' ),\r\n\t\t\t\ticon: plus,\r\n\t\t\t},\r\n\t\t];\r\n\t\treturn allOptions.filter( ( op ) => op.supported );\r\n\t}\r\n\r\n\thandleSuggestionFunc( suggestionFunction, prefix ) {\r\n\t\treturn () => {\r\n\t\t\tconst record = this.getRecord();\r\n\t\t\tsuggestionFunction()\r\n\t\t\t\t.then( ( suggestion ) => {\r\n\t\t\t\t\tthis.insertString( record, `${ prefix }${ suggestion } ` );\r\n\t\t\t\t} )\r\n\t\t\t\t.catch( () => {} );\r\n\t\t};\r\n\t}\r\n\r\n\t/**\r\n\t * Handles a paste event from the native Aztec Wrapper.\r\n\t *\r\n\t * @param {Object} event The paste event which wraps `nativeEvent`.\r\n\t */\r\n\tonPaste( event ) {\r\n\t\tconst { onPaste, onChange } = this.props;\r\n\t\tconst { activeFormats = [] } = this.state;\r\n\r\n\t\tconst { pastedText, pastedHtml, files } = event.nativeEvent;\r\n\t\tconst currentRecord = this.createRecord();\r\n\r\n\t\tevent.preventDefault();\r\n\r\n\t\t// There is a selection, check if a URL is pasted.\r\n\t\tif ( ! isCollapsed( currentRecord ) ) {\r\n\t\t\tconst trimmedText = ( pastedHtml || pastedText )\r\n\t\t\t\t.replace( /<[^>]+>/g, '' )\r\n\t\t\t\t.trim();\r\n\r\n\t\t\t// A URL was pasted, turn the selection into a link.\r\n\t\t\tif ( isURL( trimmedText ) ) {\r\n\t\t\t\tconst linkedRecord = applyFormat( currentRecord, {\r\n\t\t\t\t\ttype: 'a',\r\n\t\t\t\t\tattributes: {\r\n\t\t\t\t\t\thref: decodeEntities( trimmedText ),\r\n\t\t\t\t\t},\r\n\t\t\t\t} );\r\n\t\t\t\tthis.value = this.valueToFormat( linkedRecord );\r\n\t\t\t\tonChange( this.value );\r\n\r\n\t\t\t\t// Allows us to ask for this information when we get a report.\r\n\t\t\t\twindow.console.log( 'Created link:\\n\\n', trimmedText );\r\n\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ( onPaste ) {\r\n\t\t\tonPaste( {\r\n\t\t\t\tvalue: currentRecord,\r\n\t\t\t\tonChange: this.onFormatChange,\r\n\t\t\t\thtml: pastedHtml,\r\n\t\t\t\tplainText: pastedText,\r\n\t\t\t\tfiles,\r\n\t\t\t\tactiveFormats,\r\n\t\t\t} );\r\n\t\t}\r\n\t}\r\n\r\n\tonFocus() {\r\n\t\tthis.isTouched = true;\r\n\r\n\t\tconst { unstableOnFocus, onSelectionChange } = this.props;\r\n\r\n\t\tif ( unstableOnFocus ) {\r\n\t\t\tunstableOnFocus();\r\n\t\t}\r\n\r\n\t\t// We know for certain that on focus, the old selection is invalid. It\r\n\t\t// will be recalculated on `selectionchange`.\r\n\r\n\t\tonSelectionChange( this.selectionStart, this.selectionEnd );\r\n\r\n\t\tthis.lastAztecEventType = 'focus';\r\n\t}\r\n\r\n\tonBlur( event ) {\r\n\t\tthis.isTouched = false;\r\n\r\n\t\t// Check if value is up to date with latest state of native AztecView.\r\n\t\tif (\r\n\t\t\tevent.nativeEvent.text &&\r\n\t\t\tevent.nativeEvent.text !== this.props.value?.toString()\r\n\t\t) {\r\n\t\t\tthis.onTextUpdate( event );\r\n\t\t}\r\n\r\n\t\tif ( this.props.onBlur ) {\r\n\t\t\tthis.props.onBlur( event );\r\n\t\t}\r\n\r\n\t\tthis.lastAztecEventType = 'blur';\r\n\t}\r\n\r\n\tonSelectionChange( start, end ) {\r\n\t\tconst hasChanged =\r\n\t\t\tthis.selectionStart !== start || this.selectionEnd !== end;\r\n\r\n\t\tthis.selectionStart = start;\r\n\t\tthis.selectionEnd = end;\r\n\r\n\t\t// This is a manual selection change event if onChange was not triggered just before\r\n\t\t// and we did not just trigger a text update\r\n\t\t// `onChange` could be the last event and could have been triggered a long time ago so\r\n\t\t// this approach is not perfectly reliable.\r\n\t\tconst isManual =\r\n\t\t\tthis.lastAztecEventType !== 'input' &&\r\n\t\t\tthis.props.value?.toString() === this.value?.toString();\r\n\t\tif ( hasChanged && isManual ) {\r\n\t\t\tconst value = this.createRecord();\r\n\t\t\tconst activeFormats = getActiveFormats( value );\r\n\t\t\tthis.setState( { activeFormats } );\r\n\t\t}\r\n\r\n\t\tthis.props.onSelectionChange( start, end );\r\n\t}\r\n\r\n\tshouldDropEventFromAztec( event, logText ) {\r\n\t\tconst shouldDrop =\r\n\t\t\t! this.isIOS && event.nativeEvent.eventCount <= this.lastEventCount;\r\n\t\tif ( shouldDrop ) {\r\n\t\t\twindow.console.log(\r\n\t\t\t\t`Dropping ${ logText } from Aztec as its event counter is older than latest sent to the native side. Got ${ event.nativeEvent.eventCount } but lastEventCount is ${ this.lastEventCount }.`\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn shouldDrop;\r\n\t}\r\n\r\n\t/**\r\n\t * Determines whether the text input should receive focus after an update.\r\n\t * For cases where a RichText with a value is merged with an empty one.\r\n\t *\r\n\t * @param {Object} prevProps - The previous props of the component.\r\n\t * @return {boolean} True if the text input should receive focus, false otherwise.\r\n\t */\r\n\tshouldFocusTextInputAfterMerge( prevProps ) {\r\n\t\tconst {\r\n\t\t\t__unstableIsSelected: isSelected,\r\n\t\t\tblockIsSelected,\r\n\t\t\tselectionStart,\r\n\t\t\tselectionEnd,\r\n\t\t\t__unstableMobileNoFocusOnMount,\r\n\t\t} = this.props;\r\n\r\n\t\tconst {\r\n\t\t\t__unstableIsSelected: prevIsSelected,\r\n\t\t\tblockIsSelected: prevBlockIsSelected,\r\n\t\t} = prevProps;\r\n\r\n\t\tconst noSelectionValues =\r\n\t\t\tselectionStart === undefined && selectionEnd === undefined;\r\n\t\tconst textInputWasNotFocused = ! prevIsSelected && ! isSelected;\r\n\r\n\t\treturn (\r\n\t\t\t! __unstableMobileNoFocusOnMount &&\r\n\t\t\tnoSelectionValues &&\r\n\t\t\ttextInputWasNotFocused &&\r\n\t\t\t! prevBlockIsSelected &&\r\n\t\t\tblockIsSelected\r\n\t\t);\r\n\t}\r\n\r\n\tonSelectionChangeFromAztec( start, end, text, event ) {\r\n\t\tif ( this.shouldDropEventFromAztec( event, 'onSelectionChange' ) ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// `end` can be less than `start` on iOS\r\n\t\t// Let's fix that here so `rich-text/slice` can work properly.\r\n\t\tconst realStart = Math.min( start, end );\r\n\t\tconst realEnd = Math.max( start, end );\r\n\r\n\t\t// Check and dicsard stray event, where the text and selection is equal to the ones already cached.\r\n\t\tconst contentWithoutRootTag = this.removeRootTagsProducedByAztec(\r\n\t\t\tevent.nativeEvent.text\r\n\t\t);\r\n\t\tif (\r\n\t\t\tcontentWithoutRootTag === this.value?.toString() &&\r\n\t\t\trealStart === this.selectionStart &&\r\n\t\t\trealEnd === this.selectionEnd\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.comesFromAztec = true;\r\n\t\tthis.firedAfterTextChanged = true; // Selection change event always fires after the fact.\r\n\r\n\t\t// Update text before updating selection\r\n\t\t// Make sure there are changes made to the content before upgrading it upward.\r\n\t\tthis.onTextUpdate( event );\r\n\r\n\t\t// Aztec can send us selection change events after it has lost focus.\r\n\t\t// For instance the autocorrect feature will complete a partially written\r\n\t\t// word when resigning focus, causing a selection change event.\r\n\t\t// Forwarding this selection change could cause this RichText to regain\r\n\t\t// focus and start a focus loop.\r\n\t\t//\r\n\t\t// See https://github.com/wordpress-mobile/gutenberg-mobile/issues/1696\r\n\t\tif ( this.props.__unstableIsSelected ) {\r\n\t\t\tthis.onSelectionChange( realStart, realEnd );\r\n\t\t}\r\n\t\t// Update lastEventCount to prevent Aztec from re-rendering the content it just sent.\r\n\t\tthis.lastEventCount = event.nativeEvent.eventCount;\r\n\r\n\t\tthis.lastAztecEventType = 'selection change';\r\n\t}\r\n\r\n\tisEmpty() {\r\n\t\treturn isEmpty( this.formatToValue( this.props.value ) );\r\n\t}\r\n\r\n\tformatToValue( value ) {\r\n\t\tconst { preserveWhiteSpace } = this.props;\r\n\t\t// Handle deprecated `children` and `node` sources.\r\n\t\tif ( Array.isArray( value ) ) {\r\n\t\t\treturn create( {\r\n\t\t\t\thtml: childrenBlock.toHTML( value ),\r\n\t\t\t\tpreserveWhiteSpace,\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\tif ( this.props.format === 'string' ) {\r\n\t\t\treturn create( {\r\n\t\t\t\thtml: value,\r\n\t\t\t\tpreserveWhiteSpace,\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\t// Guard for blocks passing `null` in onSplit callbacks. May be removed\r\n\t\t// if onSplit is revised to not pass a `null` value.\r\n\t\tif ( value === null ) {\r\n\t\t\treturn create();\r\n\t\t}\r\n\r\n\t\treturn value;\r\n\t}\r\n\r\n\tmanipulateEventCounterToForceNativeToRefresh() {\r\n\t\tif ( this.isIOS ) {\r\n\t\t\tthis.lastEventCount = undefined;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ( typeof this.lastEventCount !== 'undefined' ) {\r\n\t\t\tthis.lastEventCount += 100; // bump by a hundred, hopefully native hasn't bombarded the JS side in the meantime.\r\n\t\t} // no need to bump when 'undefined' as native side won't receive the key when the value is undefined, and that will cause force updating anyway,\r\n\t\t//   see https://github.com/WordPress/gutenberg/blob/82e578dcc75e67891c750a41a04c1e31994192fc/packages/react-native-aztec/android/src/main/java/org/wordpress/mobile/ReactNativeAztec/ReactAztecManager.java#L213-L215\r\n\t}\r\n\r\n\tshouldComponentUpdate( nextProps, nextState ) {\r\n\t\tif (\r\n\t\t\tnextProps.tagName !== this.props.tagName ||\r\n\t\t\tnextProps.reversed !== this.props.reversed ||\r\n\t\t\tnextProps.start !== this.props.start\r\n\t\t) {\r\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\r\n\t\t\tthis.value = undefined;\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// TODO: Please re-introduce the check to avoid updating the content right after an `onChange` call.\r\n\t\t// It was removed in https://github.com/WordPress/gutenberg/pull/12417 to fix undo/redo problem.\r\n\r\n\t\t// If the component is changed React side (undo/redo/merging/splitting/custom text actions)\r\n\t\t// we need to make sure the native is updated as well.\r\n\r\n\t\t// Also, don't trust the \"this.lastContent\" as on Android, incomplete text events arrive\r\n\t\t//  with only some of the text, while the virtual keyboard's suggestion system does its magic.\r\n\t\t// ** compare with this.lastContent for optimizing performance by not forcing Aztec with text it already has\r\n\t\t// , but compare with props.value to not lose \"half word\" text because of Android virtual keyb autosuggestion behavior\r\n\t\tif (\r\n\t\t\ttypeof nextProps.value !== 'undefined' &&\r\n\t\t\ttypeof this.props.value !== 'undefined' &&\r\n\t\t\t( ! this.comesFromAztec || ! this.firedAfterTextChanged ) &&\r\n\t\t\tnextProps.value?.toString() !== this.props.value?.toString()\r\n\t\t) {\r\n\t\t\t// Gutenberg seems to try to mirror the caret state even on events that only change the content so,\r\n\t\t\t//  let's force caret update if state has selection set.\r\n\t\t\tif (\r\n\t\t\t\ttypeof nextProps.selectionStart !== 'undefined' &&\r\n\t\t\t\ttypeof nextProps.selectionEnd !== 'undefined'\r\n\t\t\t) {\r\n\t\t\t\tthis.needsSelectionUpdate = true;\r\n\t\t\t}\r\n\r\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\r\n\t\t}\r\n\r\n\t\tif ( ! this.comesFromAztec ) {\r\n\t\t\tif (\r\n\t\t\t\ttypeof nextProps.selectionStart !== 'undefined' &&\r\n\t\t\t\ttypeof nextProps.selectionEnd !== 'undefined' &&\r\n\t\t\t\tnextProps.selectionStart !== this.props.selectionStart &&\r\n\t\t\t\tnextProps.selectionStart !== this.selectionStart &&\r\n\t\t\t\tnextProps.__unstableIsSelected\r\n\t\t\t) {\r\n\t\t\t\tthis.needsSelectionUpdate = true;\r\n\t\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\r\n\t\t\t}\r\n\r\n\t\t\t// For font size changes from a prop value a force refresh\r\n\t\t\t// is needed without the selection update.\r\n\t\t\tif ( nextProps?.fontSize !== this.props?.fontSize ) {\r\n\t\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\r\n\t\t\t}\r\n\r\n\t\t\tif (\r\n\t\t\t\t( nextProps?.style?.fontSize !== this.props?.style?.fontSize &&\r\n\t\t\t\t\tnextState.currentFontSize !==\r\n\t\t\t\t\t\tthis.state.currentFontSize ) ||\r\n\t\t\t\tnextState.currentFontSize !== this.state.currentFontSize ||\r\n\t\t\t\tnextProps?.style?.lineHeight !== this.props?.style?.lineHeight\r\n\t\t\t) {\r\n\t\t\t\tthis.needsSelectionUpdate = true;\r\n\t\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\tcomponentDidMount() {\r\n\t\t// Request focus if wrapping block is selected and parent hasn't inhibited the focus request. This method of focusing\r\n\t\t//  is trying to implement the web-side counterpart of BlockList's `focusTabbable` where the BlockList is focusing an\r\n\t\t//  inputbox by searching the DOM. We don't have the DOM in RN so, using the combination of blockIsSelected and __unstableMobileNoFocusOnMount\r\n\t\t//  to determine if we should focus the RichText.\r\n\t\tif (\r\n\t\t\tthis.props.blockIsSelected &&\r\n\t\t\t! this.props.__unstableMobileNoFocusOnMount\r\n\t\t) {\r\n\t\t\tthis._editor.focus();\r\n\t\t\tthis.onSelectionChange(\r\n\t\t\t\tthis.props.selectionStart || 0,\r\n\t\t\t\tthis.props.selectionEnd || 0\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tcomponentDidUpdate( prevProps ) {\r\n\t\tconst { style, tagName } = this.props;\r\n\t\tconst { currentFontSize } = this.state;\r\n\r\n\t\tif ( this.props.value?.toString() !== this.value?.toString() ) {\r\n\t\t\tthis.value = this.props.value;\r\n\t\t}\r\n\t\tconst { __unstableIsSelected: prevIsSelected } = prevProps;\r\n\t\tconst { __unstableIsSelected: isSelected } = this.props;\r\n\r\n\t\tif ( isSelected && ! prevIsSelected ) {\r\n\t\t\tthis._editor.focus();\r\n\t\t\t// Update selection props explicitly when component is selected as Aztec won't call onSelectionChange\r\n\t\t\t// if its internal value hasn't change. When created, default value is 0, 0.\r\n\t\t\tthis.onSelectionChange(\r\n\t\t\t\tthis.props.selectionStart || 0,\r\n\t\t\t\tthis.props.selectionEnd || 0\r\n\t\t\t);\r\n\t\t} else if ( this.shouldFocusTextInputAfterMerge( prevProps ) ) {\r\n\t\t\t// Since this is happening when merging blocks, the selection should be at the last character position.\r\n\t\t\t// As a fallback the internal selectionEnd value is used.\r\n\t\t\tconst lastCharacterPosition =\r\n\t\t\t\tthis.value?.toString().length ?? this.selectionEnd;\r\n\t\t\tthis._editor.focus();\r\n\t\t\tthis.props.onSelectionChange(\r\n\t\t\t\tlastCharacterPosition,\r\n\t\t\t\tlastCharacterPosition\r\n\t\t\t);\r\n\t\t} else if ( ! isSelected && prevIsSelected ) {\r\n\t\t\tthis._editor.blur();\r\n\t\t}\r\n\r\n\t\t// For font size values changes from the font size picker\r\n\t\t// we compare previous values to refresh the selected font size,\r\n\t\t// this is also used when the tag name changes\r\n\t\t// e.g Heading block and a level change like h1->h2.\r\n\t\tconst currentFontSizeStyle = this.getParsedFontSize( style?.fontSize );\r\n\t\tconst prevFontSizeStyle = this.getParsedFontSize(\r\n\t\t\tprevProps?.style?.fontSize\r\n\t\t);\r\n\t\tconst isDifferentTag = prevProps.tagName !== tagName;\r\n\t\tif (\r\n\t\t\t( currentFontSize &&\r\n\t\t\t\t( currentFontSizeStyle || prevFontSizeStyle ) &&\r\n\t\t\t\tcurrentFontSizeStyle !== currentFontSize ) ||\r\n\t\t\tisDifferentTag\r\n\t\t) {\r\n\t\t\tthis.setState( {\r\n\t\t\t\tcurrentFontSize: this.getFontSize( this.props ),\r\n\t\t\t} );\r\n\t\t}\r\n\t}\r\n\r\n\tcomponentWillUnmount() {\r\n\t\tconst { clearCurrentSelectionOnUnmount } = this.props;\r\n\r\n\t\t// There are cases when the component is unmounted e.g. scrolling in a\r\n\t\t// long post due to virtualization, so the block selection needs to be cleared\r\n\t\t// so it doesn't auto-focus when it's added back.\r\n\t\tif ( this._editor?.isFocused() ) {\r\n\t\t\tclearCurrentSelectionOnUnmount?.();\r\n\t\t}\r\n\t}\r\n\r\n\tgetHtmlToRender( record, tagName ) {\r\n\t\t// Save back to HTML from React tree.\r\n\t\tlet value = this.valueToFormat( record );\r\n\r\n\t\tif ( value === undefined ) {\r\n\t\t\tthis.manipulateEventCounterToForceNativeToRefresh(); // force a refresh on the native side\r\n\t\t\tvalue = '';\r\n\t\t}\r\n\t\t// On android if content is empty we need to send no content or else the placeholder will not show.\r\n\t\tif (\r\n\t\t\t! this.isIOS &&\r\n\t\t\t( value?.toString() === '' ||\r\n\t\t\t\tvalue?.toString() === EMPTY_PARAGRAPH_TAGS )\r\n\t\t) {\r\n\t\t\treturn '';\r\n\t\t}\r\n\r\n\t\tif ( tagName ) {\r\n\t\t\tlet extraAttributes = ``;\r\n\t\t\tif ( tagName === `ol` ) {\r\n\t\t\t\tif ( this.props.reversed ) {\r\n\t\t\t\t\textraAttributes += ` reversed`;\r\n\t\t\t\t}\r\n\t\t\t\tif ( this.props.start ) {\r\n\t\t\t\t\textraAttributes += ` start=${ this.props.start }`;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tvalue = `<${ tagName }${ extraAttributes }>${ value }</${ tagName }>`;\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tgetEditableProps() {\r\n\t\treturn {\r\n\t\t\t// Overridable props.\r\n\t\t\tstyle: {},\r\n\t\t\tclassName: 'rich-text',\r\n\t\t\tonKeyDown: () => null,\r\n\t\t};\r\n\t}\r\n\r\n\tgetParsedFontSize( fontSize ) {\r\n\t\tconst { height, width } = Dimensions.get( 'window' );\r\n\t\tconst cssUnitOptions = { height, width, fontSize: DEFAULT_FONT_SIZE };\r\n\r\n\t\tif ( ! fontSize ) {\r\n\t\t\treturn fontSize;\r\n\t\t}\r\n\r\n\t\tconst selectedPxValue =\r\n\t\t\tgetPxFromCssUnit( fontSize, cssUnitOptions ) ?? DEFAULT_FONT_SIZE;\r\n\r\n\t\treturn parseFloat( selectedPxValue );\r\n\t}\r\n\r\n\tgetFontSize( props ) {\r\n\t\tconst { baseGlobalStyles, tagName, fontSize, style } = props;\r\n\t\tconst tagNameFontSize =\r\n\t\t\tbaseGlobalStyles?.elements?.[ tagName ]?.typography?.fontSize;\r\n\r\n\t\tlet newFontSize = DEFAULT_FONT_SIZE;\r\n\r\n\t\t// Disables line-height rendering for pre elements until we fix some issues with AztecAndroid.\r\n\t\tif ( tagName === 'pre' && ! this.isIOS ) {\r\n\t\t\treturn undefined;\r\n\t\t}\r\n\r\n\t\t// For block-based themes, get the default editor font size.\r\n\t\tif ( baseGlobalStyles?.typography?.fontSize && tagName === 'p' ) {\r\n\t\t\tnewFontSize = baseGlobalStyles?.typography?.fontSize;\r\n\t\t}\r\n\r\n\t\t// For block-based themes, get the default element font size\r\n\t\t// e.g h1, h2.\r\n\t\tif ( tagNameFontSize ) {\r\n\t\t\tnewFontSize = tagNameFontSize;\r\n\t\t}\r\n\r\n\t\t// For font size values provided from the styles,\r\n\t\t// usually from values set from the font size picker.\r\n\t\tif ( style?.fontSize ) {\r\n\t\t\tnewFontSize = style.fontSize;\r\n\t\t}\r\n\r\n\t\t// Fall-back to a font size provided from its props (if there's any)\r\n\t\t// and there are no other default values to use.\r\n\t\tif ( fontSize && ! tagNameFontSize && ! style?.fontSize ) {\r\n\t\t\tnewFontSize = fontSize;\r\n\t\t}\r\n\r\n\t\t// We need to always convert to px units because the selected value\r\n\t\t// could be coming from the web where it could be stored as a different unit.\r\n\t\tconst selectedPxValue = this.getParsedFontSize( newFontSize );\r\n\r\n\t\treturn selectedPxValue;\r\n\t}\r\n\r\n\tgetLineHeight() {\r\n\t\tconst { baseGlobalStyles, tagName, lineHeight, style } = this.props;\r\n\t\tconst tagNameLineHeight =\r\n\t\t\tbaseGlobalStyles?.elements?.[ tagName ]?.typography?.lineHeight;\r\n\t\tlet newLineHeight;\r\n\r\n\t\t// Disables line-height rendering for pre elements until we fix some issues with AztecAndroid.\r\n\t\tif ( tagName === 'pre' && ! this.isIOS ) {\r\n\t\t\treturn undefined;\r\n\t\t}\r\n\r\n\t\tif ( ! this.getIsBlockBasedTheme() ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// For block-based themes, get the default editor line height.\r\n\t\tif ( baseGlobalStyles?.typography?.lineHeight && tagName === 'p' ) {\r\n\t\t\tnewLineHeight = parseFloat(\r\n\t\t\t\tbaseGlobalStyles?.typography?.lineHeight\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\t// For block-based themes, get the default element line height\r\n\t\t// e.g h1, h2.\r\n\t\tif ( tagNameLineHeight ) {\r\n\t\t\tnewLineHeight = parseFloat( tagNameLineHeight );\r\n\t\t}\r\n\r\n\t\t// For line height values provided from the styles,\r\n\t\t// usually from values set from the line height picker.\r\n\t\tif ( style?.lineHeight ) {\r\n\t\t\tnewLineHeight = parseFloat( style.lineHeight );\r\n\t\t}\r\n\r\n\t\t// Fall-back to a line height provided from its props (if there's any)\r\n\t\t// and there are no other default values to use.\r\n\t\tif ( lineHeight && ! tagNameLineHeight && ! style?.lineHeight ) {\r\n\t\t\tnewLineHeight = lineHeight;\r\n\t\t}\r\n\r\n\t\t// Check the final value is not over the minimum supported value.\r\n\t\tif ( newLineHeight && newLineHeight < MIN_LINE_HEIGHT ) {\r\n\t\t\tnewLineHeight = MIN_LINE_HEIGHT;\r\n\t\t}\r\n\r\n\t\t// Until we parse CSS values correctly, avoid passing NaN values to Aztec\r\n\t\tif ( isNaN( newLineHeight ) ) {\r\n\t\t\treturn undefined;\r\n\t\t}\r\n\r\n\t\treturn newLineHeight;\r\n\t}\r\n\r\n\tgetIsBlockBasedTheme() {\r\n\t\tconst { baseGlobalStyles } = this.props;\r\n\r\n\t\treturn (\r\n\t\t\tbaseGlobalStyles && Object.entries( baseGlobalStyles ).length !== 0\r\n\t\t);\r\n\t}\r\n\r\n\tgetBlockUseDefaultFont() {\r\n\t\t// For block-based themes it enables using the defaultFont\r\n\t\t// in Aztec for iOS so it allows customizing the font size\r\n\t\t// for the Preformatted/Code and Heading blocks.\r\n\t\tif ( ! this.isIOS ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst { tagName } = this.props;\r\n\t\tconst isBlockBasedTheme = this.getIsBlockBasedTheme();\r\n\t\tconst tagsToMatch = /pre|h([1-6])$/gm;\r\n\r\n\t\treturn isBlockBasedTheme && tagsToMatch.test( tagName );\r\n\t}\r\n\r\n\tgetLinkTextColor( defaultColor ) {\r\n\t\tconst { style } = this.props;\r\n\t\tconst customColor = style?.linkColor && colord( style.linkColor );\r\n\r\n\t\treturn customColor && customColor.isValid()\r\n\t\t\t? customColor.toHex()\r\n\t\t\t: defaultColor;\r\n\t}\r\n\r\n\tgetPlaceholderTextColor() {\r\n\t\tconst {\r\n\t\t\tbaseGlobalStyles,\r\n\t\t\tgetStylesFromColorScheme,\r\n\t\t\tplaceholderTextColor,\r\n\t\t\tstyle,\r\n\t\t} = this.props;\r\n\r\n\t\t// Default placeholder text color.\r\n\t\tconst placeholderStyle = getStylesFromColorScheme(\r\n\t\t\tstyles.richTextPlaceholder,\r\n\t\t\tstyles.richTextPlaceholderDark\r\n\t\t);\r\n\t\tconst { color: defaultPlaceholderTextColor } = placeholderStyle;\r\n\t\t// Custom 63% opacity for theme and inherited colors.\r\n\t\tconst placeholderOpacity = 'A1';\r\n\r\n\t\t// Determine inherited placeholder color if available.\r\n\t\tconst inheritPlaceholderColor = style?.placeholderColor\r\n\t\t\t? `${ style.placeholderColor }${ placeholderOpacity }`\r\n\t\t\t: undefined;\r\n\r\n\t\t// If using block-based themes, derive the placeholder color from global styles.\r\n\t\tconst globalStylesPlaceholderColor = baseGlobalStyles?.color?.text\r\n\t\t\t? `${ baseGlobalStyles.color.text }${ placeholderOpacity }`\r\n\t\t\t: undefined;\r\n\r\n\t\treturn (\r\n\t\t\tinheritPlaceholderColor ??\r\n\t\t\tplaceholderTextColor ??\r\n\t\t\tglobalStylesPlaceholderColor ??\r\n\t\t\tdefaultPlaceholderTextColor\r\n\t\t);\r\n\t}\r\n\r\n\trender() {\r\n\t\tconst {\r\n\t\t\ttagName,\r\n\t\t\tstyle,\r\n\t\t\t__unstableIsSelected: isSelected,\r\n\t\t\tchildren,\r\n\t\t\tgetStylesFromColorScheme,\r\n\t\t\tminWidth,\r\n\t\t\tmaxWidth,\r\n\t\t\tformatTypes,\r\n\t\t\tparentBlockStyles,\r\n\t\t\taccessibilityLabel,\r\n\t\t\tdisableEditingMenu = false,\r\n\t\t\tbaseGlobalStyles,\r\n\t\t\tselectionStart,\r\n\t\t\tselectionEnd,\r\n\t\t\tdisableSuggestions,\r\n\t\t\tcontainerWidth,\r\n\t\t} = this.props;\r\n\t\tconst { currentFontSize } = this.state;\r\n\r\n\t\tconst record = this.getRecord();\r\n\t\tconst html = this.getHtmlToRender( record, tagName );\r\n\t\tconst editableProps = this.getEditableProps();\r\n\t\tconst blockUseDefaultFont = this.getBlockUseDefaultFont();\r\n\r\n\t\tconst fontSize = currentFontSize;\r\n\t\tconst lineHeight = this.getLineHeight();\r\n\r\n\t\tconst {\r\n\t\t\tcolor: defaultColor,\r\n\t\t\ttextDecorationColor: defaultTextDecorationColor,\r\n\t\t\tfontFamily: defaultFontFamily,\r\n\t\t} = getStylesFromColorScheme( styles.richText, styles.richTextDark );\r\n\t\tconst linkTextColor = this.getLinkTextColor(\r\n\t\t\tdefaultTextDecorationColor\r\n\t\t);\r\n\r\n\t\tconst currentSelectionStart = selectionStart ?? 0;\r\n\t\tconst currentSelectionEnd = selectionEnd ?? 0;\r\n\t\tlet selection = null;\r\n\t\tif ( this.needsSelectionUpdate ) {\r\n\t\t\tthis.needsSelectionUpdate = false;\r\n\t\t\tselection = {\r\n\t\t\t\tstart: currentSelectionStart,\r\n\t\t\t\tend: currentSelectionEnd,\r\n\t\t\t};\r\n\r\n\t\t\t// On AztecAndroid, setting the caret to an out-of-bounds position will crash the editor so, let's check for some cases.\r\n\t\t\tif ( ! this.isIOS ) {\r\n\t\t\t\t// The following regular expression is used in Aztec here:\r\n\t\t\t\t// https://github.com/wordpress-mobile/AztecEditor-Android/blob/b1fad439d56fa6d4aa0b78526fef355c59d00dd3/aztec/src/main/kotlin/org/wordpress/aztec/AztecParser.kt#L656\r\n\t\t\t\tconst brBeforeParaMatches = html.match( /(<br>)+<\\/p>$/g );\r\n\t\t\t\tif ( brBeforeParaMatches ) {\r\n\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t'Oops, BR tag(s) at the end of content. Aztec will remove them, adapting the selection...'\r\n\t\t\t\t\t);\r\n\t\t\t\t\tconst count = (\r\n\t\t\t\t\t\tbrBeforeParaMatches[ 0 ].match( /br/g ) || []\r\n\t\t\t\t\t).length;\r\n\t\t\t\t\tif ( count > 0 ) {\r\n\t\t\t\t\t\tlet newSelectionStart = currentSelectionStart - count;\r\n\t\t\t\t\t\tif ( newSelectionStart < 0 ) {\r\n\t\t\t\t\t\t\tnewSelectionStart = 0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tlet newSelectionEnd = currentSelectionEnd - count;\r\n\t\t\t\t\t\tif ( newSelectionEnd < 0 ) {\r\n\t\t\t\t\t\t\tnewSelectionEnd = 0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tselection = {\r\n\t\t\t\t\t\t\tstart: newSelectionStart,\r\n\t\t\t\t\t\t\tend: newSelectionEnd,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ( this.comesFromAztec ) {\r\n\t\t\tthis.comesFromAztec = false;\r\n\t\t\tthis.firedAfterTextChanged = false;\r\n\t\t}\r\n\r\n\t\t// Logic below assures that `RichText` width will always have equal value when container is almost fully filled.\r\n\t\tconst width =\r\n\t\t\tmaxWidth && this.state.width && maxWidth - this.state.width < 10\r\n\t\t\t\t? maxWidth\r\n\t\t\t\t: this.state.width;\r\n\t\tconst containerStyles = [\r\n\t\t\tstyle?.padding &&\r\n\t\t\t\tstyle?.backgroundColor && {\r\n\t\t\t\t\tpadding: style.padding,\r\n\t\t\t\t\tbackgroundColor: style.backgroundColor,\r\n\t\t\t\t},\r\n\t\t\tcontainerWidth && {\r\n\t\t\t\twidth: containerWidth,\r\n\t\t\t},\r\n\t\t];\r\n\r\n\t\tconst defaultSelectionColor = getStylesFromColorScheme(\r\n\t\t\tstyles[ 'rich-text-selection' ],\r\n\t\t\tstyles[ 'rich-text-selection--dark' ]\r\n\t\t).color;\r\n\t\tconst selectionColor = getSelectionColor(\r\n\t\t\tthis.props.selectionColor,\r\n\t\t\tdefaultSelectionColor,\r\n\t\t\tbaseGlobalStyles,\r\n\t\t\tthis.getIsBlockBasedTheme()\r\n\t\t);\r\n\r\n\t\tconst EditableView = ( props ) => {\r\n\t\t\tthis.customEditableOnKeyDown = props?.onKeyDown;\r\n\r\n\t\t\treturn <></>;\r\n\t\t};\r\n\r\n\t\treturn (\r\n\t\t\t<View style={ containerStyles }>\r\n\t\t\t\t{ children &&\r\n\t\t\t\t\tchildren( {\r\n\t\t\t\t\t\tisSelected,\r\n\t\t\t\t\t\tvalue: record,\r\n\t\t\t\t\t\tonChange: this.onFormatChange,\r\n\t\t\t\t\t\tonFocus: () => {},\r\n\t\t\t\t\t\teditableProps,\r\n\t\t\t\t\t\teditableTagName: EditableView,\r\n\t\t\t\t\t} ) }\r\n\t\t\t\t<RCTAztecView\r\n\t\t\t\t\taccessibilityLabel={ accessibilityLabel }\r\n\t\t\t\t\tref={ ( ref ) => {\r\n\t\t\t\t\t\tthis._editor = ref;\r\n\r\n\t\t\t\t\t\tif ( this.props.nativeEditorRef ) {\r\n\t\t\t\t\t\t\tthis.props.nativeEditorRef( ref );\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} }\r\n\t\t\t\t\tstyle={ {\r\n\t\t\t\t\t\tbackgroundColor: styles.richText.backgroundColor,\r\n\t\t\t\t\t\t...style,\r\n\t\t\t\t\t\t...( this.isIOS && minWidth && maxWidth\r\n\t\t\t\t\t\t\t? { width }\r\n\t\t\t\t\t\t\t: { maxWidth } ),\r\n\t\t\t\t\t\tminHeight: this.state.height,\r\n\t\t\t\t\t} }\r\n\t\t\t\t\tblockUseDefaultFont={ blockUseDefaultFont }\r\n\t\t\t\t\ttext={ {\r\n\t\t\t\t\t\ttext: html,\r\n\t\t\t\t\t\teventCount: this.lastEventCount,\r\n\t\t\t\t\t\tselection,\r\n\t\t\t\t\t\tlinkTextColor,\r\n\t\t\t\t\t\ttag: tagName,\r\n\t\t\t\t\t} }\r\n\t\t\t\t\tplaceholder={ this.props.placeholder }\r\n\t\t\t\t\tplaceholderTextColor={ this.getPlaceholderTextColor() }\r\n\t\t\t\t\tdeleteEnter={ this.props.deleteEnter }\r\n\t\t\t\t\tonChange={ this.onChangeFromAztec }\r\n\t\t\t\t\tonFocus={ this.onFocus }\r\n\t\t\t\t\tonBlur={ this.onBlur }\r\n\t\t\t\t\tonKeyDown={ this.onKeyDown }\r\n\t\t\t\t\ttriggerKeyCodes={\r\n\t\t\t\t\t\tdisableEditingMenu\r\n\t\t\t\t\t\t\t? []\r\n\t\t\t\t\t\t\t: this.suggestionOptions().map(\r\n\t\t\t\t\t\t\t\t\t( op ) => op.triggerChar\r\n\t\t\t\t\t\t\t  )\r\n\t\t\t\t\t}\r\n\t\t\t\t\tonPaste={ this.onPaste }\r\n\t\t\t\t\tactiveFormats={ this.getActiveFormatNames( record ) }\r\n\t\t\t\t\tonContentSizeChange={ this.onContentSizeChange }\r\n\t\t\t\t\tonSelectionChange={ this.onSelectionChangeFromAztec }\r\n\t\t\t\t\tblockType={ { tag: tagName } }\r\n\t\t\t\t\tcolor={\r\n\t\t\t\t\t\t( style && style.color ) ||\r\n\t\t\t\t\t\t( parentBlockStyles && parentBlockStyles.color ) ||\r\n\t\t\t\t\t\t( baseGlobalStyles && baseGlobalStyles?.color?.text ) ||\r\n\t\t\t\t\t\tdefaultColor\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmaxImagesWidth={ 200 }\r\n\t\t\t\t\tfontFamily={ this.props.fontFamily || defaultFontFamily }\r\n\t\t\t\t\tfontSize={ fontSize }\r\n\t\t\t\t\tlineHeight={ lineHeight }\r\n\t\t\t\t\tfontWeight={ this.props.fontWeight }\r\n\t\t\t\t\tfontStyle={ this.props.fontStyle }\r\n\t\t\t\t\tdisableEditingMenu={ disableEditingMenu }\r\n\t\t\t\t\tisMultiline={ false }\r\n\t\t\t\t\ttextAlign={ this.props.textAlign }\r\n\t\t\t\t\t{ ...( this.isIOS ? { maxWidth } : {} ) }\r\n\t\t\t\t\tminWidth={ minWidth }\r\n\t\t\t\t\tid={ this.props.id }\r\n\t\t\t\t\tselectionColor={ selectionColor }\r\n\t\t\t\t\tdisableAutocorrection={ this.props.disableAutocorrection }\r\n\t\t\t\t/>\r\n\t\t\t\t{ isSelected && (\r\n\t\t\t\t\t<>\r\n\t\t\t\t\t\t<FormatEdit\r\n\t\t\t\t\t\t\tforwardedRef={ this._editor }\r\n\t\t\t\t\t\t\tformatTypes={ formatTypes }\r\n\t\t\t\t\t\t\tvalue={ record }\r\n\t\t\t\t\t\t\tonChange={ this.onFormatChange }\r\n\t\t\t\t\t\t\tonFocus={ () => {} }\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t{ ! disableSuggestions && (\r\n\t\t\t\t\t\t\t<BlockFormatControls>\r\n\t\t\t\t\t\t\t\t<ToolbarButtonWithOptions\r\n\t\t\t\t\t\t\t\t\toptions={ this.suggestionOptions() }\r\n\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t</BlockFormatControls>\r\n\t\t\t\t\t\t) }\r\n\t\t\t\t\t</>\r\n\t\t\t\t) }\r\n\t\t\t</View>\r\n\t\t);\r\n\t}\r\n}\r\n\r\nRichText.defaultProps = {\r\n\tformat: 'string',\r\n\tvalue: '',\r\n\ttagName: 'div',\r\n};\r\n\r\nconst withFormatTypes = ( WrappedComponent ) => ( props ) => {\r\n\tconst {\r\n\t\tclientId,\r\n\t\tidentifier,\r\n\t\twithoutInteractiveFormatting,\r\n\t\tallowedFormats,\r\n\t} = props;\r\n\tconst { formatTypes } = useFormatTypes( {\r\n\t\tclientId,\r\n\t\tidentifier,\r\n\t\twithoutInteractiveFormatting,\r\n\t\tallowedFormats,\r\n\t} );\r\n\r\n\treturn <WrappedComponent { ...props } formatTypes={ formatTypes } />;\r\n};\r\n\r\nexport default compose( [\r\n\twithSelect( ( select, { clientId } ) => {\r\n\t\tconst { getBlockParents, getBlock, getSettings } =\r\n\t\t\tselect( 'core/block-editor' );\r\n\t\tconst parents = getBlockParents( clientId, true );\r\n\t\tconst parentBlock = parents ? getBlock( parents[ 0 ] ) : undefined;\r\n\t\tconst parentBlockStyles = parentBlock?.attributes?.childrenStyles;\r\n\r\n\t\tconst settings = getSettings();\r\n\t\tconst baseGlobalStyles = settings?.__experimentalGlobalStylesBaseStyles;\r\n\r\n\t\tconst colorPalettes = settings?.__experimentalFeatures?.color?.palette;\r\n\t\tconst colorPalette = colorPalettes\r\n\t\t\t? flatColorPalettes( colorPalettes )\r\n\t\t\t: settings?.colors;\r\n\r\n\t\treturn {\r\n\t\t\tareMentionsSupported: settings?.capabilities?.mentions === true,\r\n\t\t\tareXPostsSupported: settings?.capabilities?.xposts === true,\r\n\t\t\tparentBlockStyles,\r\n\t\t\tbaseGlobalStyles,\r\n\t\t\tcolorPalette,\r\n\t\t};\r\n\t} ),\r\n\twithPreferredColorScheme,\r\n\twithFormatTypes,\r\n] )( RichText );\r\n"],"mappings":"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","ignoreList":[]}