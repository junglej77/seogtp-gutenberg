{"version":3,"names":["runOnJS","useDerivedValue","useSharedValue","useSelect","useCallback","store","blockEditorStore","useBlockListContext","getDistanceToNearestEdge","useOnBlockDrop","UPDATE_TARGET_BLOCK_INDEX_THRESHOLD","getNearestBlockIndex","blocksLayouts","position","orientation","isRTL","allowedEdges","isRightToLeft","candidateIndex","candidateDistance","forEach","element","index","x","y","width","height","rect","top","right","bottom","left","distance","edge","undefined","isTrailingEdge","offset","useBlockDropZone","rootClientId","targetRootClientId","targetBlockIndex","dragPosition","prevDragPosition","getBlockListSettings","getSettings","getBlockLayoutsOrderedByYCoord","getSortedBlocksLayouts","current","onBlockDrop","updateTargetBlockIndex","event","sortedBlockLayouts","targetIndex","value","prevX","prevY","Math","abs","onBlockDragOver","onBlockDragOverWorklet","onBlockDragEnd"],"sources":["@wordpress/block-editor/src/components/use-block-drop-zone/index.native.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport {\r\n\trunOnJS,\r\n\tuseDerivedValue,\r\n\tuseSharedValue,\r\n} from 'react-native-reanimated';\r\n\r\n/**\r\n * WordPress dependencies\r\n */\r\nimport { useSelect } from '@wordpress/data';\r\nimport { useCallback } from '@wordpress/element';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../store';\r\nimport { useBlockListContext } from '../block-list/block-list-context';\r\nimport { getDistanceToNearestEdge } from '../../utils/math';\r\nimport useOnBlockDrop from '../use-on-block-drop';\r\n\r\nconst UPDATE_TARGET_BLOCK_INDEX_THRESHOLD = 20; // In pixels\r\n\r\n/** @typedef {import('../../utils/math').WPPoint} WPPoint */\r\n\r\n/**\r\n * The orientation of a block list.\r\n *\r\n * @typedef {'horizontal'|'vertical'|undefined} WPBlockListOrientation\r\n */\r\n\r\n/**\r\n * Given a list of blocks layouts finds the index that a block should be dropped at.\r\n *\r\n * @param {Object}                 blocksLayouts Blocks layouts object.\r\n * @param {WPPoint}                position      The position of the item being dragged.\r\n * @param {WPBlockListOrientation} orientation   The orientation of a block list.\r\n * @param {boolean}                isRTL         Check if current locale is RTL.\r\n *\r\n * @return {number|undefined} The block index that's closest to the drag position.\r\n */\r\nexport function getNearestBlockIndex(\r\n\tblocksLayouts,\r\n\tposition,\r\n\torientation,\r\n\tisRTL\r\n) {\r\n\tconst allowedEdges =\r\n\t\torientation === 'horizontal'\r\n\t\t\t? [ 'left', 'right' ]\r\n\t\t\t: [ 'top', 'bottom' ];\r\n\r\n\tconst isRightToLeft = isRTL;\r\n\r\n\tlet candidateIndex;\r\n\tlet candidateDistance;\r\n\r\n\t// Only enabled for root level blocks.\r\n\tblocksLayouts.forEach( ( element, index ) => {\r\n\t\tconst { x, y, width, height } = element;\r\n\t\tconst rect = {\r\n\t\t\tx: element.x,\r\n\t\t\ty: element.y,\r\n\t\t\ttop: y,\r\n\t\t\tright: x + width,\r\n\t\t\tbottom: y + height,\r\n\t\t\tleft: x,\r\n\t\t\twidth,\r\n\t\t\theight,\r\n\t\t};\r\n\t\tconst [ distance, edge ] = getDistanceToNearestEdge(\r\n\t\t\tposition,\r\n\t\t\trect,\r\n\t\t\tallowedEdges\r\n\t\t);\r\n\r\n\t\tif ( candidateDistance === undefined || distance < candidateDistance ) {\r\n\t\t\t// If the user is dropping to the trailing edge of the block\r\n\t\t\t// add 1 to the index to represent dragging after.\r\n\t\t\t// Take RTL languages into account where the left edge is\r\n\t\t\t// the trailing edge.\r\n\t\t\tconst isTrailingEdge =\r\n\t\t\t\tedge === 'bottom' ||\r\n\t\t\t\t( ! isRightToLeft && edge === 'right' ) ||\r\n\t\t\t\t( isRightToLeft && edge === 'left' );\r\n\t\t\tconst offset = isTrailingEdge ? 1 : 0;\r\n\r\n\t\t\t// Update the currently known best candidate.\r\n\t\t\tcandidateDistance = distance;\r\n\t\t\tcandidateIndex = index + offset;\r\n\t\t}\r\n\t} );\r\n\treturn candidateIndex;\r\n}\r\n\r\n/**\r\n * @typedef  {Object} WPBlockDropZoneConfig\r\n * @property {string} rootClientId The root client id for the block list.\r\n */\r\n\r\n/**\r\n * A React hook that can be used to make a block list handle drag and drop.\r\n *\r\n * @param {WPBlockDropZoneConfig} dropZoneConfig configuration data for the drop zone.\r\n *\r\n * @return {Object} An object that contains `targetBlockIndex` and the event\r\n * handlers `onBlockDragOver`, `onBlockDragEnd` and `onBlockDrop`.\r\n */\r\nexport default function useBlockDropZone( {\r\n\t// An undefined value represents a top-level block. Default to an empty\r\n\t// string for this so that `targetRootClientId` can be easily compared to\r\n\t// values returned by the `getRootBlockClientId` selector, which also uses\r\n\t// an empty string to represent top-level blocks.\r\n\trootClientId: targetRootClientId = '',\r\n} = {} ) {\r\n\tconst targetBlockIndex = useSharedValue( null );\r\n\tconst dragPosition = {\r\n\t\tx: useSharedValue( 0 ),\r\n\t\ty: useSharedValue( 0 ),\r\n\t};\r\n\tconst prevDragPosition = {\r\n\t\tx: useSharedValue( 0 ),\r\n\t\ty: useSharedValue( 0 ),\r\n\t};\r\n\r\n\tconst { getBlockListSettings, getSettings } = useSelect( blockEditorStore );\r\n\tconst { blocksLayouts, getBlockLayoutsOrderedByYCoord } =\r\n\t\tuseBlockListContext();\r\n\r\n\tconst getSortedBlocksLayouts = useCallback( () => {\r\n\t\treturn getBlockLayoutsOrderedByYCoord( blocksLayouts.current );\r\n\t\t// We use the value of `blocksLayouts` as the dependency.\r\n\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\r\n\t}, [ blocksLayouts.current ] );\r\n\r\n\tconst isRTL = getSettings().isRTL;\r\n\r\n\tconst onBlockDrop = useOnBlockDrop();\r\n\r\n\tconst updateTargetBlockIndex = useCallback(\r\n\t\t( event ) => {\r\n\t\t\tconst sortedBlockLayouts = getSortedBlocksLayouts();\r\n\r\n\t\t\tconst targetIndex = getNearestBlockIndex(\r\n\t\t\t\tsortedBlockLayouts,\r\n\t\t\t\t{ x: event.x, y: event.y },\r\n\t\t\t\tgetBlockListSettings( targetRootClientId )?.orientation,\r\n\t\t\t\tisRTL\r\n\t\t\t);\r\n\t\t\tif ( targetIndex !== null ) {\r\n\t\t\t\ttargetBlockIndex.value = targetIndex ?? 0;\r\n\t\t\t}\r\n\t\t},\r\n\t\t[\r\n\t\t\tgetSortedBlocksLayouts,\r\n\t\t\tgetBlockListSettings,\r\n\t\t\ttargetRootClientId,\r\n\t\t\tisRTL,\r\n\t\t\ttargetBlockIndex,\r\n\t\t]\r\n\t);\r\n\r\n\tuseDerivedValue( () => {\r\n\t\tconst x = dragPosition.x.value;\r\n\t\tconst y = dragPosition.y.value;\r\n\t\tconst prevX = prevDragPosition.x.value;\r\n\t\tconst prevY = prevDragPosition.y.value;\r\n\t\t// `updateTargetBlockIndex` performs expensive calculations, so we throttle\r\n\t\t// the call using a offset threshold based on the dragging position.\r\n\t\tif (\r\n\t\t\tMath.abs( x - prevX ) >= UPDATE_TARGET_BLOCK_INDEX_THRESHOLD ||\r\n\t\t\tMath.abs( y - prevY ) >= UPDATE_TARGET_BLOCK_INDEX_THRESHOLD\r\n\t\t) {\r\n\t\t\trunOnJS( updateTargetBlockIndex )( { x, y } );\r\n\t\t\tprevDragPosition.x.value = x;\r\n\t\t\tprevDragPosition.y.value = y;\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t} );\r\n\r\n\treturn {\r\n\t\tonBlockDragOver( { x, y } ) {\r\n\t\t\tdragPosition.x.value = x;\r\n\t\t\tdragPosition.y.value = y;\r\n\t\t},\r\n\t\tonBlockDragOverWorklet( { x, y } ) {\r\n\t\t\t'worklet';\r\n\t\t\tdragPosition.x.value = x;\r\n\t\t\tdragPosition.y.value = y;\r\n\t\t},\r\n\t\tonBlockDragEnd() {\r\n\t\t\ttargetBlockIndex.value = null;\r\n\t\t},\r\n\t\tonBlockDrop: ( event ) => {\r\n\t\t\tif ( targetBlockIndex.value !== null ) {\r\n\t\t\t\tonBlockDrop( {\r\n\t\t\t\t\t...event,\r\n\t\t\t\t\ttargetRootClientId,\r\n\t\t\t\t\ttargetBlockIndex: targetBlockIndex.value,\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\t\t},\r\n\t\ttargetBlockIndex,\r\n\t};\r\n}\r\n"],"mappings":"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","ignoreList":[]}