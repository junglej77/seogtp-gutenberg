{"version":3,"names":["Controller","useLayoutEffect","useMemo","useRef","getScrollContainer","useSelect","store","blockEditorStore","BLOCK_ANIMATION_THRESHOLD","getAbsolutePosition","element","top","offsetTop","left","offsetLeft","useMovingAnimation","triggerAnimationOnChange","clientId","ref","isTyping","getGlobalBlockCount","isBlockSelected","isFirstMultiSelectedBlock","isBlockMultiSelected","isAncestorMultiSelected","previous","prevRect","current","getBoundingClientRect","scrollContainer","isSelected","adjustScrolling","preserveScrollPosition","blockRect","diff","scrollTop","disableAnimation","window","matchMedia","matches","isPartOfSelection","zIndex","controller","x","y","config","mass","tension","friction","onChange","value","Math","round","finishedMoving","style","transformOrigin","transform","undefined","destination","start","from","stop","set"],"sources":["@wordpress/block-editor/src/components/use-moving-animation/index.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport { Controller } from '@react-spring/web';\r\n\r\n/**\r\n * WordPress dependencies\r\n */\r\nimport { useLayoutEffect, useMemo, useRef } from '@wordpress/element';\r\nimport { getScrollContainer } from '@wordpress/dom';\r\nimport { useSelect } from '@wordpress/data';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../store';\r\n\r\n/**\r\n * If the block count exceeds the threshold, we disable the reordering animation\r\n * to avoid laginess.\r\n */\r\nconst BLOCK_ANIMATION_THRESHOLD = 200;\r\n\r\nfunction getAbsolutePosition( element ) {\r\n\treturn {\r\n\t\ttop: element.offsetTop,\r\n\t\tleft: element.offsetLeft,\r\n\t};\r\n}\r\n\r\n/**\r\n * Hook used to compute the styles required to move a div into a new position.\r\n *\r\n * The way this animation works is the following:\r\n *  - It first renders the element as if there was no animation.\r\n *  - It takes a snapshot of the position of the block to use it\r\n *    as a destination point for the animation.\r\n *  - It restores the element to the previous position using a CSS transform\r\n *  - It uses the \"resetAnimation\" flag to reset the animation\r\n *    from the beginning in order to animate to the new destination point.\r\n *\r\n * @param {Object} $1                          Options\r\n * @param {*}      $1.triggerAnimationOnChange Variable used to trigger the animation if it changes.\r\n * @param {string} $1.clientId\r\n */\r\nfunction useMovingAnimation( { triggerAnimationOnChange, clientId } ) {\r\n\tconst ref = useRef();\r\n\tconst {\r\n\t\tisTyping,\r\n\t\tgetGlobalBlockCount,\r\n\t\tisBlockSelected,\r\n\t\tisFirstMultiSelectedBlock,\r\n\t\tisBlockMultiSelected,\r\n\t\tisAncestorMultiSelected,\r\n\t} = useSelect( blockEditorStore );\r\n\r\n\t// Whenever the trigger changes, we need to take a snapshot of the current\r\n\t// position of the block to use it as a destination point for the animation.\r\n\tconst { previous, prevRect } = useMemo(\r\n\t\t() => ( {\r\n\t\t\tprevious: ref.current && getAbsolutePosition( ref.current ),\r\n\t\t\tprevRect: ref.current && ref.current.getBoundingClientRect(),\r\n\t\t} ),\r\n\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\r\n\t\t[ triggerAnimationOnChange ]\r\n\t);\r\n\r\n\tuseLayoutEffect( () => {\r\n\t\tif ( ! previous || ! ref.current ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst scrollContainer = getScrollContainer( ref.current );\r\n\t\tconst isSelected = isBlockSelected( clientId );\r\n\t\tconst adjustScrolling =\r\n\t\t\tisSelected || isFirstMultiSelectedBlock( clientId );\r\n\r\n\t\tfunction preserveScrollPosition() {\r\n\t\t\tif ( adjustScrolling && prevRect ) {\r\n\t\t\t\tconst blockRect = ref.current.getBoundingClientRect();\r\n\t\t\t\tconst diff = blockRect.top - prevRect.top;\r\n\r\n\t\t\t\tif ( diff ) {\r\n\t\t\t\t\tscrollContainer.scrollTop += diff;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// We disable the animation if the user has a preference for reduced\r\n\t\t// motion, if the user is typing (insertion by Enter), or if the block\r\n\t\t// count exceeds the threshold (insertion caused all the blocks that\r\n\t\t// follow to animate).\r\n\t\t// To do: consider enableing the _moving_ animation even for large\r\n\t\t// posts, while only disabling the _insertion_ animation?\r\n\t\tconst disableAnimation =\r\n\t\t\twindow.matchMedia( '(prefers-reduced-motion: reduce)' ).matches ||\r\n\t\t\tisTyping() ||\r\n\t\t\tgetGlobalBlockCount() > BLOCK_ANIMATION_THRESHOLD;\r\n\r\n\t\tif ( disableAnimation ) {\r\n\t\t\t// If the animation is disabled and the scroll needs to be adjusted,\r\n\t\t\t// just move directly to the final scroll position.\r\n\t\t\tpreserveScrollPosition();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst isPartOfSelection =\r\n\t\t\tisSelected ||\r\n\t\t\tisBlockMultiSelected( clientId ) ||\r\n\t\t\tisAncestorMultiSelected( clientId );\r\n\t\t// Make sure the other blocks move under the selected block(s).\r\n\t\tconst zIndex = isPartOfSelection ? '1' : '';\r\n\r\n\t\tconst controller = new Controller( {\r\n\t\t\tx: 0,\r\n\t\t\ty: 0,\r\n\t\t\tconfig: { mass: 5, tension: 2000, friction: 200 },\r\n\t\t\tonChange( { value } ) {\r\n\t\t\t\tif ( ! ref.current ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tlet { x, y } = value;\r\n\t\t\t\tx = Math.round( x );\r\n\t\t\t\ty = Math.round( y );\r\n\t\t\t\tconst finishedMoving = x === 0 && y === 0;\r\n\t\t\t\tref.current.style.transformOrigin = 'center center';\r\n\t\t\t\tref.current.style.transform = finishedMoving\r\n\t\t\t\t\t? null // Set to `null` to explicitly remove the transform.\r\n\t\t\t\t\t: `translate3d(${ x }px,${ y }px,0)`;\r\n\t\t\t\tref.current.style.zIndex = zIndex;\r\n\t\t\t\tpreserveScrollPosition();\r\n\t\t\t},\r\n\t\t} );\r\n\r\n\t\tref.current.style.transform = undefined;\r\n\t\tconst destination = getAbsolutePosition( ref.current );\r\n\r\n\t\tconst x = Math.round( previous.left - destination.left );\r\n\t\tconst y = Math.round( previous.top - destination.top );\r\n\r\n\t\tcontroller.start( { x: 0, y: 0, from: { x, y } } );\r\n\r\n\t\treturn () => {\r\n\t\t\tcontroller.stop();\r\n\t\t\tcontroller.set( { x: 0, y: 0 } );\r\n\t\t};\r\n\t}, [\r\n\t\tprevious,\r\n\t\tprevRect,\r\n\t\tclientId,\r\n\t\tisTyping,\r\n\t\tgetGlobalBlockCount,\r\n\t\tisBlockSelected,\r\n\t\tisFirstMultiSelectedBlock,\r\n\t\tisBlockMultiSelected,\r\n\t\tisAncestorMultiSelected,\r\n\t] );\r\n\r\n\treturn ref;\r\n}\r\n\r\nexport default useMovingAnimation;\r\n"],"mappings":"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","ignoreList":[]}