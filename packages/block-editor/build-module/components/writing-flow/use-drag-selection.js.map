{"version":3,"names":["useSelect","useDispatch","useRefEffect","store","blockEditorStore","setContentEditableWrapper","node","value","contentEditable","focus","useDragSelection","startMultiSelect","stopMultiSelect","isSelectionEnabled","hasSelectedBlock","isDraggingBlocks","isMultiSelecting","ownerDocument","defaultView","anchorElement","rafId","onMouseUp","removeEventListener","requestAnimationFrame","selection","getSelection","rangeCount","range","getRangeAt","commonAncestorContainer","clonedRange","cloneRange","contains","removeAllRanges","addRange","onMouseLeave","buttons","target","relatedTarget","getAttribute","addEventListener","cancelAnimationFrame"],"sources":["@wordpress/block-editor/src/components/writing-flow/use-drag-selection.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useSelect, useDispatch } from '@wordpress/data';\r\nimport { useRefEffect } from '@wordpress/compose';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../store';\r\n\r\n/**\r\n * Sets the `contenteditable` wrapper element to `value`.\r\n *\r\n * @param {HTMLElement} node  Block element.\r\n * @param {boolean}     value `contentEditable` value (true or false)\r\n */\r\nfunction setContentEditableWrapper( node, value ) {\r\n\tnode.contentEditable = value;\r\n\t// Firefox doesn't automatically move focus.\r\n\tif ( value ) {\r\n\t\tnode.focus();\r\n\t}\r\n}\r\n\r\n/**\r\n * Sets a multi-selection based on the native selection across blocks.\r\n */\r\nexport default function useDragSelection() {\r\n\tconst { startMultiSelect, stopMultiSelect } =\r\n\t\tuseDispatch( blockEditorStore );\r\n\tconst {\r\n\t\tisSelectionEnabled,\r\n\t\thasSelectedBlock,\r\n\t\tisDraggingBlocks,\r\n\t\tisMultiSelecting,\r\n\t} = useSelect( blockEditorStore );\r\n\treturn useRefEffect(\r\n\t\t( node ) => {\r\n\t\t\tconst { ownerDocument } = node;\r\n\t\t\tconst { defaultView } = ownerDocument;\r\n\r\n\t\t\tlet anchorElement;\r\n\t\t\tlet rafId;\r\n\r\n\t\t\tfunction onMouseUp() {\r\n\t\t\t\tstopMultiSelect();\r\n\t\t\t\t// Equivalent to attaching the listener once.\r\n\t\t\t\tdefaultView.removeEventListener( 'mouseup', onMouseUp );\r\n\t\t\t\t// The browser selection won't have updated yet at this point,\r\n\t\t\t\t// so wait until the next animation frame to get the browser\r\n\t\t\t\t// selection.\r\n\t\t\t\trafId = defaultView.requestAnimationFrame( () => {\r\n\t\t\t\t\tif ( ! hasSelectedBlock() ) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// If the selection is complete (on mouse up), and no\r\n\t\t\t\t\t// multiple blocks have been selected, set focus back to the\r\n\t\t\t\t\t// anchor element. if the anchor element contains the\r\n\t\t\t\t\t// selection. Additionally, the contentEditable wrapper can\r\n\t\t\t\t\t// now be disabled again.\r\n\t\t\t\t\tsetContentEditableWrapper( node, false );\r\n\r\n\t\t\t\t\tconst selection = defaultView.getSelection();\r\n\r\n\t\t\t\t\tif ( selection.rangeCount ) {\r\n\t\t\t\t\t\tconst range = selection.getRangeAt( 0 );\r\n\t\t\t\t\t\tconst { commonAncestorContainer } = range;\r\n\t\t\t\t\t\tconst clonedRange = range.cloneRange();\r\n\r\n\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\tanchorElement.contains( commonAncestorContainer )\r\n\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\tanchorElement.focus();\r\n\t\t\t\t\t\t\tselection.removeAllRanges();\r\n\t\t\t\t\t\t\tselection.addRange( clonedRange );\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\r\n\t\t\tfunction onMouseLeave( { buttons, target, relatedTarget } ) {\r\n\t\t\t\t// If we're moving into a child element, ignore. We're tracking\r\n\t\t\t\t// the mouse leaving the element to a parent, no a child.\r\n\t\t\t\tif ( target.contains( relatedTarget ) ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Avoid triggering a multi-selection if the user is already\r\n\t\t\t\t// dragging blocks.\r\n\t\t\t\tif ( isDraggingBlocks() ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// The primary button must be pressed to initiate selection.\r\n\t\t\t\t// See https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/buttons\r\n\t\t\t\tif ( buttons !== 1 ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Abort if we are already multi-selecting.\r\n\t\t\t\tif ( isMultiSelecting() ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Abort if selection is leaving writing flow.\r\n\t\t\t\tif ( node === target ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Check the attribute, not the contentEditable attribute. All\r\n\t\t\t\t// child elements of the content editable wrapper are editable\r\n\t\t\t\t// and return true for this property. We only want to start\r\n\t\t\t\t// multi selecting when the mouse leaves the wrapper.\r\n\t\t\t\tif ( target.getAttribute( 'contenteditable' ) !== 'true' ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ( ! isSelectionEnabled() ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Do not rely on the active element because it may change after\r\n\t\t\t\t// the mouse leaves for the first time. See\r\n\t\t\t\t// https://github.com/WordPress/gutenberg/issues/48747.\r\n\t\t\t\tanchorElement = target;\r\n\r\n\t\t\t\tstartMultiSelect();\r\n\r\n\t\t\t\t// `onSelectionStart` is called after `mousedown` and\r\n\t\t\t\t// `mouseleave` (from a block). The selection ends when\r\n\t\t\t\t// `mouseup` happens anywhere in the window.\r\n\t\t\t\tdefaultView.addEventListener( 'mouseup', onMouseUp );\r\n\r\n\t\t\t\t// Allow cross contentEditable selection by temporarily making\r\n\t\t\t\t// all content editable. We can't rely on using the store and\r\n\t\t\t\t// React because re-rending happens too slowly. We need to be\r\n\t\t\t\t// able to select across instances immediately.\r\n\t\t\t\tsetContentEditableWrapper( node, true );\r\n\t\t\t}\r\n\r\n\t\t\tnode.addEventListener( 'mouseout', onMouseLeave );\r\n\r\n\t\t\treturn () => {\r\n\t\t\t\tnode.removeEventListener( 'mouseout', onMouseLeave );\r\n\t\t\t\tdefaultView.removeEventListener( 'mouseup', onMouseUp );\r\n\t\t\t\tdefaultView.cancelAnimationFrame( rafId );\r\n\t\t\t};\r\n\t\t},\r\n\t\t[\r\n\t\t\tstartMultiSelect,\r\n\t\t\tstopMultiSelect,\r\n\t\t\tisSelectionEnabled,\r\n\t\t\thasSelectedBlock,\r\n\t\t]\r\n\t);\r\n}\r\n"],"mappings":"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","ignoreList":[]}