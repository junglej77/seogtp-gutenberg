{"version":3,"names":["useSelect","useDispatch","useRefEffect","ENTER","BACKSPACE","DELETE","createBlock","getDefaultBlockName","hasBlockSupport","getBlockTransforms","findTransform","store","blockEditorStore","getSelectionRoot","useInput","__unstableIsFullySelected","getSelectedBlockClientIds","getSelectedBlockClientId","__unstableIsSelectionMergeable","hasMultiSelection","getBlockName","canInsertBlockType","getBlockRootClientId","getSelectionStart","getSelectionEnd","getBlockAttributes","replaceBlocks","__unstableSplitSelection","removeBlocks","__unstableDeleteSelection","__unstableExpandSelection","__unstableMarkAutomaticChange","node","onBeforeInput","event","contentEditable","selection","ownerDocument","defaultView","getSelection","range","rangeCount","getRangeAt","root","focus","removeAllRanges","addRange","preventDefault","onKeyDown","defaultPrevented","activeElement","key","selectionRoot","selectAllChildren","method","keyCode","shiftKey","clientId","blockName","selectionStart","selectionEnd","attributeKey","selectedAttributeValue","transforms","filter","type","transformation","item","regExp","test","transform","content","__deprecatedOnSplit","length","metaKey","ctrlKey","onCompositionStart","addEventListener","removeEventListener"],"sources":["@wordpress/block-editor/src/components/writing-flow/use-input.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useSelect, useDispatch } from '@wordpress/data';\r\nimport { useRefEffect } from '@wordpress/compose';\r\nimport { ENTER, BACKSPACE, DELETE } from '@wordpress/keycodes';\r\nimport {\r\n\tcreateBlock,\r\n\tgetDefaultBlockName,\r\n\thasBlockSupport,\r\n\tgetBlockTransforms,\r\n\tfindTransform,\r\n} from '@wordpress/blocks';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as blockEditorStore } from '../../store';\r\nimport { getSelectionRoot } from './utils';\r\n\r\n/**\r\n * Handles input for selections across blocks.\r\n */\r\nexport default function useInput() {\r\n\tconst {\r\n\t\t__unstableIsFullySelected,\r\n\t\tgetSelectedBlockClientIds,\r\n\t\tgetSelectedBlockClientId,\r\n\t\t__unstableIsSelectionMergeable,\r\n\t\thasMultiSelection,\r\n\t\tgetBlockName,\r\n\t\tcanInsertBlockType,\r\n\t\tgetBlockRootClientId,\r\n\t\tgetSelectionStart,\r\n\t\tgetSelectionEnd,\r\n\t\tgetBlockAttributes,\r\n\t} = useSelect( blockEditorStore );\r\n\tconst {\r\n\t\treplaceBlocks,\r\n\t\t__unstableSplitSelection,\r\n\t\tremoveBlocks,\r\n\t\t__unstableDeleteSelection,\r\n\t\t__unstableExpandSelection,\r\n\t\t__unstableMarkAutomaticChange,\r\n\t} = useDispatch( blockEditorStore );\r\n\r\n\treturn useRefEffect( ( node ) => {\r\n\t\tfunction onBeforeInput( event ) {\r\n\t\t\t// If writing flow is editable, NEVER allow the browser to alter the\r\n\t\t\t// DOM. This will cause React errors (and the DOM should only be\r\n\t\t\t// altered in a controlled fashion).\r\n\t\t\tif ( node.contentEditable === 'true' ) {\r\n\t\t\t\tconst selection = node.ownerDocument.defaultView.getSelection();\r\n\t\t\t\tconst range = selection.rangeCount\r\n\t\t\t\t\t? selection.getRangeAt( 0 )\r\n\t\t\t\t\t: null;\r\n\t\t\t\tconst root = getSelectionRoot( node.ownerDocument );\r\n\r\n\t\t\t\t// If selection is contained within a nested editable, allow\r\n\t\t\t\t// input. We need to ensure that selection is maintained.\r\n\t\t\t\tif ( root ) {\r\n\t\t\t\t\tnode.contentEditable = false;\r\n\t\t\t\t\troot.focus();\r\n\t\t\t\t\tselection.removeAllRanges();\r\n\t\t\t\t\tif ( range ) {\r\n\t\t\t\t\t\tselection.addRange( range );\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction onKeyDown( event ) {\r\n\t\t\tif ( event.defaultPrevented ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tif ( ! hasMultiSelection() ) {\r\n\t\t\t\tconst { ownerDocument } = node;\r\n\t\t\t\tif ( node === ownerDocument.activeElement ) {\r\n\t\t\t\t\tif ( event.key === 'End' || event.key === 'Home' ) {\r\n\t\t\t\t\t\tconst selectionRoot = getSelectionRoot( ownerDocument );\r\n\t\t\t\t\t\tconst selection =\r\n\t\t\t\t\t\t\townerDocument.defaultView.getSelection();\r\n\t\t\t\t\t\tselection.selectAllChildren( selectionRoot );\r\n\t\t\t\t\t\tconst method =\r\n\t\t\t\t\t\t\tevent.key === 'End'\r\n\t\t\t\t\t\t\t\t? 'collapseToEnd'\r\n\t\t\t\t\t\t\t\t: 'collapseToStart';\r\n\t\t\t\t\t\tselection[ method ]();\r\n\t\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ( event.keyCode === ENTER ) {\r\n\t\t\t\t\tif ( event.shiftKey || __unstableIsFullySelected() ) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst clientId = getSelectedBlockClientId();\r\n\t\t\t\t\tconst blockName = getBlockName( clientId );\r\n\t\t\t\t\tconst selectionStart = getSelectionStart();\r\n\t\t\t\t\tconst selectionEnd = getSelectionEnd();\r\n\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tselectionStart.attributeKey ===\r\n\t\t\t\t\t\tselectionEnd.attributeKey\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\tconst selectedAttributeValue =\r\n\t\t\t\t\t\t\tgetBlockAttributes( clientId )[\r\n\t\t\t\t\t\t\t\tselectionStart.attributeKey\r\n\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\tconst transforms = getBlockTransforms( 'from' ).filter(\r\n\t\t\t\t\t\t\t( { type } ) => type === 'enter'\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tconst transformation = findTransform(\r\n\t\t\t\t\t\t\ttransforms,\r\n\t\t\t\t\t\t\t( item ) => {\r\n\t\t\t\t\t\t\t\treturn item.regExp.test(\r\n\t\t\t\t\t\t\t\t\tselectedAttributeValue\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\tif ( transformation ) {\r\n\t\t\t\t\t\t\treplaceBlocks(\r\n\t\t\t\t\t\t\t\tclientId,\r\n\t\t\t\t\t\t\t\ttransformation.transform( {\r\n\t\t\t\t\t\t\t\t\tcontent: selectedAttributeValue,\r\n\t\t\t\t\t\t\t\t} )\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t__unstableMarkAutomaticChange();\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\t! hasBlockSupport( blockName, 'splitting', false ) &&\r\n\t\t\t\t\t\t! event.__deprecatedOnSplit\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Ensure template is not locked.\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tcanInsertBlockType(\r\n\t\t\t\t\t\t\tblockName,\r\n\t\t\t\t\t\t\tgetBlockRootClientId( clientId )\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\t__unstableSplitSelection();\r\n\t\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tif ( event.keyCode === ENTER ) {\r\n\t\t\t\tnode.contentEditable = false;\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tif ( __unstableIsFullySelected() ) {\r\n\t\t\t\t\treplaceBlocks(\r\n\t\t\t\t\t\tgetSelectedBlockClientIds(),\r\n\t\t\t\t\t\tcreateBlock( getDefaultBlockName() )\r\n\t\t\t\t\t);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t__unstableSplitSelection();\r\n\t\t\t\t}\r\n\t\t\t} else if (\r\n\t\t\t\tevent.keyCode === BACKSPACE ||\r\n\t\t\t\tevent.keyCode === DELETE\r\n\t\t\t) {\r\n\t\t\t\tnode.contentEditable = false;\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tif ( __unstableIsFullySelected() ) {\r\n\t\t\t\t\tremoveBlocks( getSelectedBlockClientIds() );\r\n\t\t\t\t} else if ( __unstableIsSelectionMergeable() ) {\r\n\t\t\t\t\t__unstableDeleteSelection( event.keyCode === DELETE );\r\n\t\t\t\t} else {\r\n\t\t\t\t\t__unstableExpandSelection();\r\n\t\t\t\t}\r\n\t\t\t} else if (\r\n\t\t\t\t// If key.length is longer than 1, it's a control key that doesn't\r\n\t\t\t\t// input anything.\r\n\t\t\t\tevent.key.length === 1 &&\r\n\t\t\t\t! ( event.metaKey || event.ctrlKey )\r\n\t\t\t) {\r\n\t\t\t\tnode.contentEditable = false;\r\n\t\t\t\tif ( __unstableIsSelectionMergeable() ) {\r\n\t\t\t\t\t__unstableDeleteSelection( event.keyCode === DELETE );\r\n\t\t\t\t} else {\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t// Safari does not stop default behaviour with either\r\n\t\t\t\t\t// event.preventDefault() or node.contentEditable = false, so\r\n\t\t\t\t\t// remove the selection to stop browser manipulation.\r\n\t\t\t\t\tnode.ownerDocument.defaultView\r\n\t\t\t\t\t\t.getSelection()\r\n\t\t\t\t\t\t.removeAllRanges();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction onCompositionStart( event ) {\r\n\t\t\tif ( ! hasMultiSelection() ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tnode.contentEditable = false;\r\n\r\n\t\t\tif ( __unstableIsSelectionMergeable() ) {\r\n\t\t\t\t__unstableDeleteSelection();\r\n\t\t\t} else {\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\t// Safari does not stop default behaviour with either\r\n\t\t\t\t// event.preventDefault() or node.contentEditable = false, so\r\n\t\t\t\t// remove the selection to stop browser manipulation.\r\n\t\t\t\tnode.ownerDocument.defaultView.getSelection().removeAllRanges();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tnode.addEventListener( 'beforeinput', onBeforeInput );\r\n\t\tnode.addEventListener( 'keydown', onKeyDown );\r\n\t\tnode.addEventListener( 'compositionstart', onCompositionStart );\r\n\t\treturn () => {\r\n\t\t\tnode.removeEventListener( 'beforeinput', onBeforeInput );\r\n\t\t\tnode.removeEventListener( 'keydown', onKeyDown );\r\n\t\t\tnode.removeEventListener( 'compositionstart', onCompositionStart );\r\n\t\t};\r\n\t}, [] );\r\n}\r\n"],"mappings":"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","ignoreList":[]}