{"version":3,"names":["getFilesFromDataTransfer","removeWindowsFragments","html","startStr","startIdx","indexOf","substring","length","endStr","endIdx","removeCharsetMetaTag","metaTag","startsWith","slice","getPasteEventData","clipboardData","plainText","getData","error","files","shouldDismissPastedFiles","type","IMAGE_TAG","match","IMG_WITH_LOCAL_SRC"],"sources":["@wordpress/block-editor/src/utils/pasting.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { getFilesFromDataTransfer } from '@wordpress/dom';\r\n\r\n/**\r\n * Normalizes a given string of HTML to remove the Windows-specific \"Fragment\"\r\n * comments and any preceding and trailing content.\r\n *\r\n * @param {string} html the html to be normalized\r\n * @return {string} the normalized html\r\n */\r\nfunction removeWindowsFragments( html ) {\r\n\tconst startStr = '<!--StartFragment-->';\r\n\tconst startIdx = html.indexOf( startStr );\r\n\tif ( startIdx > -1 ) {\r\n\t\thtml = html.substring( startIdx + startStr.length );\r\n\t} else {\r\n\t\t// No point looking for EndFragment\r\n\t\treturn html;\r\n\t}\r\n\r\n\tconst endStr = '<!--EndFragment-->';\r\n\tconst endIdx = html.indexOf( endStr );\r\n\tif ( endIdx > -1 ) {\r\n\t\thtml = html.substring( 0, endIdx );\r\n\t}\r\n\r\n\treturn html;\r\n}\r\n\r\n/**\r\n * Removes the charset meta tag inserted by Chromium.\r\n * See:\r\n * - https://github.com/WordPress/gutenberg/issues/33585\r\n * - https://bugs.chromium.org/p/chromium/issues/detail?id=1264616#c4\r\n *\r\n * @param {string} html the html to be stripped of the meta tag.\r\n * @return {string} the cleaned html\r\n */\r\nfunction removeCharsetMetaTag( html ) {\r\n\tconst metaTag = `<meta charset='utf-8'>`;\r\n\r\n\tif ( html.startsWith( metaTag ) ) {\r\n\t\treturn html.slice( metaTag.length );\r\n\t}\r\n\r\n\treturn html;\r\n}\r\n\r\nexport function getPasteEventData( { clipboardData } ) {\r\n\tlet plainText = '';\r\n\tlet html = '';\r\n\r\n\ttry {\r\n\t\tplainText = clipboardData.getData( 'text/plain' );\r\n\t\thtml = clipboardData.getData( 'text/html' );\r\n\t} catch ( error ) {\r\n\t\t// Some browsers like UC Browser paste plain text by default and\r\n\t\t// don't support clipboardData at all, so allow default\r\n\t\t// behaviour.\r\n\t\treturn;\r\n\t}\r\n\r\n\t// Remove Windows-specific metadata appended within copied HTML text.\r\n\thtml = removeWindowsFragments( html );\r\n\r\n\t// Strip meta tag.\r\n\thtml = removeCharsetMetaTag( html );\r\n\r\n\tconst files = getFilesFromDataTransfer( clipboardData );\r\n\r\n\tif ( files.length && ! shouldDismissPastedFiles( files, html ) ) {\r\n\t\treturn { files };\r\n\t}\r\n\r\n\treturn { html, plainText, files: [] };\r\n}\r\n\r\n/**\r\n * Given a collection of DataTransfer files and HTML and plain text strings,\r\n * determine whether the files are to be dismissed in favor of the HTML.\r\n *\r\n * Certain office-type programs, like Microsoft Word or Apple Numbers,\r\n * will, upon copy, generate a screenshot of the content being copied and\r\n * attach it to the clipboard alongside the actual rich text that the user\r\n * sought to copy. In those cases, we should let Gutenberg handle the rich text\r\n * content and not the screenshot, since this allows Gutenberg to insert\r\n * meaningful blocks, like paragraphs, lists or even tables.\r\n *\r\n * @param {File[]} files File objects obtained from a paste event\r\n * @param {string} html  HTML content obtained from a paste event\r\n * @return {boolean}     True if the files should be dismissed\r\n */\r\nexport function shouldDismissPastedFiles( files, html /*, plainText */ ) {\r\n\t// The question is only relevant when there is actual HTML content and when\r\n\t// there is exactly one image file.\r\n\tif (\r\n\t\thtml &&\r\n\t\tfiles?.length === 1 &&\r\n\t\tfiles[ 0 ].type.indexOf( 'image/' ) === 0\r\n\t) {\r\n\t\t// A single <img> tag found in the HTML source suggests that the\r\n\t\t// content being pasted revolves around an image. Sometimes there are\r\n\t\t// other elements found, like <figure>, but we assume that the user's\r\n\t\t// intention is to paste the actual image file.\r\n\t\tconst IMAGE_TAG = /<\\s*img\\b/gi;\r\n\t\tif ( html.match( IMAGE_TAG )?.length !== 1 ) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Even when there is exactly one <img> tag in the HTML payload, we\r\n\t\t// choose to weed out local images, i.e. those whose source starts with\r\n\t\t// \"file://\". These payloads occur in specific configurations, such as\r\n\t\t// when copying an entire document from Microsoft Word, that contains\r\n\t\t// text and exactly one image, and pasting that content using Google\r\n\t\t// Chrome.\r\n\t\tconst IMG_WITH_LOCAL_SRC = /<\\s*img\\b[^>]*\\bsrc=\"file:\\/\\//i;\r\n\t\tif ( html.match( IMG_WITH_LOCAL_SRC ) ) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n"],"mappings":"AAAA;AACA;AACA;AACA,SAASA,wBAAwB,QAAQ,gBAAgB;;AAEzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASC,sBAAsBA,CAAEC,IAAI,EAAG;EACvC,MAAMC,QAAQ,GAAG,sBAAsB;EACvC,MAAMC,QAAQ,GAAGF,IAAI,CAACG,OAAO,CAAEF,QAAS,CAAC;EACzC,IAAKC,QAAQ,GAAG,CAAC,CAAC,EAAG;IACpBF,IAAI,GAAGA,IAAI,CAACI,SAAS,CAAEF,QAAQ,GAAGD,QAAQ,CAACI,MAAO,CAAC;EACpD,CAAC,MAAM;IACN;IACA,OAAOL,IAAI;EACZ;EAEA,MAAMM,MAAM,GAAG,oBAAoB;EACnC,MAAMC,MAAM,GAAGP,IAAI,CAACG,OAAO,CAAEG,MAAO,CAAC;EACrC,IAAKC,MAAM,GAAG,CAAC,CAAC,EAAG;IAClBP,IAAI,GAAGA,IAAI,CAACI,SAAS,CAAE,CAAC,EAAEG,MAAO,CAAC;EACnC;EAEA,OAAOP,IAAI;AACZ;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASQ,oBAAoBA,CAAER,IAAI,EAAG;EACrC,MAAMS,OAAO,GAAI,wBAAuB;EAExC,IAAKT,IAAI,CAACU,UAAU,CAAED,OAAQ,CAAC,EAAG;IACjC,OAAOT,IAAI,CAACW,KAAK,CAAEF,OAAO,CAACJ,MAAO,CAAC;EACpC;EAEA,OAAOL,IAAI;AACZ;AAEA,OAAO,SAASY,iBAAiBA,CAAE;EAAEC;AAAc,CAAC,EAAG;EACtD,IAAIC,SAAS,GAAG,EAAE;EAClB,IAAId,IAAI,GAAG,EAAE;EAEb,IAAI;IACHc,SAAS,GAAGD,aAAa,CAACE,OAAO,CAAE,YAAa,CAAC;IACjDf,IAAI,GAAGa,aAAa,CAACE,OAAO,CAAE,WAAY,CAAC;EAC5C,CAAC,CAAC,OAAQC,KAAK,EAAG;IACjB;IACA;IACA;IACA;EACD;;EAEA;EACAhB,IAAI,GAAGD,sBAAsB,CAAEC,IAAK,CAAC;;EAErC;EACAA,IAAI,GAAGQ,oBAAoB,CAAER,IAAK,CAAC;EAEnC,MAAMiB,KAAK,GAAGnB,wBAAwB,CAAEe,aAAc,CAAC;EAEvD,IAAKI,KAAK,CAACZ,MAAM,IAAI,CAAEa,wBAAwB,CAAED,KAAK,EAAEjB,IAAK,CAAC,EAAG;IAChE,OAAO;MAAEiB;IAAM,CAAC;EACjB;EAEA,OAAO;IAAEjB,IAAI;IAAEc,SAAS;IAAEG,KAAK,EAAE;EAAG,CAAC;AACtC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,wBAAwBA,CAAED,KAAK,EAAEjB,IAAI,CAAC,kBAAmB;EACxE;EACA;EACA,IACCA,IAAI,IACJiB,KAAK,EAAEZ,MAAM,KAAK,CAAC,IACnBY,KAAK,CAAE,CAAC,CAAE,CAACE,IAAI,CAAChB,OAAO,CAAE,QAAS,CAAC,KAAK,CAAC,EACxC;IACD;IACA;IACA;IACA;IACA,MAAMiB,SAAS,GAAG,aAAa;IAC/B,IAAKpB,IAAI,CAACqB,KAAK,CAAED,SAAU,CAAC,EAAEf,MAAM,KAAK,CAAC,EAAG;MAC5C,OAAO,IAAI;IACZ;;IAEA;IACA;IACA;IACA;IACA;IACA;IACA,MAAMiB,kBAAkB,GAAG,iCAAiC;IAC5D,IAAKtB,IAAI,CAACqB,KAAK,CAAEC,kBAAmB,CAAC,EAAG;MACvC,OAAO,IAAI;IACZ;EACD;EAEA,OAAO,KAAK;AACb","ignoreList":[]}