{"version":3,"names":["parsel","postcss","CssSyntaxError","prefixSelector","rebaseUrl","cacheByWrapperSelector","Map","ROOT_SELECTOR_TOKENS","type","content","prefixRootSelector","prefix","selector","tokenized","tokenize","lastRootIndex","findLastIndex","some","rootSelector","insertionPoint","i","length","tokenizedPrefix","splice","stringify","transformStyle","css","ignoredSelectors","baseURL","wrapperSelector","transformOptions","_transformOptions$ign","excludedSelectors","transform","prefixedSelector","excludedSelector","RegExp","match","includes","hasRootSelector","startsWith","rootUrl","filter","Boolean","process","error","console","warn","message","showSourceCode","transformStyles","styles","cache","get","WeakMap","set","map","style"],"sources":["@wordpress/block-editor/src/utils/transform-styles/index.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport * as parsel from 'parsel-js';\r\nimport postcss, { CssSyntaxError } from 'postcss';\r\nimport prefixSelector from 'postcss-prefix-selector';\r\nimport rebaseUrl from 'postcss-urlrebase';\r\n\r\nconst cacheByWrapperSelector = new Map();\r\n\r\nconst ROOT_SELECTOR_TOKENS = [\r\n\t{ type: 'type', content: 'body' },\r\n\t{ type: 'type', content: 'html' },\r\n\t{ type: 'pseudo-class', content: ':root' },\r\n\t{ type: 'pseudo-class', content: ':where(body)' },\r\n\t{ type: 'pseudo-class', content: ':where(:root)' },\r\n\t{ type: 'pseudo-class', content: ':where(html)' },\r\n];\r\n\r\n/**\r\n * Prefixes root selectors in a way that ensures consistent specificity.\r\n * This requires special handling, since prefixing a classname before\r\n * html, body, or :root will generally result in an invalid selector.\r\n *\r\n * Some libraries will simply replace the root selector with the prefix\r\n * instead, but this results in inconsistent specificity.\r\n *\r\n * This function instead inserts the prefix after the root tags but before\r\n * any other part of the selector. This results in consistent specificity:\r\n * - If a `:where()` selector is used for the prefix, all selectors output\r\n *   by `transformStyles` will have no specificity increase.\r\n * - If a classname, id, or something else is used as the prefix, all selectors\r\n *   will have the same specificity bump when transformed.\r\n *\r\n * @param {string} prefix   The prefix.\r\n * @param {string} selector The selector.\r\n *\r\n * @return {string} The prefixed root selector.\r\n */\r\nfunction prefixRootSelector( prefix, selector ) {\r\n\t// Use a tokenizer, since regular expressions are unreliable.\r\n\tconst tokenized = parsel.tokenize( selector );\r\n\r\n\t// Find the last token that contains a root selector by walking back\r\n\t// through the tokens.\r\n\tconst lastRootIndex = tokenized.findLastIndex( ( { content, type } ) => {\r\n\t\treturn ROOT_SELECTOR_TOKENS.some(\r\n\t\t\t( rootSelector ) =>\r\n\t\t\t\tcontent === rootSelector.content && type === rootSelector.type\r\n\t\t);\r\n\t} );\r\n\r\n\t// Walk forwards to find the combinator after the last root.\r\n\t// This is where the root ends and the rest of the selector begins,\r\n\t// and the index to insert before.\r\n\t// Doing it this way takes into account that a root selector like\r\n\t// 'body' may have additional id/class/pseudo-class/attribute-selector\r\n\t// parts chained to it, which is difficult to quantify using a regex.\r\n\tlet insertionPoint = -1;\r\n\tfor ( let i = lastRootIndex + 1; i < tokenized.length; i++ ) {\r\n\t\tif ( tokenized[ i ].type === 'combinator' ) {\r\n\t\t\tinsertionPoint = i;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\t// Tokenize and insert the prefix with a ' ' combinator before it.\r\n\tconst tokenizedPrefix = parsel.tokenize( prefix );\r\n\ttokenized.splice(\r\n\t\t// Insert at the insertion point, or the end.\r\n\t\tinsertionPoint === -1 ? tokenized.length : insertionPoint,\r\n\t\t0,\r\n\t\t{\r\n\t\t\ttype: 'combinator',\r\n\t\t\tcontent: ' ',\r\n\t\t},\r\n\t\t...tokenizedPrefix\r\n\t);\r\n\r\n\treturn parsel.stringify( tokenized );\r\n}\r\n\r\nfunction transformStyle(\r\n\t{ css, ignoredSelectors = [], baseURL },\r\n\twrapperSelector = '',\r\n\ttransformOptions\r\n) {\r\n\t// When there is no wrapper selector and no base URL, there is no need\r\n\t// to transform the CSS. This is most cases because in the default\r\n\t// iframed editor, no wrapping is needed, and not many styles\r\n\t// provide a base URL.\r\n\tif ( ! wrapperSelector && ! baseURL ) {\r\n\t\treturn css;\r\n\t}\r\n\r\n\ttry {\r\n\t\tconst excludedSelectors = [\r\n\t\t\t...ignoredSelectors,\r\n\t\t\t...( transformOptions?.ignoredSelectors ?? [] ),\r\n\t\t\twrapperSelector,\r\n\t\t];\r\n\r\n\t\treturn postcss(\r\n\t\t\t[\r\n\t\t\t\twrapperSelector &&\r\n\t\t\t\t\tprefixSelector( {\r\n\t\t\t\t\t\tprefix: wrapperSelector,\r\n\t\t\t\t\t\ttransform( prefix, selector, prefixedSelector ) {\r\n\t\t\t\t\t\t\t// For backwards compatibility, don't use the `exclude` option\r\n\t\t\t\t\t\t\t// of postcss-prefix-selector, instead handle it here to match\r\n\t\t\t\t\t\t\t// the behavior of the old library (postcss-prefix-wrap) that\r\n\t\t\t\t\t\t\t// `transformStyle` previously used.\r\n\t\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t\texcludedSelectors.some( ( excludedSelector ) =>\r\n\t\t\t\t\t\t\t\t\texcludedSelector instanceof RegExp\r\n\t\t\t\t\t\t\t\t\t\t? selector.match( excludedSelector )\r\n\t\t\t\t\t\t\t\t\t\t: selector.includes( excludedSelector )\r\n\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\t\treturn selector;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tconst hasRootSelector = ROOT_SELECTOR_TOKENS.some(\r\n\t\t\t\t\t\t\t\t( rootSelector ) =>\r\n\t\t\t\t\t\t\t\t\tselector.startsWith( rootSelector.content )\r\n\t\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\t\t// Reorganize root selectors such that the root part comes before the prefix,\r\n\t\t\t\t\t\t\t// but the prefix still comes before the remaining part of the selector.\r\n\t\t\t\t\t\t\tif ( hasRootSelector ) {\r\n\t\t\t\t\t\t\t\treturn prefixRootSelector( prefix, selector );\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\treturn prefixedSelector;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t} ),\r\n\t\t\t\tbaseURL && rebaseUrl( { rootUrl: baseURL } ),\r\n\t\t\t].filter( Boolean )\r\n\t\t).process( css, {} ).css; // use sync PostCSS API\r\n\t} catch ( error ) {\r\n\t\tif ( error instanceof CssSyntaxError ) {\r\n\t\t\t// eslint-disable-next-line no-console\r\n\t\t\tconsole.warn(\r\n\t\t\t\t'wp.blockEditor.transformStyles Failed to transform CSS.',\r\n\t\t\t\terror.message + '\\n' + error.showSourceCode( false )\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\t// eslint-disable-next-line no-console\r\n\t\t\tconsole.warn(\r\n\t\t\t\t'wp.blockEditor.transformStyles Failed to transform CSS.',\r\n\t\t\t\terror\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n}\r\n\r\n/**\r\n * @typedef {Object} EditorStyle\r\n * @property {string}    css              the CSS block(s), as a single string.\r\n * @property {?string}   baseURL          the base URL to be used as the reference when rewritting urls.\r\n * @property {?string[]} ignoredSelectors the selectors not to wrap.\r\n */\r\n\r\n/**\r\n * @typedef {Object} TransformOptions\r\n * @property {?string[]} ignoredSelectors the selectors not to wrap.\r\n */\r\n\r\n/**\r\n * Applies a series of CSS rule transforms to wrap selectors inside a given class and/or rewrite URLs depending on the parameters passed.\r\n *\r\n * @param {EditorStyle[]}    styles           CSS rules.\r\n * @param {string}           wrapperSelector  Wrapper selector.\r\n * @param {TransformOptions} transformOptions Additional options for style transformation.\r\n * @return {Array} converted rules.\r\n */\r\nconst transformStyles = ( styles, wrapperSelector = '', transformOptions ) => {\r\n\tlet cache = cacheByWrapperSelector.get( wrapperSelector );\r\n\tif ( ! cache ) {\r\n\t\tcache = new WeakMap();\r\n\t\tcacheByWrapperSelector.set( wrapperSelector, cache );\r\n\t}\r\n\treturn styles.map( ( style ) => {\r\n\t\tlet css = cache.get( style );\r\n\t\tif ( ! css ) {\r\n\t\t\tcss = transformStyle( style, wrapperSelector, transformOptions );\r\n\t\t\tcache.set( style, css );\r\n\t\t}\r\n\t\treturn css;\r\n\t} );\r\n};\r\n\r\nexport default transformStyles;\r\n"],"mappings":"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","ignoreList":[]}