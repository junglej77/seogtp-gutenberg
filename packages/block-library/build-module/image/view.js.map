{"version":3,"names":["store","getContext","getElement","isTouching","lastTouchTime","state","actions","callbacks","currentImageId","currentImage","metadata","overlayOpened","roleAttribute","ariaModal","enlargedSrc","uploadedSrc","figureStyles","replace","imgStyles","imageButtonRight","imageId","imageButtonTop","isContentHidden","ctx","overlayEnabled","isContentVisible","showLightbox","imageRef","complete","scrollTopReset","document","documentElement","scrollTop","scrollLeftReset","scrollLeft","setOverlayStyles","hideLightbox","showClosingAnimation","setTimeout","buttonRef","focus","preventScroll","handleKeydown","event","key","preventDefault","ref","querySelector","handleTouchMove","handleTouchStart","handleTouchEnd","Date","now","handleScroll","window","scrollTo","naturalWidth","naturalHeight","offsetWidth","originalWidth","offsetHeight","originalHeight","x","screenPosX","y","screenPosY","getBoundingClientRect","naturalRatio","originalRatio","scaleAttr","heightWithoutSpace","widthWithoutSpace","imgMaxWidth","parseFloat","targetWidth","imgMaxHeight","targetHeight","imgRatio","containerMaxWidth","containerMaxHeight","containerWidth","containerHeight","toFixed","reducedHeight","reducedWidth","horizontalPadding","innerWidth","verticalPadding","targetMaxWidth","Math","min","targetMaxHeight","innerHeight","targetContainerRatio","containerScale","lightboxImgWidth","lightboxImgHeight","overlayStyles","clientWidth","setButtonStyles","currentSrc","figure","parentElement","figureWidth","figureHeight","clientHeight","caption","captionComputedStyle","getComputedStyle","includes","position","marginTop","marginBottom","buttonOffsetTop","buttonOffsetRight","offsetRatio","referenceHeight","referenceWidth","setOverlayFocus","initTriggerButton","lock"],"sources":["@wordpress/block-library/src/image/view.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { store, getContext, getElement } from '@wordpress/interactivity';\r\n\r\n/**\r\n * Tracks whether user is touching screen; used to differentiate behavior for\r\n * touch and mouse input.\r\n *\r\n * @type {boolean}\r\n */\r\nlet isTouching = false;\r\n\r\n/**\r\n * Tracks the last time the screen was touched; used to differentiate behavior\r\n * for touch and mouse input.\r\n *\r\n * @type {number}\r\n */\r\nlet lastTouchTime = 0;\r\n\r\nconst { state, actions, callbacks } = store(\r\n\t'core/image',\r\n\t{\r\n\t\tstate: {\r\n\t\t\tcurrentImageId: null,\r\n\t\t\tget currentImage() {\r\n\t\t\t\treturn state.metadata[ state.currentImageId ];\r\n\t\t\t},\r\n\t\t\tget overlayOpened() {\r\n\t\t\t\treturn state.currentImageId !== null;\r\n\t\t\t},\r\n\t\t\tget roleAttribute() {\r\n\t\t\t\treturn state.overlayOpened ? 'dialog' : null;\r\n\t\t\t},\r\n\t\t\tget ariaModal() {\r\n\t\t\t\treturn state.overlayOpened ? 'true' : null;\r\n\t\t\t},\r\n\t\t\tget enlargedSrc() {\r\n\t\t\t\treturn (\r\n\t\t\t\t\tstate.currentImage.uploadedSrc ||\r\n\t\t\t\t\t'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='\r\n\t\t\t\t);\r\n\t\t\t},\r\n\t\t\tget figureStyles() {\r\n\t\t\t\treturn (\r\n\t\t\t\t\tstate.overlayOpened &&\r\n\t\t\t\t\t`${ state.currentImage.figureStyles?.replace(\r\n\t\t\t\t\t\t/margin[^;]*;?/g,\r\n\t\t\t\t\t\t''\r\n\t\t\t\t\t) };`\r\n\t\t\t\t);\r\n\t\t\t},\r\n\t\t\tget imgStyles() {\r\n\t\t\t\treturn (\r\n\t\t\t\t\tstate.overlayOpened &&\r\n\t\t\t\t\t`${ state.currentImage.imgStyles?.replace(\r\n\t\t\t\t\t\t/;$/,\r\n\t\t\t\t\t\t''\r\n\t\t\t\t\t) }; object-fit:cover;`\r\n\t\t\t\t);\r\n\t\t\t},\r\n\t\t\tget imageButtonRight() {\r\n\t\t\t\tconst { imageId } = getContext();\r\n\t\t\t\treturn state.metadata[ imageId ].imageButtonRight;\r\n\t\t\t},\r\n\t\t\tget imageButtonTop() {\r\n\t\t\t\tconst { imageId } = getContext();\r\n\t\t\t\treturn state.metadata[ imageId ].imageButtonTop;\r\n\t\t\t},\r\n\t\t\tget isContentHidden() {\r\n\t\t\t\tconst ctx = getContext();\r\n\t\t\t\treturn (\r\n\t\t\t\t\tstate.overlayEnabled && state.currentImageId === ctx.imageId\r\n\t\t\t\t);\r\n\t\t\t},\r\n\t\t\tget isContentVisible() {\r\n\t\t\t\tconst ctx = getContext();\r\n\t\t\t\treturn (\r\n\t\t\t\t\t! state.overlayEnabled &&\r\n\t\t\t\t\tstate.currentImageId === ctx.imageId\r\n\t\t\t\t);\r\n\t\t\t},\r\n\t\t},\r\n\t\tactions: {\r\n\t\t\tshowLightbox() {\r\n\t\t\t\tconst { imageId } = getContext();\r\n\r\n\t\t\t\t// Bails out if the image has not loaded yet.\r\n\t\t\t\tif ( ! state.metadata[ imageId ].imageRef?.complete ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Stores the positions of the scroll to fix it until the overlay is\r\n\t\t\t\t// closed.\r\n\t\t\t\tstate.scrollTopReset = document.documentElement.scrollTop;\r\n\t\t\t\tstate.scrollLeftReset = document.documentElement.scrollLeft;\r\n\r\n\t\t\t\t// Sets the current expanded image in the state and enables the overlay.\r\n\t\t\t\tstate.overlayEnabled = true;\r\n\t\t\t\tstate.currentImageId = imageId;\r\n\r\n\t\t\t\t// Computes the styles of the overlay for the animation.\r\n\t\t\t\tcallbacks.setOverlayStyles();\r\n\t\t\t},\r\n\t\t\thideLightbox() {\r\n\t\t\t\tif ( state.overlayEnabled ) {\r\n\t\t\t\t\t// Starts the overlay closing animation. The showClosingAnimation\r\n\t\t\t\t\t// class is used to avoid showing it on page load.\r\n\t\t\t\t\tstate.showClosingAnimation = true;\r\n\t\t\t\t\tstate.overlayEnabled = false;\r\n\r\n\t\t\t\t\t// Waits until the close animation has completed before allowing a\r\n\t\t\t\t\t// user to scroll again. The duration of this animation is defined in\r\n\t\t\t\t\t// the `styles.scss` file, but in any case we should wait a few\r\n\t\t\t\t\t// milliseconds longer than the duration, otherwise a user may scroll\r\n\t\t\t\t\t// too soon and cause the animation to look sloppy.\r\n\t\t\t\t\tsetTimeout( function () {\r\n\t\t\t\t\t\t// Delays before changing the focus. Otherwise the focus ring will\r\n\t\t\t\t\t\t// appear on Firefox before the image has finished animating, which\r\n\t\t\t\t\t\t// looks broken.\r\n\t\t\t\t\t\tstate.currentImage.buttonRef.focus( {\r\n\t\t\t\t\t\t\tpreventScroll: true,\r\n\t\t\t\t\t\t} );\r\n\r\n\t\t\t\t\t\t// Resets the current image id to mark the overlay as closed.\r\n\t\t\t\t\t\tstate.currentImageId = null;\r\n\t\t\t\t\t}, 450 );\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\thandleKeydown( event ) {\r\n\t\t\t\tif ( state.overlayEnabled ) {\r\n\t\t\t\t\t// Focuses the close button when the user presses the tab key.\r\n\t\t\t\t\tif ( event.key === 'Tab' ) {\r\n\t\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t\tconst { ref } = getElement();\r\n\t\t\t\t\t\tref.querySelector( 'button' ).focus();\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// Closes the lightbox when the user presses the escape key.\r\n\t\t\t\t\tif ( event.key === 'Escape' ) {\r\n\t\t\t\t\t\tactions.hideLightbox();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\thandleTouchMove( event ) {\r\n\t\t\t\t// On mobile devices, prevents triggering the scroll event because\r\n\t\t\t\t// otherwise the page jumps around when it resets the scroll position.\r\n\t\t\t\t// This also means that closing the lightbox requires that a user\r\n\t\t\t\t// perform a simple tap. This may be changed in the future if there is a\r\n\t\t\t\t// better alternative to override or reset the scroll position during\r\n\t\t\t\t// swipe actions.\r\n\t\t\t\tif ( state.overlayEnabled ) {\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\thandleTouchStart() {\r\n\t\t\t\tisTouching = true;\r\n\t\t\t},\r\n\t\t\thandleTouchEnd() {\r\n\t\t\t\t// Waits a few milliseconds before resetting to ensure that pinch to\r\n\t\t\t\t// zoom works consistently on mobile devices when the lightbox is open.\r\n\t\t\t\tlastTouchTime = Date.now();\r\n\t\t\t\tisTouching = false;\r\n\t\t\t},\r\n\t\t\thandleScroll() {\r\n\t\t\t\t// Prevents scrolling behaviors that trigger content shift while the\r\n\t\t\t\t// lightbox is open. It would be better to accomplish through CSS alone,\r\n\t\t\t\t// but using overflow: hidden is currently the only way to do so and\r\n\t\t\t\t// that causes a layout to shift and prevents the zoom animation from\r\n\t\t\t\t// working in some cases because it's not possible to account for the\r\n\t\t\t\t// layout shift when doing the animation calculations. Instead, it uses\r\n\t\t\t\t// JavaScript to prevent and reset the scrolling behavior.\r\n\t\t\t\tif ( state.overlayOpened ) {\r\n\t\t\t\t\t// Avoids overriding the scroll behavior on mobile devices because\r\n\t\t\t\t\t// doing so breaks the pinch to zoom functionality, and users should\r\n\t\t\t\t\t// be able to zoom in further on the high-res image.\r\n\t\t\t\t\tif ( ! isTouching && Date.now() - lastTouchTime > 450 ) {\r\n\t\t\t\t\t\t// It doesn't rely on `event.preventDefault()` to prevent scrolling\r\n\t\t\t\t\t\t// because the scroll event can't be canceled, so it resets the\r\n\t\t\t\t\t\t// position instead.\r\n\t\t\t\t\t\twindow.scrollTo(\r\n\t\t\t\t\t\t\tstate.scrollLeftReset,\r\n\t\t\t\t\t\t\tstate.scrollTopReset\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t},\r\n\t\tcallbacks: {\r\n\t\t\tsetOverlayStyles() {\r\n\t\t\t\tif ( ! state.overlayEnabled ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet {\r\n\t\t\t\t\tnaturalWidth,\r\n\t\t\t\t\tnaturalHeight,\r\n\t\t\t\t\toffsetWidth: originalWidth,\r\n\t\t\t\t\toffsetHeight: originalHeight,\r\n\t\t\t\t} = state.currentImage.imageRef;\r\n\t\t\t\tlet { x: screenPosX, y: screenPosY } =\r\n\t\t\t\t\tstate.currentImage.imageRef.getBoundingClientRect();\r\n\r\n\t\t\t\t// Natural ratio of the image clicked to open the lightbox.\r\n\t\t\t\tconst naturalRatio = naturalWidth / naturalHeight;\r\n\t\t\t\t// Original ratio of the image clicked to open the lightbox.\r\n\t\t\t\tlet originalRatio = originalWidth / originalHeight;\r\n\r\n\t\t\t\t// If it has object-fit: contain, recalculates the original sizes\r\n\t\t\t\t// and the screen position without the blank spaces.\r\n\t\t\t\tif ( state.currentImage.scaleAttr === 'contain' ) {\r\n\t\t\t\t\tif ( naturalRatio > originalRatio ) {\r\n\t\t\t\t\t\tconst heightWithoutSpace = originalWidth / naturalRatio;\r\n\t\t\t\t\t\t// Recalculates screen position without the top space.\r\n\t\t\t\t\t\tscreenPosY +=\r\n\t\t\t\t\t\t\t( originalHeight - heightWithoutSpace ) / 2;\r\n\t\t\t\t\t\toriginalHeight = heightWithoutSpace;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst widthWithoutSpace = originalHeight * naturalRatio;\r\n\t\t\t\t\t\t// Recalculates screen position without the left space.\r\n\t\t\t\t\t\tscreenPosX += ( originalWidth - widthWithoutSpace ) / 2;\r\n\t\t\t\t\t\toriginalWidth = widthWithoutSpace;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\toriginalRatio = originalWidth / originalHeight;\r\n\r\n\t\t\t\t// Typically, it uses the image's full-sized dimensions. If those\r\n\t\t\t\t// dimensions have not been set (i.e. an external image with only one\r\n\t\t\t\t// size), the image's dimensions in the lightbox are the same\r\n\t\t\t\t// as those of the image in the content.\r\n\t\t\t\tlet imgMaxWidth = parseFloat(\r\n\t\t\t\t\tstate.currentImage.targetWidth !== 'none'\r\n\t\t\t\t\t\t? state.currentImage.targetWidth\r\n\t\t\t\t\t\t: naturalWidth\r\n\t\t\t\t);\r\n\t\t\t\tlet imgMaxHeight = parseFloat(\r\n\t\t\t\t\tstate.currentImage.targetHeight !== 'none'\r\n\t\t\t\t\t\t? state.currentImage.targetHeight\r\n\t\t\t\t\t\t: naturalHeight\r\n\t\t\t\t);\r\n\r\n\t\t\t\t// Ratio of the biggest image stored in the database.\r\n\t\t\t\tlet imgRatio = imgMaxWidth / imgMaxHeight;\r\n\t\t\t\tlet containerMaxWidth = imgMaxWidth;\r\n\t\t\t\tlet containerMaxHeight = imgMaxHeight;\r\n\t\t\t\tlet containerWidth = imgMaxWidth;\r\n\t\t\t\tlet containerHeight = imgMaxHeight;\r\n\r\n\t\t\t\t// Checks if the target image has a different ratio than the original\r\n\t\t\t\t// one (thumbnail). Recalculates the width and height.\r\n\t\t\t\tif ( naturalRatio.toFixed( 2 ) !== imgRatio.toFixed( 2 ) ) {\r\n\t\t\t\t\tif ( naturalRatio > imgRatio ) {\r\n\t\t\t\t\t\t// If the width is reached before the height, it keeps the maxWidth\r\n\t\t\t\t\t\t// and recalculates the height unless the difference between the\r\n\t\t\t\t\t\t// maxHeight and the reducedHeight is higher than the maxWidth,\r\n\t\t\t\t\t\t// where it keeps the reducedHeight and recalculate the width.\r\n\t\t\t\t\t\tconst reducedHeight = imgMaxWidth / naturalRatio;\r\n\t\t\t\t\t\tif ( imgMaxHeight - reducedHeight > imgMaxWidth ) {\r\n\t\t\t\t\t\t\timgMaxHeight = reducedHeight;\r\n\t\t\t\t\t\t\timgMaxWidth = reducedHeight * naturalRatio;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\timgMaxHeight = imgMaxWidth / naturalRatio;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// If the height is reached before the width, it keeps the maxHeight\r\n\t\t\t\t\t\t// and recalculate the width unlesss the difference between the\r\n\t\t\t\t\t\t// maxWidth and the reducedWidth is higher than the maxHeight, where\r\n\t\t\t\t\t\t// it keeps the reducedWidth and recalculate the height.\r\n\t\t\t\t\t\tconst reducedWidth = imgMaxHeight * naturalRatio;\r\n\t\t\t\t\t\tif ( imgMaxWidth - reducedWidth > imgMaxHeight ) {\r\n\t\t\t\t\t\t\timgMaxWidth = reducedWidth;\r\n\t\t\t\t\t\t\timgMaxHeight = reducedWidth / naturalRatio;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\timgMaxWidth = imgMaxHeight * naturalRatio;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcontainerWidth = imgMaxWidth;\r\n\t\t\t\t\tcontainerHeight = imgMaxHeight;\r\n\t\t\t\t\timgRatio = imgMaxWidth / imgMaxHeight;\r\n\r\n\t\t\t\t\t// Calculates the max size of the container.\r\n\t\t\t\t\tif ( originalRatio > imgRatio ) {\r\n\t\t\t\t\t\tcontainerMaxWidth = imgMaxWidth;\r\n\t\t\t\t\t\tcontainerMaxHeight = containerMaxWidth / originalRatio;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tcontainerMaxHeight = imgMaxHeight;\r\n\t\t\t\t\t\tcontainerMaxWidth = containerMaxHeight * originalRatio;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// If the image has been pixelated on purpose, it keeps that size.\r\n\t\t\t\tif (\r\n\t\t\t\t\toriginalWidth > containerWidth ||\r\n\t\t\t\t\toriginalHeight > containerHeight\r\n\t\t\t\t) {\r\n\t\t\t\t\tcontainerWidth = originalWidth;\r\n\t\t\t\t\tcontainerHeight = originalHeight;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Calculates the final lightbox image size and the scale factor.\r\n\t\t\t\t// MaxWidth is either the window container (accounting for padding) or\r\n\t\t\t\t// the image resolution.\r\n\t\t\t\tlet horizontalPadding = 0;\r\n\t\t\t\tif ( window.innerWidth > 480 ) {\r\n\t\t\t\t\thorizontalPadding = 80;\r\n\t\t\t\t} else if ( window.innerWidth > 1920 ) {\r\n\t\t\t\t\thorizontalPadding = 160;\r\n\t\t\t\t}\r\n\t\t\t\tconst verticalPadding = 80;\r\n\r\n\t\t\t\tconst targetMaxWidth = Math.min(\r\n\t\t\t\t\twindow.innerWidth - horizontalPadding,\r\n\t\t\t\t\tcontainerWidth\r\n\t\t\t\t);\r\n\t\t\t\tconst targetMaxHeight = Math.min(\r\n\t\t\t\t\twindow.innerHeight - verticalPadding,\r\n\t\t\t\t\tcontainerHeight\r\n\t\t\t\t);\r\n\t\t\t\tconst targetContainerRatio = targetMaxWidth / targetMaxHeight;\r\n\r\n\t\t\t\tif ( originalRatio > targetContainerRatio ) {\r\n\t\t\t\t\t// If targetMaxWidth is reached before targetMaxHeight.\r\n\t\t\t\t\tcontainerWidth = targetMaxWidth;\r\n\t\t\t\t\tcontainerHeight = containerWidth / originalRatio;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// If targetMaxHeight is reached before targetMaxWidth.\r\n\t\t\t\t\tcontainerHeight = targetMaxHeight;\r\n\t\t\t\t\tcontainerWidth = containerHeight * originalRatio;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst containerScale = originalWidth / containerWidth;\r\n\t\t\t\tconst lightboxImgWidth =\r\n\t\t\t\t\timgMaxWidth * ( containerWidth / containerMaxWidth );\r\n\t\t\t\tconst lightboxImgHeight =\r\n\t\t\t\t\timgMaxHeight * ( containerHeight / containerMaxHeight );\r\n\r\n\t\t\t\t// As of this writing, using the calculations above will render the\r\n\t\t\t\t// lightbox with a small, erroneous whitespace on the left side of the\r\n\t\t\t\t// image in iOS Safari, perhaps due to an inconsistency in how browsers\r\n\t\t\t\t// handle absolute positioning and CSS transformation. In any case,\r\n\t\t\t\t// adding 1 pixel to the container width and height solves the problem,\r\n\t\t\t\t// though this can be removed if the issue is fixed in the future.\r\n\t\t\t\tstate.overlayStyles = `\r\n\t\t\t\t:root {\r\n\t\t\t\t\t--wp--lightbox-initial-top-position: ${ screenPosY }px;\r\n\t\t\t\t\t--wp--lightbox-initial-left-position: ${ screenPosX }px;\r\n\t\t\t\t\t--wp--lightbox-container-width: ${ containerWidth + 1 }px;\r\n\t\t\t\t\t--wp--lightbox-container-height: ${ containerHeight + 1 }px;\r\n\t\t\t\t\t--wp--lightbox-image-width: ${ lightboxImgWidth }px;\r\n\t\t\t\t\t--wp--lightbox-image-height: ${ lightboxImgHeight }px;\r\n\t\t\t\t\t--wp--lightbox-scale: ${ containerScale };\r\n\t\t\t\t\t--wp--lightbox-scrollbar-width: ${\r\n\t\t\t\t\t\twindow.innerWidth - document.documentElement.clientWidth\r\n\t\t\t\t\t}px;\r\n\t\t\t\t}\r\n\t\t\t`;\r\n\t\t\t},\r\n\t\t\tsetButtonStyles() {\r\n\t\t\t\tconst { imageId } = getContext();\r\n\t\t\t\tconst { ref } = getElement();\r\n\r\n\t\t\t\tstate.metadata[ imageId ].imageRef = ref;\r\n\t\t\t\tstate.metadata[ imageId ].currentSrc = ref.currentSrc;\r\n\r\n\t\t\t\tconst {\r\n\t\t\t\t\tnaturalWidth,\r\n\t\t\t\t\tnaturalHeight,\r\n\t\t\t\t\toffsetWidth,\r\n\t\t\t\t\toffsetHeight,\r\n\t\t\t\t} = ref;\r\n\r\n\t\t\t\t// If the image isn't loaded yet, it can't calculate where the button\r\n\t\t\t\t// should be.\r\n\t\t\t\tif ( naturalWidth === 0 || naturalHeight === 0 ) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst figure = ref.parentElement;\r\n\t\t\t\tconst figureWidth = ref.parentElement.clientWidth;\r\n\r\n\t\t\t\t// It needs special handling for the height because a caption will cause\r\n\t\t\t\t// the figure to be taller than the image, which means it needs to\r\n\t\t\t\t// account for that when calculating the placement of the button in the\r\n\t\t\t\t// top right corner of the image.\r\n\t\t\t\tlet figureHeight = ref.parentElement.clientHeight;\r\n\t\t\t\tconst caption = figure.querySelector( 'figcaption' );\r\n\t\t\t\tif ( caption ) {\r\n\t\t\t\t\tconst captionComputedStyle =\r\n\t\t\t\t\t\twindow.getComputedStyle( caption );\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\t! [ 'absolute', 'fixed' ].includes(\r\n\t\t\t\t\t\t\tcaptionComputedStyle.position\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\tfigureHeight =\r\n\t\t\t\t\t\t\tfigureHeight -\r\n\t\t\t\t\t\t\tcaption.offsetHeight -\r\n\t\t\t\t\t\t\tparseFloat( captionComputedStyle.marginTop ) -\r\n\t\t\t\t\t\t\tparseFloat( captionComputedStyle.marginBottom );\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst buttonOffsetTop = figureHeight - offsetHeight;\r\n\t\t\t\tconst buttonOffsetRight = figureWidth - offsetWidth;\r\n\r\n\t\t\t\tlet imageButtonTop = buttonOffsetTop + 16;\r\n\t\t\t\tlet imageButtonRight = buttonOffsetRight + 16;\r\n\r\n\t\t\t\t// In the case of an image with object-fit: contain, the size of the\r\n\t\t\t\t// <img> element can be larger than the image itself, so it needs to\r\n\t\t\t\t// calculate where to place the button.\r\n\t\t\t\tif ( state.metadata[ imageId ].scaleAttr === 'contain' ) {\r\n\t\t\t\t\t// Natural ratio of the image.\r\n\t\t\t\t\tconst naturalRatio = naturalWidth / naturalHeight;\r\n\t\t\t\t\t// Offset ratio of the image.\r\n\t\t\t\t\tconst offsetRatio = offsetWidth / offsetHeight;\r\n\r\n\t\t\t\t\tif ( naturalRatio >= offsetRatio ) {\r\n\t\t\t\t\t\t// If it reaches the width first, it keeps the width and compute the\r\n\t\t\t\t\t\t// height.\r\n\t\t\t\t\t\tconst referenceHeight = offsetWidth / naturalRatio;\r\n\t\t\t\t\t\timageButtonTop =\r\n\t\t\t\t\t\t\t( offsetHeight - referenceHeight ) / 2 +\r\n\t\t\t\t\t\t\tbuttonOffsetTop +\r\n\t\t\t\t\t\t\t16;\r\n\t\t\t\t\t\timageButtonRight = buttonOffsetRight + 16;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// If it reaches the height first, it keeps the height and compute\r\n\t\t\t\t\t\t// the width.\r\n\t\t\t\t\t\tconst referenceWidth = offsetHeight * naturalRatio;\r\n\t\t\t\t\t\timageButtonTop = buttonOffsetTop + 16;\r\n\t\t\t\t\t\timageButtonRight =\r\n\t\t\t\t\t\t\t( offsetWidth - referenceWidth ) / 2 +\r\n\t\t\t\t\t\t\tbuttonOffsetRight +\r\n\t\t\t\t\t\t\t16;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tstate.metadata[ imageId ].imageButtonTop = imageButtonTop;\r\n\t\t\t\tstate.metadata[ imageId ].imageButtonRight = imageButtonRight;\r\n\t\t\t},\r\n\t\t\tsetOverlayFocus() {\r\n\t\t\t\tif ( state.overlayEnabled ) {\r\n\t\t\t\t\t// Moves the focus to the dialog when it opens.\r\n\t\t\t\t\tconst { ref } = getElement();\r\n\t\t\t\t\tref.focus();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tinitTriggerButton() {\r\n\t\t\t\tconst { imageId } = getContext();\r\n\t\t\t\tconst { ref } = getElement();\r\n\t\t\t\tstate.metadata[ imageId ].buttonRef = ref;\r\n\t\t\t},\r\n\t\t},\r\n\t},\r\n\t{ lock: true }\r\n);\r\n"],"mappings":"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","ignoreList":[]}