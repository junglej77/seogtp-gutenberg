{"version":3,"names":["FormTokenField","__experimentalVStack","VStack","useSelect","store","coreStore","useState","useEffect","useDebounce","decodeEntities","useTaxonomies","jsx","_jsx","EMPTY_ARRAY","BASE_QUERY","order","_fields","context","getTermIdByTermValue","terms","termValue","termId","id","find","term","name","termValueLower","toLocaleLowerCase","TaxonomyControls","onChange","query","postType","taxQuery","taxonomies","length","spacing","children","map","taxonomy","termIds","slug","handleChange","newTermIds","TaxonomyItem","search","setSearch","value","setValue","suggestions","setSuggestions","debouncedSearch","searchResults","searchHasResolved","select","getEntityRecords","hasFinishedResolution","selectorArgs","orderby","exclude","per_page","existingTerms","include","sanitizedValue","reduce","accumulator","entity","push","result","onTermsChange","newTermValues","Set","add","Array","from","className","label","onInputChange","displayTransform","__experimentalShowHowTo","__nextHasNoMarginBottom","__next40pxDefaultSize"],"sources":["@wordpress/block-library/src/query/edit/inspector-controls/taxonomy-controls.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport {\r\n\tFormTokenField,\r\n\t__experimentalVStack as VStack,\r\n} from '@wordpress/components';\r\nimport { useSelect } from '@wordpress/data';\r\nimport { store as coreStore } from '@wordpress/core-data';\r\nimport { useState, useEffect } from '@wordpress/element';\r\nimport { useDebounce } from '@wordpress/compose';\r\nimport { decodeEntities } from '@wordpress/html-entities';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { useTaxonomies } from '../../utils';\r\n\r\nconst EMPTY_ARRAY = [];\r\nconst BASE_QUERY = {\r\n\torder: 'asc',\r\n\t_fields: 'id,name',\r\n\tcontext: 'view',\r\n};\r\n\r\n// Helper function to get the term id based on user input in terms `FormTokenField`.\r\nconst getTermIdByTermValue = ( terms, termValue ) => {\r\n\t// First we check for exact match by `term.id` or case sensitive `term.name` match.\r\n\tconst termId =\r\n\t\ttermValue?.id || terms?.find( ( term ) => term.name === termValue )?.id;\r\n\tif ( termId ) {\r\n\t\treturn termId;\r\n\t}\r\n\r\n\t/**\r\n\t * Here we make an extra check for entered terms in a non case sensitive way,\r\n\t * to match user expectations, due to `FormTokenField` behaviour that shows\r\n\t * suggestions which are case insensitive.\r\n\t *\r\n\t * Although WP tries to discourage users to add terms with the same name (case insensitive),\r\n\t * it's still possible if you manually change the name, as long as the terms have different slugs.\r\n\t * In this edge case we always apply the first match from the terms list.\r\n\t */\r\n\tconst termValueLower = termValue.toLocaleLowerCase();\r\n\treturn terms?.find(\r\n\t\t( term ) => term.name.toLocaleLowerCase() === termValueLower\r\n\t)?.id;\r\n};\r\n\r\nexport function TaxonomyControls( { onChange, query } ) {\r\n\tconst { postType, taxQuery } = query;\r\n\r\n\tconst taxonomies = useTaxonomies( postType );\r\n\tif ( ! taxonomies || taxonomies.length === 0 ) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\treturn (\r\n\t\t<VStack spacing={ 4 }>\r\n\t\t\t{ taxonomies.map( ( taxonomy ) => {\r\n\t\t\t\tconst termIds = taxQuery?.[ taxonomy.slug ] || [];\r\n\t\t\t\tconst handleChange = ( newTermIds ) =>\r\n\t\t\t\t\tonChange( {\r\n\t\t\t\t\t\ttaxQuery: {\r\n\t\t\t\t\t\t\t...taxQuery,\r\n\t\t\t\t\t\t\t[ taxonomy.slug ]: newTermIds,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t} );\r\n\r\n\t\t\t\treturn (\r\n\t\t\t\t\t<TaxonomyItem\r\n\t\t\t\t\t\tkey={ taxonomy.slug }\r\n\t\t\t\t\t\ttaxonomy={ taxonomy }\r\n\t\t\t\t\t\ttermIds={ termIds }\r\n\t\t\t\t\t\tonChange={ handleChange }\r\n\t\t\t\t\t/>\r\n\t\t\t\t);\r\n\t\t\t} ) }\r\n\t\t</VStack>\r\n\t);\r\n}\r\n\r\n/**\r\n * Renders a `FormTokenField` for a given taxonomy.\r\n *\r\n * @param {Object}   props          The props for the component.\r\n * @param {Object}   props.taxonomy The taxonomy object.\r\n * @param {number[]} props.termIds  An array with the block's term ids for the given taxonomy.\r\n * @param {Function} props.onChange Callback `onChange` function.\r\n * @return {JSX.Element} The rendered component.\r\n */\r\nfunction TaxonomyItem( { taxonomy, termIds, onChange } ) {\r\n\tconst [ search, setSearch ] = useState( '' );\r\n\tconst [ value, setValue ] = useState( EMPTY_ARRAY );\r\n\tconst [ suggestions, setSuggestions ] = useState( EMPTY_ARRAY );\r\n\tconst debouncedSearch = useDebounce( setSearch, 250 );\r\n\tconst { searchResults, searchHasResolved } = useSelect(\r\n\t\t( select ) => {\r\n\t\t\tif ( ! search ) {\r\n\t\t\t\treturn { searchResults: EMPTY_ARRAY, searchHasResolved: true };\r\n\t\t\t}\r\n\t\t\tconst { getEntityRecords, hasFinishedResolution } =\r\n\t\t\t\tselect( coreStore );\r\n\t\t\tconst selectorArgs = [\r\n\t\t\t\t'taxonomy',\r\n\t\t\t\ttaxonomy.slug,\r\n\t\t\t\t{\r\n\t\t\t\t\t...BASE_QUERY,\r\n\t\t\t\t\tsearch,\r\n\t\t\t\t\torderby: 'name',\r\n\t\t\t\t\texclude: termIds,\r\n\t\t\t\t\tper_page: 20,\r\n\t\t\t\t},\r\n\t\t\t];\r\n\t\t\treturn {\r\n\t\t\t\tsearchResults: getEntityRecords( ...selectorArgs ),\r\n\t\t\t\tsearchHasResolved: hasFinishedResolution(\r\n\t\t\t\t\t'getEntityRecords',\r\n\t\t\t\t\tselectorArgs\r\n\t\t\t\t),\r\n\t\t\t};\r\n\t\t},\r\n\t\t[ search, termIds ]\r\n\t);\r\n\t// `existingTerms` are the ones fetched from the API and their type is `{ id: number; name: string }`.\r\n\t// They are used to extract the terms' names to populate the `FormTokenField` properly\r\n\t// and to sanitize the provided `termIds`, by setting only the ones that exist.\r\n\tconst existingTerms = useSelect(\r\n\t\t( select ) => {\r\n\t\t\tif ( ! termIds?.length ) {\r\n\t\t\t\treturn EMPTY_ARRAY;\r\n\t\t\t}\r\n\t\t\tconst { getEntityRecords } = select( coreStore );\r\n\t\t\treturn getEntityRecords( 'taxonomy', taxonomy.slug, {\r\n\t\t\t\t...BASE_QUERY,\r\n\t\t\t\tinclude: termIds,\r\n\t\t\t\tper_page: termIds.length,\r\n\t\t\t} );\r\n\t\t},\r\n\t\t[ termIds ]\r\n\t);\r\n\t// Update the `value` state only after the selectors are resolved\r\n\t// to avoid emptying the input when we're changing terms.\r\n\tuseEffect( () => {\r\n\t\tif ( ! termIds?.length ) {\r\n\t\t\tsetValue( EMPTY_ARRAY );\r\n\t\t}\r\n\t\tif ( ! existingTerms?.length ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// Returns only the existing entity ids. This prevents the component\r\n\t\t// from crashing in the editor, when non existing ids are provided.\r\n\t\tconst sanitizedValue = termIds.reduce( ( accumulator, id ) => {\r\n\t\t\tconst entity = existingTerms.find( ( term ) => term.id === id );\r\n\t\t\tif ( entity ) {\r\n\t\t\t\taccumulator.push( {\r\n\t\t\t\t\tid,\r\n\t\t\t\t\tvalue: entity.name,\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\t\t\treturn accumulator;\r\n\t\t}, [] );\r\n\t\tsetValue( sanitizedValue );\r\n\t}, [ termIds, existingTerms ] );\r\n\t// Update suggestions only when the query has resolved.\r\n\tuseEffect( () => {\r\n\t\tif ( ! searchHasResolved ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsetSuggestions( searchResults.map( ( result ) => result.name ) );\r\n\t}, [ searchResults, searchHasResolved ] );\r\n\tconst onTermsChange = ( newTermValues ) => {\r\n\t\tconst newTermIds = new Set();\r\n\t\tfor ( const termValue of newTermValues ) {\r\n\t\t\tconst termId = getTermIdByTermValue( searchResults, termValue );\r\n\t\t\tif ( termId ) {\r\n\t\t\t\tnewTermIds.add( termId );\r\n\t\t\t}\r\n\t\t}\r\n\t\tsetSuggestions( EMPTY_ARRAY );\r\n\t\tonChange( Array.from( newTermIds ) );\r\n\t};\r\n\treturn (\r\n\t\t<div className=\"block-library-query-inspector__taxonomy-control\">\r\n\t\t\t<FormTokenField\r\n\t\t\t\tlabel={ taxonomy.name }\r\n\t\t\t\tvalue={ value }\r\n\t\t\t\tonInputChange={ debouncedSearch }\r\n\t\t\t\tsuggestions={ suggestions }\r\n\t\t\t\tdisplayTransform={ decodeEntities }\r\n\t\t\t\tonChange={ onTermsChange }\r\n\t\t\t\t__experimentalShowHowTo={ false }\r\n\t\t\t\t__nextHasNoMarginBottom\r\n\t\t\t\t__next40pxDefaultSize\r\n\t\t\t/>\r\n\t\t</div>\r\n\t);\r\n}\r\n"],"mappings":"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","ignoreList":[]}