{"version":3,"names":["ActivityIndicator","FlatList","View","debounce","useState","useEffect","useRef","useSelect","styles","BottomSheet","BottomSheetConsumer","jsx","_jsx","PER_PAGE","REQUEST_DEBOUNCE_DELAY","MINIMUM_QUERY_SIZE","meetsThreshold","query","length","LinkPickerResults","onLinkPicked","directEntry","links","setLinks","hasAllSuggestions","setHasAllSuggestions","nextPage","pendingRequest","clearRequest","current","fetchMoreSuggestions","select","getSettings","fetchLinkSuggestions","search","__experimentalFetchLinkSuggestions","page","type","perPage","fetchMore","currentSuggestions","request","suggestions","onEndReached","spinner","style","testID","children","animating","listProps","data","keyboardShouldPersistTaps","renderItem","item","LinkSuggestionItemCell","suggestion","keyExtractor","url","onEndReachedThreshold","initialNumToRender","ListFooterComponent","contentContainerStyle","list"],"sources":["@wordpress/components/src/mobile/link-picker/link-picker-results.native.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport { ActivityIndicator, FlatList, View } from 'react-native';\r\n\r\n/**\r\n * WordPress dependencies\r\n */\r\nimport { debounce } from '@wordpress/compose';\r\nimport { useState, useEffect, useRef } from '@wordpress/element';\r\nimport { useSelect } from '@wordpress/data';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport styles from './styles.scss';\r\nimport BottomSheet from '../bottom-sheet';\r\nimport { BottomSheetConsumer } from '../bottom-sheet/bottom-sheet-context';\r\n\r\nconst PER_PAGE = 20;\r\nconst REQUEST_DEBOUNCE_DELAY = 400;\r\nconst MINIMUM_QUERY_SIZE = 2;\r\nconst meetsThreshold = ( query ) => MINIMUM_QUERY_SIZE <= query.length;\r\n\r\nexport default function LinkPickerResults( {\r\n\tquery,\r\n\tonLinkPicked,\r\n\tdirectEntry,\r\n} ) {\r\n\tconst [ links, setLinks ] = useState( [ directEntry ] );\r\n\tconst [ hasAllSuggestions, setHasAllSuggestions ] = useState( false );\r\n\tconst nextPage = useRef( 1 );\r\n\tconst pendingRequest = useRef();\r\n\tconst clearRequest = () => {\r\n\t\tpendingRequest.current = null;\r\n\t};\r\n\r\n\t// A stable debounced function to fetch suggestions and append.\r\n\tconst { fetchMoreSuggestions } = useSelect( ( select ) => {\r\n\t\tconst { getSettings } = select( 'core/block-editor' );\r\n\t\tconst fetchLinkSuggestions = async ( { search } ) => {\r\n\t\t\tif ( meetsThreshold( search ) ) {\r\n\t\t\t\treturn await getSettings().__experimentalFetchLinkSuggestions(\r\n\t\t\t\t\tsearch,\r\n\t\t\t\t\t{ page: nextPage.current, type: 'post', perPage: PER_PAGE }\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t};\r\n\t\tconst fetchMore = async ( {\r\n\t\t\tquery: search,\r\n\t\t\tlinks: currentSuggestions,\r\n\t\t} ) => {\r\n\t\t\t// Return early if we've already detected the end of data or we are\r\n\t\t\t// already awaiting a response.\r\n\t\t\tif ( hasAllSuggestions || pendingRequest.current ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst request = fetchLinkSuggestions( { search } );\r\n\t\t\tpendingRequest.current = request;\r\n\t\t\tconst suggestions = await request;\r\n\r\n\t\t\t// Only update links for the most recent request.\r\n\t\t\tif ( suggestions && request === pendingRequest.current ) {\r\n\t\t\t\t// Since we don't have the response header, we check if the results\r\n\t\t\t\t// are truncated to determine we've reached the end.\r\n\t\t\t\tif ( suggestions.length < PER_PAGE ) {\r\n\t\t\t\t\tsetHasAllSuggestions( true );\r\n\t\t\t\t}\r\n\t\t\t\tsetLinks( [ ...currentSuggestions, ...suggestions ] );\r\n\t\t\t\tnextPage.current++;\r\n\t\t\t}\r\n\r\n\t\t\tclearRequest();\r\n\t\t};\r\n\t\treturn {\r\n\t\t\tfetchMoreSuggestions: debounce( fetchMore, REQUEST_DEBOUNCE_DELAY ),\r\n\t\t};\r\n\t\t// Disable eslint rule for now, to avoid introducing a regression\r\n\t\t// (see https://github.com/WordPress/gutenberg/pull/23922#discussion_r1170634879).\r\n\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\r\n\t}, [] );\r\n\r\n\t// Prevent setting state when unmounted.\r\n\tuseEffect( () => clearRequest, [] );\r\n\r\n\t// Any time the query changes, we reset pagination.\r\n\tuseEffect( () => {\r\n\t\tclearRequest();\r\n\t\tnextPage.current = 1;\r\n\t\tsetHasAllSuggestions( false );\r\n\t\tsetLinks( [ directEntry ] );\r\n\t\tfetchMoreSuggestions( { query, links: [ directEntry ] } );\r\n\t\t// Disable reason: deferring this refactor to the native team.\r\n\t\t// see https://github.com/WordPress/gutenberg/pull/41166\r\n\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\r\n\t}, [ query ] );\r\n\r\n\tconst onEndReached = () => fetchMoreSuggestions( { query, links } );\r\n\r\n\tconst spinner = ! hasAllSuggestions && meetsThreshold( query ) && (\r\n\t\t<View style={ styles.spinner } testID=\"link-picker-loading\">\r\n\t\t\t<ActivityIndicator animating />\r\n\t\t</View>\r\n\t);\r\n\r\n\treturn (\r\n\t\t<BottomSheetConsumer>\r\n\t\t\t{ ( { listProps } ) => (\r\n\t\t\t\t<FlatList\r\n\t\t\t\t\tdata={ links }\r\n\t\t\t\t\tkeyboardShouldPersistTaps=\"always\"\r\n\t\t\t\t\trenderItem={ ( { item } ) => (\r\n\t\t\t\t\t\t<BottomSheet.LinkSuggestionItemCell\r\n\t\t\t\t\t\t\tsuggestion={ item }\r\n\t\t\t\t\t\t\tonLinkPicked={ onLinkPicked }\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t) }\r\n\t\t\t\t\tkeyExtractor={ ( { url, type } ) => `${ url }-${ type }` }\r\n\t\t\t\t\tonEndReached={ onEndReached }\r\n\t\t\t\t\tonEndReachedThreshold={ 0.1 }\r\n\t\t\t\t\tinitialNumToRender={ PER_PAGE }\r\n\t\t\t\t\tListFooterComponent={ spinner }\r\n\t\t\t\t\t{ ...listProps }\r\n\t\t\t\t\tcontentContainerStyle={ [\r\n\t\t\t\t\t\t...listProps.contentContainerStyle,\r\n\t\t\t\t\t\tstyles.list,\r\n\t\t\t\t\t] }\r\n\t\t\t\t/>\r\n\t\t\t) }\r\n\t\t</BottomSheetConsumer>\r\n\t);\r\n}\r\n"],"mappings":"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","ignoreList":[]}