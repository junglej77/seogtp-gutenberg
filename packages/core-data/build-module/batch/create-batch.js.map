{"version":3,"names":["defaultProcessor","createBatch","processor","lastId","queue","pending","ObservableSet","add","inputOrThunk","id","input","Promise","resolve","reject","push","delete","finally","run","size","unsubscribe","subscribe","undefined","results","map","length","Error","error","isSuccess","forEach","result","key","queueItem","_result$output","output","constructor","args","set","Set","subscribers","value","subscriber"],"sources":["@wordpress/core-data/src/batch/create-batch.js"],"sourcesContent":["/**\r\n * Internal dependencies\r\n */\r\nimport defaultProcessor from './default-processor';\r\n\r\n/**\r\n * Creates a batch, which can be used to combine multiple API requests into one\r\n * API request using the WordPress batch processing API (/v1/batch).\r\n *\r\n * ```\r\n * const batch = createBatch();\r\n * const dunePromise = batch.add( {\r\n *   path: '/v1/books',\r\n *   method: 'POST',\r\n *   data: { title: 'Dune' }\r\n * } );\r\n * const lotrPromise = batch.add( {\r\n *   path: '/v1/books',\r\n *   method: 'POST',\r\n *   data: { title: 'Lord of the Rings' }\r\n * } );\r\n * const isSuccess = await batch.run(); // Sends one POST to /v1/batch.\r\n * if ( isSuccess ) {\r\n *   console.log(\r\n *     'Saved two books:',\r\n *     await dunePromise,\r\n *     await lotrPromise\r\n *   );\r\n * }\r\n * ```\r\n *\r\n * @param {Function} [processor] Processor function. Can be used to replace the\r\n *                               default functionality which is to send an API\r\n *                               request to /v1/batch. Is given an array of\r\n *                               inputs and must return a promise that\r\n *                               resolves to an array of objects containing\r\n *                               either `output` or `error`.\r\n */\r\nexport default function createBatch( processor = defaultProcessor ) {\r\n\tlet lastId = 0;\r\n\t/** @type {Array<{ input: any; resolve: ( value: any ) => void; reject: ( error: any ) => void }>} */\r\n\tlet queue = [];\r\n\tconst pending = new ObservableSet();\r\n\r\n\treturn {\r\n\t\t/**\r\n\t\t * Adds an input to the batch and returns a promise that is resolved or\r\n\t\t * rejected when the input is processed by `batch.run()`.\r\n\t\t *\r\n\t\t * You may also pass a thunk which allows inputs to be added\r\n\t\t * asychronously.\r\n\t\t *\r\n\t\t * ```\r\n\t\t * // Both are allowed:\r\n\t\t * batch.add( { path: '/v1/books', ... } );\r\n\t\t * batch.add( ( add ) => add( { path: '/v1/books', ... } ) );\r\n\t\t * ```\r\n\t\t *\r\n\t\t * If a thunk is passed, `batch.run()` will pause until either:\r\n\t\t *\r\n\t\t * - The thunk calls its `add` argument, or;\r\n\t\t * - The thunk returns a promise and that promise resolves, or;\r\n\t\t * - The thunk returns a non-promise.\r\n\t\t *\r\n\t\t * @param {any|Function} inputOrThunk Input to add or thunk to execute.\r\n\t\t *\r\n\t\t * @return {Promise|any} If given an input, returns a promise that\r\n\t\t *                       is resolved or rejected when the batch is\r\n\t\t *                       processed. If given a thunk, returns the return\r\n\t\t *                       value of that thunk.\r\n\t\t */\r\n\t\tadd( inputOrThunk ) {\r\n\t\t\tconst id = ++lastId;\r\n\t\t\tpending.add( id );\r\n\r\n\t\t\tconst add = ( input ) =>\r\n\t\t\t\tnew Promise( ( resolve, reject ) => {\r\n\t\t\t\t\tqueue.push( {\r\n\t\t\t\t\t\tinput,\r\n\t\t\t\t\t\tresolve,\r\n\t\t\t\t\t\treject,\r\n\t\t\t\t\t} );\r\n\t\t\t\t\tpending.delete( id );\r\n\t\t\t\t} );\r\n\r\n\t\t\tif ( typeof inputOrThunk === 'function' ) {\r\n\t\t\t\treturn Promise.resolve( inputOrThunk( add ) ).finally( () => {\r\n\t\t\t\t\tpending.delete( id );\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\r\n\t\t\treturn add( inputOrThunk );\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Runs the batch. This calls `batchProcessor` and resolves or rejects\r\n\t\t * all promises returned by `add()`.\r\n\t\t *\r\n\t\t * @return {Promise<boolean>} A promise that resolves to a boolean that is true\r\n\t\t *                   if the processor returned no errors.\r\n\t\t */\r\n\t\tasync run() {\r\n\t\t\tif ( pending.size ) {\r\n\t\t\t\tawait new Promise( ( resolve ) => {\r\n\t\t\t\t\tconst unsubscribe = pending.subscribe( () => {\r\n\t\t\t\t\t\tif ( ! pending.size ) {\r\n\t\t\t\t\t\t\tunsubscribe();\r\n\t\t\t\t\t\t\tresolve( undefined );\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} );\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\r\n\t\t\tlet results;\r\n\r\n\t\t\ttry {\r\n\t\t\t\tresults = await processor(\r\n\t\t\t\t\tqueue.map( ( { input } ) => input )\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif ( results.length !== queue.length ) {\r\n\t\t\t\t\tthrow new Error(\r\n\t\t\t\t\t\t'run: Array returned by processor must be same size as input array.'\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t} catch ( error ) {\r\n\t\t\t\tfor ( const { reject } of queue ) {\r\n\t\t\t\t\treject( error );\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthrow error;\r\n\t\t\t}\r\n\r\n\t\t\tlet isSuccess = true;\r\n\r\n\t\t\tresults.forEach( ( result, key ) => {\r\n\t\t\t\tconst queueItem = queue[ key ];\r\n\r\n\t\t\t\tif ( result?.error ) {\r\n\t\t\t\t\tqueueItem?.reject( result.error );\r\n\t\t\t\t\tisSuccess = false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tqueueItem?.resolve( result?.output ?? result );\r\n\t\t\t\t}\r\n\t\t\t} );\r\n\r\n\t\t\tqueue = [];\r\n\r\n\t\t\treturn isSuccess;\r\n\t\t},\r\n\t};\r\n}\r\n\r\nclass ObservableSet {\r\n\tconstructor( ...args ) {\r\n\t\tthis.set = new Set( ...args );\r\n\t\tthis.subscribers = new Set();\r\n\t}\r\n\r\n\tget size() {\r\n\t\treturn this.set.size;\r\n\t}\r\n\r\n\tadd( value ) {\r\n\t\tthis.set.add( value );\r\n\t\tthis.subscribers.forEach( ( subscriber ) => subscriber() );\r\n\t\treturn this;\r\n\t}\r\n\r\n\tdelete( value ) {\r\n\t\tconst isSuccess = this.set.delete( value );\r\n\t\tthis.subscribers.forEach( ( subscriber ) => subscriber() );\r\n\t\treturn isSuccess;\r\n\t}\r\n\r\n\tsubscribe( subscriber ) {\r\n\t\tthis.subscribers.add( subscriber );\r\n\t\treturn () => {\r\n\t\t\tthis.subscribers.delete( subscriber );\r\n\t\t};\r\n\t}\r\n}\r\n"],"mappings":"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","ignoreList":[]}