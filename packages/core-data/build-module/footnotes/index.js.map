{"version":3,"names":["RichTextData","create","toHTMLString","getFootnotesOrder","oldFootnotes","updateFootnotesFromMeta","blocks","meta","output","footnotes","undefined","newOrder","JSON","parse","currentOrder","map","fn","id","join","newFootnotes","fnId","find","content","updateAttributes","attributes","Array","isArray","key","value","richTextValue","fromHTMLString","hasFootnotes","replacements","forEach","replacement","type","index","indexOf","countValue","html","innerHTML","text","String","formats","from","length","updateBlocksAttributes","__blocks","block","innerBlocks","newBlocks","reduce","acc","includes","stringify"],"sources":["@wordpress/core-data/src/footnotes/index.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { RichTextData, create, toHTMLString } from '@wordpress/rich-text';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport getFootnotesOrder from './get-footnotes-order';\r\n\r\nlet oldFootnotes = {};\r\n\r\nexport function updateFootnotesFromMeta( blocks, meta ) {\r\n\tconst output = { blocks };\r\n\tif ( ! meta ) {\r\n\t\treturn output;\r\n\t}\r\n\r\n\t// If meta.footnotes is empty, it means the meta is not registered.\r\n\tif ( meta.footnotes === undefined ) {\r\n\t\treturn output;\r\n\t}\r\n\r\n\tconst newOrder = getFootnotesOrder( blocks );\r\n\r\n\tconst footnotes = meta.footnotes ? JSON.parse( meta.footnotes ) : [];\r\n\tconst currentOrder = footnotes.map( ( fn ) => fn.id );\r\n\r\n\tif ( currentOrder.join( '' ) === newOrder.join( '' ) ) {\r\n\t\treturn output;\r\n\t}\r\n\r\n\tconst newFootnotes = newOrder.map(\r\n\t\t( fnId ) =>\r\n\t\t\tfootnotes.find( ( fn ) => fn.id === fnId ) ||\r\n\t\t\toldFootnotes[ fnId ] || {\r\n\t\t\t\tid: fnId,\r\n\t\t\t\tcontent: '',\r\n\t\t\t}\r\n\t);\r\n\r\n\tfunction updateAttributes( attributes ) {\r\n\t\t// Only attempt to update attributes, if attributes is an object.\r\n\t\tif (\r\n\t\t\t! attributes ||\r\n\t\t\tArray.isArray( attributes ) ||\r\n\t\t\ttypeof attributes !== 'object'\r\n\t\t) {\r\n\t\t\treturn attributes;\r\n\t\t}\r\n\r\n\t\tattributes = { ...attributes };\r\n\r\n\t\tfor ( const key in attributes ) {\r\n\t\t\tconst value = attributes[ key ];\r\n\r\n\t\t\tif ( Array.isArray( value ) ) {\r\n\t\t\t\tattributes[ key ] = value.map( updateAttributes );\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\t// To do, remove support for string values?\r\n\t\t\tif (\r\n\t\t\t\ttypeof value !== 'string' &&\r\n\t\t\t\t! ( value instanceof RichTextData )\r\n\t\t\t) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tconst richTextValue =\r\n\t\t\t\ttypeof value === 'string'\r\n\t\t\t\t\t? RichTextData.fromHTMLString( value )\r\n\t\t\t\t\t: new RichTextData( value );\r\n\r\n\t\t\tlet hasFootnotes = false;\r\n\r\n\t\t\trichTextValue.replacements.forEach( ( replacement ) => {\r\n\t\t\t\tif ( replacement.type === 'core/footnote' ) {\r\n\t\t\t\t\tconst id = replacement.attributes[ 'data-fn' ];\r\n\t\t\t\t\tconst index = newOrder.indexOf( id );\r\n\t\t\t\t\t// The innerHTML contains the count wrapped in a link.\r\n\t\t\t\t\tconst countValue = create( {\r\n\t\t\t\t\t\thtml: replacement.innerHTML,\r\n\t\t\t\t\t} );\r\n\t\t\t\t\tcountValue.text = String( index + 1 );\r\n\t\t\t\t\tcountValue.formats = Array.from(\r\n\t\t\t\t\t\t{ length: countValue.text.length },\r\n\t\t\t\t\t\t() => countValue.formats[ 0 ]\r\n\t\t\t\t\t);\r\n\t\t\t\t\tcountValue.replacements = Array.from(\r\n\t\t\t\t\t\t{ length: countValue.text.length },\r\n\t\t\t\t\t\t() => countValue.replacements[ 0 ]\r\n\t\t\t\t\t);\r\n\t\t\t\t\treplacement.innerHTML = toHTMLString( {\r\n\t\t\t\t\t\tvalue: countValue,\r\n\t\t\t\t\t} );\r\n\t\t\t\t\thasFootnotes = true;\r\n\t\t\t\t}\r\n\t\t\t} );\r\n\r\n\t\t\tif ( hasFootnotes ) {\r\n\t\t\t\tattributes[ key ] =\r\n\t\t\t\t\ttypeof value === 'string'\r\n\t\t\t\t\t\t? richTextValue.toHTMLString()\r\n\t\t\t\t\t\t: richTextValue;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn attributes;\r\n\t}\r\n\r\n\tfunction updateBlocksAttributes( __blocks ) {\r\n\t\treturn __blocks.map( ( block ) => {\r\n\t\t\treturn {\r\n\t\t\t\t...block,\r\n\t\t\t\tattributes: updateAttributes( block.attributes ),\r\n\t\t\t\tinnerBlocks: updateBlocksAttributes( block.innerBlocks ),\r\n\t\t\t};\r\n\t\t} );\r\n\t}\r\n\r\n\t// We need to go through all block attributes deeply and update the\r\n\t// footnote anchor numbering (textContent) to match the new order.\r\n\tconst newBlocks = updateBlocksAttributes( blocks );\r\n\r\n\toldFootnotes = {\r\n\t\t...oldFootnotes,\r\n\t\t...footnotes.reduce( ( acc, fn ) => {\r\n\t\t\tif ( ! newOrder.includes( fn.id ) ) {\r\n\t\t\t\tacc[ fn.id ] = fn;\r\n\t\t\t}\r\n\t\t\treturn acc;\r\n\t\t}, {} ),\r\n\t};\r\n\r\n\treturn {\r\n\t\tmeta: {\r\n\t\t\t...meta,\r\n\t\t\tfootnotes: JSON.stringify( newFootnotes ),\r\n\t\t},\r\n\t\tblocks: newBlocks,\r\n\t};\r\n}\r\n"],"mappings":"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","ignoreList":[]}