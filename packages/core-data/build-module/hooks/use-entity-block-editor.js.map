{"version":3,"names":["useCallback","useMemo","useDispatch","useSelect","parse","__unstableSerializeAndClean","STORE_NAME","useEntityId","updateFootnotesFromMeta","EMPTY_ARRAY","parsedBlocksCache","WeakMap","useEntityBlockEditor","kind","name","id","_id","providerId","getEntityRecord","getEntityRecordEdits","content","editedBlocks","meta","select","getEditedEntityRecord","editedRecord","blocks","__unstableCreateUndoLevel","editEntityRecord","undefined","edits","isUnedited","Object","keys","length","cackeKey","_blocks","get","set","updateFootnotes","onChange","newBlocks","options","noChange","selection","rest","blocksForSerialization","isCached","onInput","footnotesChanges"],"sources":["@wordpress/core-data/src/hooks/use-entity-block-editor.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useCallback, useMemo } from '@wordpress/element';\r\nimport { useDispatch, useSelect } from '@wordpress/data';\r\nimport { parse, __unstableSerializeAndClean } from '@wordpress/blocks';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { STORE_NAME } from '../name';\r\nimport useEntityId from './use-entity-id';\r\nimport { updateFootnotesFromMeta } from '../footnotes';\r\n\r\nconst EMPTY_ARRAY = [];\r\nconst parsedBlocksCache = new WeakMap();\r\n\r\n/**\r\n * Hook that returns block content getters and setters for\r\n * the nearest provided entity of the specified type.\r\n *\r\n * The return value has the shape `[ blocks, onInput, onChange ]`.\r\n * `onInput` is for block changes that don't create undo levels\r\n * or dirty the post, non-persistent changes, and `onChange` is for\r\n * persistent changes. They map directly to the props of a\r\n * `BlockEditorProvider` and are intended to be used with it,\r\n * or similar components or hooks.\r\n *\r\n * @param {string} kind         The entity kind.\r\n * @param {string} name         The entity name.\r\n * @param {Object} options\r\n * @param {string} [options.id] An entity ID to use instead of the context-provided one.\r\n *\r\n * @return {[unknown[], Function, Function]} The block array and setters.\r\n */\r\nexport default function useEntityBlockEditor( kind, name, { id: _id } = {} ) {\r\n\tconst providerId = useEntityId( kind, name );\r\n\tconst id = _id ?? providerId;\r\n\tconst { getEntityRecord, getEntityRecordEdits } = useSelect( STORE_NAME );\r\n\tconst { content, editedBlocks, meta } = useSelect(\r\n\t\t( select ) => {\r\n\t\t\tif ( ! id ) {\r\n\t\t\t\treturn {};\r\n\t\t\t}\r\n\t\t\tconst { getEditedEntityRecord } = select( STORE_NAME );\r\n\t\t\tconst editedRecord = getEditedEntityRecord( kind, name, id );\r\n\t\t\treturn {\r\n\t\t\t\teditedBlocks: editedRecord.blocks,\r\n\t\t\t\tcontent: editedRecord.content,\r\n\t\t\t\tmeta: editedRecord.meta,\r\n\t\t\t};\r\n\t\t},\r\n\t\t[ kind, name, id ]\r\n\t);\r\n\tconst { __unstableCreateUndoLevel, editEntityRecord } =\r\n\t\tuseDispatch( STORE_NAME );\r\n\r\n\tconst blocks = useMemo( () => {\r\n\t\tif ( ! id ) {\r\n\t\t\treturn undefined;\r\n\t\t}\r\n\r\n\t\tif ( editedBlocks ) {\r\n\t\t\treturn editedBlocks;\r\n\t\t}\r\n\r\n\t\tif ( ! content || typeof content !== 'string' ) {\r\n\t\t\treturn EMPTY_ARRAY;\r\n\t\t}\r\n\r\n\t\t// If there's an edit, cache the parsed blocks by the edit.\r\n\t\t// If not, cache by the original enity record.\r\n\t\tconst edits = getEntityRecordEdits( kind, name, id );\r\n\t\tconst isUnedited = ! edits || ! Object.keys( edits ).length;\r\n\t\tconst cackeKey = isUnedited ? getEntityRecord( kind, name, id ) : edits;\r\n\t\tlet _blocks = parsedBlocksCache.get( cackeKey );\r\n\r\n\t\tif ( ! _blocks ) {\r\n\t\t\t_blocks = parse( content );\r\n\t\t\tparsedBlocksCache.set( cackeKey, _blocks );\r\n\t\t}\r\n\r\n\t\treturn _blocks;\r\n\t}, [\r\n\t\tkind,\r\n\t\tname,\r\n\t\tid,\r\n\t\teditedBlocks,\r\n\t\tcontent,\r\n\t\tgetEntityRecord,\r\n\t\tgetEntityRecordEdits,\r\n\t] );\r\n\r\n\tconst updateFootnotes = useCallback(\r\n\t\t( _blocks ) => updateFootnotesFromMeta( _blocks, meta ),\r\n\t\t[ meta ]\r\n\t);\r\n\r\n\tconst onChange = useCallback(\r\n\t\t( newBlocks, options ) => {\r\n\t\t\tconst noChange = blocks === newBlocks;\r\n\t\t\tif ( noChange ) {\r\n\t\t\t\treturn __unstableCreateUndoLevel( kind, name, id );\r\n\t\t\t}\r\n\t\t\tconst { selection, ...rest } = options;\r\n\r\n\t\t\t// We create a new function here on every persistent edit\r\n\t\t\t// to make sure the edit makes the post dirty and creates\r\n\t\t\t// a new undo level.\r\n\t\t\tconst edits = {\r\n\t\t\t\tselection,\r\n\t\t\t\tcontent: ( { blocks: blocksForSerialization = [] } ) =>\r\n\t\t\t\t\t__unstableSerializeAndClean( blocksForSerialization ),\r\n\t\t\t\t...updateFootnotes( newBlocks ),\r\n\t\t\t};\r\n\r\n\t\t\teditEntityRecord( kind, name, id, edits, {\r\n\t\t\t\tisCached: false,\r\n\t\t\t\t...rest,\r\n\t\t\t} );\r\n\t\t},\r\n\t\t[\r\n\t\t\tkind,\r\n\t\t\tname,\r\n\t\t\tid,\r\n\t\t\tblocks,\r\n\t\t\tupdateFootnotes,\r\n\t\t\t__unstableCreateUndoLevel,\r\n\t\t\teditEntityRecord,\r\n\t\t]\r\n\t);\r\n\r\n\tconst onInput = useCallback(\r\n\t\t( newBlocks, options ) => {\r\n\t\t\tconst { selection, ...rest } = options;\r\n\t\t\tconst footnotesChanges = updateFootnotes( newBlocks );\r\n\t\t\tconst edits = { selection, ...footnotesChanges };\r\n\r\n\t\t\teditEntityRecord( kind, name, id, edits, {\r\n\t\t\t\tisCached: true,\r\n\t\t\t\t...rest,\r\n\t\t\t} );\r\n\t\t},\r\n\t\t[ kind, name, id, updateFootnotes, editEntityRecord ]\r\n\t);\r\n\r\n\treturn [ blocks, onInput, onChange ];\r\n}\r\n"],"mappings":"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","ignoreList":[]}