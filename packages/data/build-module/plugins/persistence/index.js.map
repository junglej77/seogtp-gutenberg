{"version":3,"names":["isPlainObject","deepmerge","defaultStorage","combineReducers","DEFAULT_STORAGE","DEFAULT_STORAGE_KEY","withLazySameState","reducer","state","action","nextState","createPersistenceInterface","options","storage","storageKey","data","getData","undefined","persisted","getItem","JSON","parse","error","setData","key","value","setItem","stringify","get","set","persistencePlugin","registry","pluginOptions","persistence","createPersistOnChange","getState","storeName","keys","getPersistedState","Array","isArray","reducers","reduce","accumulator","Object","assign","lastState","registerStore","persist","persistedState","initialState","type","isMergeableObject","store","subscribe","__unstableMigrate"],"sources":["@wordpress/data/src/plugins/persistence/index.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport { isPlainObject } from 'is-plain-object';\r\nimport deepmerge from 'deepmerge';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport defaultStorage from './storage/default';\r\nimport { combineReducers } from '../../';\r\n\r\n/** @typedef {import('../../registry').WPDataRegistry} WPDataRegistry */\r\n\r\n/** @typedef {import('../../registry').WPDataPlugin} WPDataPlugin */\r\n\r\n/**\r\n * @typedef {Object} WPDataPersistencePluginOptions Persistence plugin options.\r\n *\r\n * @property {Storage} storage    Persistent storage implementation. This must\r\n *                                at least implement `getItem` and `setItem` of\r\n *                                the Web Storage API.\r\n * @property {string}  storageKey Key on which to set in persistent storage.\r\n */\r\n\r\n/**\r\n * Default plugin storage.\r\n *\r\n * @type {Storage}\r\n */\r\nconst DEFAULT_STORAGE = defaultStorage;\r\n\r\n/**\r\n * Default plugin storage key.\r\n *\r\n * @type {string}\r\n */\r\nconst DEFAULT_STORAGE_KEY = 'WP_DATA';\r\n\r\n/**\r\n * Higher-order reducer which invokes the original reducer only if state is\r\n * inequal from that of the action's `nextState` property, otherwise returning\r\n * the original state reference.\r\n *\r\n * @param {Function} reducer Original reducer.\r\n *\r\n * @return {Function} Enhanced reducer.\r\n */\r\nexport const withLazySameState = ( reducer ) => ( state, action ) => {\r\n\tif ( action.nextState === state ) {\r\n\t\treturn state;\r\n\t}\r\n\r\n\treturn reducer( state, action );\r\n};\r\n\r\n/**\r\n * Creates a persistence interface, exposing getter and setter methods (`get`\r\n * and `set` respectively).\r\n *\r\n * @param {WPDataPersistencePluginOptions} options Plugin options.\r\n *\r\n * @return {Object} Persistence interface.\r\n */\r\nexport function createPersistenceInterface( options ) {\r\n\tconst { storage = DEFAULT_STORAGE, storageKey = DEFAULT_STORAGE_KEY } =\r\n\t\toptions;\r\n\r\n\tlet data;\r\n\r\n\t/**\r\n\t * Returns the persisted data as an object, defaulting to an empty object.\r\n\t *\r\n\t * @return {Object} Persisted data.\r\n\t */\r\n\tfunction getData() {\r\n\t\tif ( data === undefined ) {\r\n\t\t\t// If unset, getItem is expected to return null. Fall back to\r\n\t\t\t// empty object.\r\n\t\t\tconst persisted = storage.getItem( storageKey );\r\n\t\t\tif ( persisted === null ) {\r\n\t\t\t\tdata = {};\r\n\t\t\t} else {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tdata = JSON.parse( persisted );\r\n\t\t\t\t} catch ( error ) {\r\n\t\t\t\t\t// Similarly, should any error be thrown during parse of\r\n\t\t\t\t\t// the string (malformed JSON), fall back to empty object.\r\n\t\t\t\t\tdata = {};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn data;\r\n\t}\r\n\r\n\t/**\r\n\t * Merges an updated reducer state into the persisted data.\r\n\t *\r\n\t * @param {string} key   Key to update.\r\n\t * @param {*}      value Updated value.\r\n\t */\r\n\tfunction setData( key, value ) {\r\n\t\tdata = { ...data, [ key ]: value };\r\n\t\tstorage.setItem( storageKey, JSON.stringify( data ) );\r\n\t}\r\n\r\n\treturn {\r\n\t\tget: getData,\r\n\t\tset: setData,\r\n\t};\r\n}\r\n\r\n/**\r\n * Data plugin to persist store state into a single storage key.\r\n *\r\n * @param {WPDataRegistry}                  registry      Data registry.\r\n * @param {?WPDataPersistencePluginOptions} pluginOptions Plugin options.\r\n *\r\n * @return {WPDataPlugin} Data plugin.\r\n */\r\nfunction persistencePlugin( registry, pluginOptions ) {\r\n\tconst persistence = createPersistenceInterface( pluginOptions );\r\n\r\n\t/**\r\n\t * Creates an enhanced store dispatch function, triggering the state of the\r\n\t * given store name to be persisted when changed.\r\n\t *\r\n\t * @param {Function}       getState  Function which returns current state.\r\n\t * @param {string}         storeName Store name.\r\n\t * @param {?Array<string>} keys      Optional subset of keys to save.\r\n\t *\r\n\t * @return {Function} Enhanced dispatch function.\r\n\t */\r\n\tfunction createPersistOnChange( getState, storeName, keys ) {\r\n\t\tlet getPersistedState;\r\n\t\tif ( Array.isArray( keys ) ) {\r\n\t\t\t// Given keys, the persisted state should by produced as an object\r\n\t\t\t// of the subset of keys. This implementation uses combineReducers\r\n\t\t\t// to leverage its behavior of returning the same object when none\r\n\t\t\t// of the property values changes. This allows a strict reference\r\n\t\t\t// equality to bypass a persistence set on an unchanging state.\r\n\t\t\tconst reducers = keys.reduce(\r\n\t\t\t\t( accumulator, key ) =>\r\n\t\t\t\t\tObject.assign( accumulator, {\r\n\t\t\t\t\t\t[ key ]: ( state, action ) => action.nextState[ key ],\r\n\t\t\t\t\t} ),\r\n\t\t\t\t{}\r\n\t\t\t);\r\n\r\n\t\t\tgetPersistedState = withLazySameState(\r\n\t\t\t\tcombineReducers( reducers )\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tgetPersistedState = ( state, action ) => action.nextState;\r\n\t\t}\r\n\r\n\t\tlet lastState = getPersistedState( undefined, {\r\n\t\t\tnextState: getState(),\r\n\t\t} );\r\n\r\n\t\treturn () => {\r\n\t\t\tconst state = getPersistedState( lastState, {\r\n\t\t\t\tnextState: getState(),\r\n\t\t\t} );\r\n\t\t\tif ( state !== lastState ) {\r\n\t\t\t\tpersistence.set( storeName, state );\r\n\t\t\t\tlastState = state;\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\treturn {\r\n\t\tregisterStore( storeName, options ) {\r\n\t\t\tif ( ! options.persist ) {\r\n\t\t\t\treturn registry.registerStore( storeName, options );\r\n\t\t\t}\r\n\r\n\t\t\t// Load from persistence to use as initial state.\r\n\t\t\tconst persistedState = persistence.get()[ storeName ];\r\n\t\t\tif ( persistedState !== undefined ) {\r\n\t\t\t\tlet initialState = options.reducer( options.initialState, {\r\n\t\t\t\t\ttype: '@@WP/PERSISTENCE_RESTORE',\r\n\t\t\t\t} );\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\tisPlainObject( initialState ) &&\r\n\t\t\t\t\tisPlainObject( persistedState )\r\n\t\t\t\t) {\r\n\t\t\t\t\t// If state is an object, ensure that:\r\n\t\t\t\t\t// - Other keys are left intact when persisting only a\r\n\t\t\t\t\t//   subset of keys.\r\n\t\t\t\t\t// - New keys in what would otherwise be used as initial\r\n\t\t\t\t\t//   state are deeply merged as base for persisted value.\r\n\t\t\t\t\tinitialState = deepmerge( initialState, persistedState, {\r\n\t\t\t\t\t\tisMergeableObject: isPlainObject,\r\n\t\t\t\t\t} );\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// If there is a mismatch in object-likeness of default\r\n\t\t\t\t\t// initial or persisted state, defer to persisted value.\r\n\t\t\t\t\tinitialState = persistedState;\r\n\t\t\t\t}\r\n\r\n\t\t\t\toptions = {\r\n\t\t\t\t\t...options,\r\n\t\t\t\t\tinitialState,\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tconst store = registry.registerStore( storeName, options );\r\n\r\n\t\t\tstore.subscribe(\r\n\t\t\t\tcreatePersistOnChange(\r\n\t\t\t\t\tstore.getState,\r\n\t\t\t\t\tstoreName,\r\n\t\t\t\t\toptions.persist\r\n\t\t\t\t)\r\n\t\t\t);\r\n\r\n\t\t\treturn store;\r\n\t\t},\r\n\t};\r\n}\r\n\r\npersistencePlugin.__unstableMigrate = () => {};\r\n\r\nexport default persistencePlugin;\r\n"],"mappings":"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","ignoreList":[]}