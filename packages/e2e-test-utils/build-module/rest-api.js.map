{"version":3,"names":["fetch","FormData","apiFetch","WP_BASE_URL","WP_USERNAME","WP_PASSWORD","createURL","global","window","setAPIRootURL","res","method","links","headers","get","restLink","match","Error","rootURL","use","createRootURLMiddleware","login","retries","formData","append","loginResponse","getHeaders","body","redirect","cookies","cookie","split","map","setCookie","join","nonceEndpoint","response","status","setNonce","loginRequest","nonce","text","createNonceMiddleware","setCookieMiddleware","request","next","rest","options","Promise","all","batch","requests","path","data","validation"],"sources":["@wordpress/e2e-test-utils/src/rest-api.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport fetch from 'node-fetch';\r\nimport FormData from 'form-data';\r\n\r\n/**\r\n * WordPress dependencies\r\n */\r\nimport apiFetch from '@wordpress/api-fetch';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { WP_BASE_URL, WP_USERNAME, WP_PASSWORD } from './shared/config';\r\nimport { createURL } from './create-url';\r\n\r\n// `apiFetch` expects `window.fetch` to be available in its default handler.\r\nglobal.window = global.window || {};\r\nglobal.window.fetch = fetch;\r\n\r\nconst setAPIRootURL = ( async () => {\r\n\t// Discover the API root url using link header.\r\n\t// See https://developer.wordpress.org/rest-api/using-the-rest-api/discovery/#link-header\r\n\tconst res = await fetch( WP_BASE_URL, { method: 'HEAD' } );\r\n\tconst links = res.headers.get( 'link' );\r\n\tconst restLink = links.match( /<([^>]+)>; rel=\"https:\\/\\/api\\.w\\.org\\/\"/ );\r\n\r\n\tif ( ! restLink ) {\r\n\t\tthrow new Error( `Failed to discover REST API endpoint.\r\nLink header: ${ links }` );\r\n\t}\r\n\r\n\tconst [ , rootURL ] = restLink;\r\n\tapiFetch.use( apiFetch.createRootURLMiddleware( rootURL ) );\r\n} )();\r\n\r\nasync function login( retries = 3 ) {\r\n\tconst formData = new FormData();\r\n\tformData.append( 'log', WP_USERNAME );\r\n\tformData.append( 'pwd', WP_PASSWORD );\r\n\r\n\t// Login to admin using fetch.\r\n\tconst loginResponse = await fetch( createURL( 'wp-login.php' ), {\r\n\t\tmethod: 'POST',\r\n\t\theaders: formData.getHeaders(),\r\n\t\tbody: formData,\r\n\t\tredirect: 'manual',\r\n\t} );\r\n\r\n\t// Retrieve the cookies.\r\n\tconst cookies = loginResponse.headers.get( 'set-cookie' );\r\n\tconst cookie = cookies\r\n\t\t.split( ',' )\r\n\t\t.map( ( setCookie ) => setCookie.split( ';' )[ 0 ] )\r\n\t\t.join( ';' );\r\n\r\n\tapiFetch.nonceEndpoint = createURL(\r\n\t\t'wp-admin/admin-ajax.php',\r\n\t\t'action=rest-nonce'\r\n\t);\r\n\r\n\t// Get the initial nonce.\r\n\tconst response = await fetch( apiFetch.nonceEndpoint, {\r\n\t\theaders: { cookie },\r\n\t} );\r\n\r\n\tif ( response.status === 200 ) {\r\n\t\treturn {\r\n\t\t\tresponse,\r\n\t\t\tcookie,\r\n\t\t};\r\n\t}\r\n\r\n\t// Sometimes the nonce call will fail if a test has forced a new login\r\n\t// and invalidated the cookie, so retry the login in these instances.\r\n\tif ( retries > 0 ) {\r\n\t\treturn login( retries - 1 );\r\n\t}\r\n\r\n\tthrow new Error(\r\n\t\t`Fetch api call failed for ${ apiFetch.nonceEndpoint }: ${ response.status }`\r\n\t);\r\n}\r\n\r\nconst setNonce = ( async () => {\r\n\t// Get the initial nonce.\r\n\tconst loginRequest = await login();\r\n\r\n\tconst nonce = await loginRequest.response.text();\r\n\r\n\t// Register the nonce middleware.\r\n\tapiFetch.use( apiFetch.createNonceMiddleware( nonce ) );\r\n\r\n\t// For the nonce to work we have to also pass the cookies.\r\n\tapiFetch.use( function setCookieMiddleware( request, next ) {\r\n\t\treturn next( {\r\n\t\t\t...request,\r\n\t\t\theaders: {\r\n\t\t\t\t...request.headers,\r\n\t\t\t\tcookie: loginRequest.cookie,\r\n\t\t\t},\r\n\t\t} );\r\n\t} );\r\n} )();\r\n\r\n/**\r\n * Call REST API using `apiFetch` to build and clear test states.\r\n *\r\n * @param {Object} options `apiFetch` options.\r\n * @return {Promise<any>} The response value.\r\n */\r\nasync function rest( options = {} ) {\r\n\t// Only need to set them once but before any requests.\r\n\tawait Promise.all( [ setAPIRootURL, setNonce ] );\r\n\r\n\treturn await apiFetch( options );\r\n}\r\n\r\n/**\r\n * Call a set of REST APIs in batch.\r\n * See https://make.wordpress.org/core/2020/11/20/rest-api-batch-framework-in-wordpress-5-6/\r\n * Note that calling GET requests in batch is not supported.\r\n *\r\n * @param {Array<Object>} requests The request objects.\r\n * @return {Promise<any>} The response value.\r\n */\r\nasync function batch( requests ) {\r\n\treturn await rest( {\r\n\t\tmethod: 'POST',\r\n\t\tpath: '/batch/v1',\r\n\t\tdata: {\r\n\t\t\trequests,\r\n\t\t\tvalidation: 'require-all-validate',\r\n\t\t},\r\n\t} );\r\n}\r\n\r\nexport { rest, batch };\r\n"],"mappings":"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","ignoreList":[]}