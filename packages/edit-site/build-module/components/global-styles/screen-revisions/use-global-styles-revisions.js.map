{"version":3,"names":["useSelect","store","coreStore","useContext","useMemo","privateApis","blockEditorPrivateApis","unlock","SITE_EDITOR_AUTHORS_QUERY","per_page","_fields","context","capabilities","DEFAULT_QUERY","page","EMPTY_ARRAY","GlobalStylesContext","useGlobalStylesRevisions","query","user","userConfig","_query","authors","currentUser","isDirty","revisions","isLoadingGlobalStylesRevisions","revisionsCount","select","_globalStyles$_links$","__experimentalGetDirtyEntityRecords","getCurrentUser","getUsers","getRevisions","__experimentalGetCurrentGlobalStylesId","getEntityRecord","isResolving","dirtyEntityRecords","_currentUser","_isDirty","length","globalStylesId","globalStyles","undefined","_revisionsCount","_links","count","globalStylesRevisions","_authors","_isResolving","hasUnsavedChanges","isLoading","_modifiedRevisions","map","revision","author","find","id","fetchedRevisionsCount","isLatest","Object","keys","unsavedRevision","styles","settings","name","avatar_urls","modified","Date","unshift","Math","ceil","push"],"sources":["@wordpress/edit-site/src/components/global-styles/screen-revisions/use-global-styles-revisions.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useSelect } from '@wordpress/data';\r\nimport { store as coreStore } from '@wordpress/core-data';\r\nimport { useContext, useMemo } from '@wordpress/element';\r\nimport { privateApis as blockEditorPrivateApis } from '@wordpress/block-editor';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { unlock } from '../../../lock-unlock';\r\n\r\nconst SITE_EDITOR_AUTHORS_QUERY = {\r\n\tper_page: -1,\r\n\t_fields: 'id,name,avatar_urls',\r\n\tcontext: 'view',\r\n\tcapabilities: [ 'edit_theme_options' ],\r\n};\r\nconst DEFAULT_QUERY = { per_page: 100, page: 1 };\r\nconst EMPTY_ARRAY = [];\r\nconst { GlobalStylesContext } = unlock( blockEditorPrivateApis );\r\nexport default function useGlobalStylesRevisions( { query } = {} ) {\r\n\tconst { user: userConfig } = useContext( GlobalStylesContext );\r\n\tconst _query = { ...DEFAULT_QUERY, ...query };\r\n\tconst {\r\n\t\tauthors,\r\n\t\tcurrentUser,\r\n\t\tisDirty,\r\n\t\trevisions,\r\n\t\tisLoadingGlobalStylesRevisions,\r\n\t\trevisionsCount,\r\n\t} = useSelect(\r\n\t\t( select ) => {\r\n\t\t\tconst {\r\n\t\t\t\t__experimentalGetDirtyEntityRecords,\r\n\t\t\t\tgetCurrentUser,\r\n\t\t\t\tgetUsers,\r\n\t\t\t\tgetRevisions,\r\n\t\t\t\t__experimentalGetCurrentGlobalStylesId,\r\n\t\t\t\tgetEntityRecord,\r\n\t\t\t\tisResolving,\r\n\t\t\t} = select( coreStore );\r\n\t\t\tconst dirtyEntityRecords = __experimentalGetDirtyEntityRecords();\r\n\t\t\tconst _currentUser = getCurrentUser();\r\n\t\t\tconst _isDirty = dirtyEntityRecords.length > 0;\r\n\t\t\tconst globalStylesId = __experimentalGetCurrentGlobalStylesId();\r\n\t\t\tconst globalStyles = globalStylesId\r\n\t\t\t\t? getEntityRecord( 'root', 'globalStyles', globalStylesId )\r\n\t\t\t\t: undefined;\r\n\t\t\tconst _revisionsCount =\r\n\t\t\t\tglobalStyles?._links?.[ 'version-history' ]?.[ 0 ]?.count ?? 0;\r\n\t\t\tconst globalStylesRevisions =\r\n\t\t\t\tgetRevisions(\r\n\t\t\t\t\t'root',\r\n\t\t\t\t\t'globalStyles',\r\n\t\t\t\t\tglobalStylesId,\r\n\t\t\t\t\t_query\r\n\t\t\t\t) || EMPTY_ARRAY;\r\n\t\t\tconst _authors =\r\n\t\t\t\tgetUsers( SITE_EDITOR_AUTHORS_QUERY ) || EMPTY_ARRAY;\r\n\t\t\tconst _isResolving = isResolving( 'getRevisions', [\r\n\t\t\t\t'root',\r\n\t\t\t\t'globalStyles',\r\n\t\t\t\tglobalStylesId,\r\n\t\t\t\t_query,\r\n\t\t\t] );\r\n\t\t\treturn {\r\n\t\t\t\tauthors: _authors,\r\n\t\t\t\tcurrentUser: _currentUser,\r\n\t\t\t\tisDirty: _isDirty,\r\n\t\t\t\trevisions: globalStylesRevisions,\r\n\t\t\t\tisLoadingGlobalStylesRevisions: _isResolving,\r\n\t\t\t\trevisionsCount: _revisionsCount,\r\n\t\t\t};\r\n\t\t},\r\n\t\t[ query ]\r\n\t);\r\n\treturn useMemo( () => {\r\n\t\tif ( ! authors.length || isLoadingGlobalStylesRevisions ) {\r\n\t\t\treturn {\r\n\t\t\t\trevisions: EMPTY_ARRAY,\r\n\t\t\t\thasUnsavedChanges: isDirty,\r\n\t\t\t\tisLoading: true,\r\n\t\t\t\trevisionsCount,\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\t// Adds author details to each revision.\r\n\t\tconst _modifiedRevisions = revisions.map( ( revision ) => {\r\n\t\t\treturn {\r\n\t\t\t\t...revision,\r\n\t\t\t\tauthor: authors.find(\r\n\t\t\t\t\t( author ) => author.id === revision.author\r\n\t\t\t\t),\r\n\t\t\t};\r\n\t\t} );\r\n\r\n\t\tconst fetchedRevisionsCount = revisions.length;\r\n\r\n\t\tif ( fetchedRevisionsCount ) {\r\n\t\t\t// Flags the most current saved revision.\r\n\t\t\tif (\r\n\t\t\t\t_modifiedRevisions[ 0 ].id !== 'unsaved' &&\r\n\t\t\t\t_query.page === 1\r\n\t\t\t) {\r\n\t\t\t\t_modifiedRevisions[ 0 ].isLatest = true;\r\n\t\t\t}\r\n\r\n\t\t\t// Adds an item for unsaved changes.\r\n\t\t\tif (\r\n\t\t\t\tisDirty &&\r\n\t\t\t\tuserConfig &&\r\n\t\t\t\tObject.keys( userConfig ).length > 0 &&\r\n\t\t\t\tcurrentUser &&\r\n\t\t\t\t_query.page === 1\r\n\t\t\t) {\r\n\t\t\t\tconst unsavedRevision = {\r\n\t\t\t\t\tid: 'unsaved',\r\n\t\t\t\t\tstyles: userConfig?.styles,\r\n\t\t\t\t\tsettings: userConfig?.settings,\r\n\t\t\t\t\t_links: userConfig?._links,\r\n\t\t\t\t\tauthor: {\r\n\t\t\t\t\t\tname: currentUser?.name,\r\n\t\t\t\t\t\tavatar_urls: currentUser?.avatar_urls,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tmodified: new Date(),\r\n\t\t\t\t};\r\n\r\n\t\t\t\t_modifiedRevisions.unshift( unsavedRevision );\r\n\t\t\t}\r\n\r\n\t\t\tif (\r\n\t\t\t\t_query.page === Math.ceil( revisionsCount / _query.per_page )\r\n\t\t\t) {\r\n\t\t\t\t// Adds an item for the default theme styles.\r\n\t\t\t\t_modifiedRevisions.push( {\r\n\t\t\t\t\tid: 'parent',\r\n\t\t\t\t\tstyles: {},\r\n\t\t\t\t\tsettings: {},\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\trevisions: _modifiedRevisions,\r\n\t\t\thasUnsavedChanges: isDirty,\r\n\t\t\tisLoading: false,\r\n\t\t\trevisionsCount,\r\n\t\t};\r\n\t}, [\r\n\t\tisDirty,\r\n\t\trevisions,\r\n\t\tcurrentUser,\r\n\t\tauthors,\r\n\t\tuserConfig,\r\n\t\tisLoadingGlobalStylesRevisions,\r\n\t] );\r\n}\r\n"],"mappings":"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","ignoreList":[]}