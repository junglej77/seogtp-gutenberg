{"version":3,"names":["Component","compose","withSelect","withDispatch","store","coreStore","editorStore","AutosaveMonitor","constructor","props","needsAutosave","isDirty","isAutosaveable","componentDidMount","disableIntervalChecks","setAutosaveTimer","componentDidUpdate","prevProps","editsReference","autosave","interval","clearTimeout","timerId","isAutosaving","componentWillUnmount","timeout","setTimeout","autosaveTimerHandler","render","select","ownProps","getReferenceByDistinctEdits","isEditedPostDirty","isEditedPostAutosaveable","isAutosavingPost","getEditorSettings","autosaveInterval","dispatch"],"sources":["@wordpress/editor/src/components/autosave-monitor/index.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { Component } from '@wordpress/element';\r\nimport { compose } from '@wordpress/compose';\r\nimport { withSelect, withDispatch } from '@wordpress/data';\r\nimport { store as coreStore } from '@wordpress/core-data';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store as editorStore } from '../../store';\r\n\r\nexport class AutosaveMonitor extends Component {\r\n\tconstructor( props ) {\r\n\t\tsuper( props );\r\n\t\tthis.needsAutosave = !! ( props.isDirty && props.isAutosaveable );\r\n\t}\r\n\r\n\tcomponentDidMount() {\r\n\t\tif ( ! this.props.disableIntervalChecks ) {\r\n\t\t\tthis.setAutosaveTimer();\r\n\t\t}\r\n\t}\r\n\r\n\tcomponentDidUpdate( prevProps ) {\r\n\t\tif ( this.props.disableIntervalChecks ) {\r\n\t\t\tif ( this.props.editsReference !== prevProps.editsReference ) {\r\n\t\t\t\tthis.props.autosave();\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ( this.props.interval !== prevProps.interval ) {\r\n\t\t\tclearTimeout( this.timerId );\r\n\t\t\tthis.setAutosaveTimer();\r\n\t\t}\r\n\r\n\t\tif ( ! this.props.isDirty ) {\r\n\t\t\tthis.needsAutosave = false;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ( this.props.isAutosaving && ! prevProps.isAutosaving ) {\r\n\t\t\tthis.needsAutosave = false;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ( this.props.editsReference !== prevProps.editsReference ) {\r\n\t\t\tthis.needsAutosave = true;\r\n\t\t}\r\n\t}\r\n\r\n\tcomponentWillUnmount() {\r\n\t\tclearTimeout( this.timerId );\r\n\t}\r\n\r\n\tsetAutosaveTimer( timeout = this.props.interval * 1000 ) {\r\n\t\tthis.timerId = setTimeout( () => {\r\n\t\t\tthis.autosaveTimerHandler();\r\n\t\t}, timeout );\r\n\t}\r\n\r\n\tautosaveTimerHandler() {\r\n\t\tif ( ! this.props.isAutosaveable ) {\r\n\t\t\tthis.setAutosaveTimer( 1000 );\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ( this.needsAutosave ) {\r\n\t\t\tthis.needsAutosave = false;\r\n\t\t\tthis.props.autosave();\r\n\t\t}\r\n\r\n\t\tthis.setAutosaveTimer();\r\n\t}\r\n\r\n\trender() {\r\n\t\treturn null;\r\n\t}\r\n}\r\n\r\n/**\r\n * Monitors the changes made to the edited post and triggers autosave if necessary.\r\n *\r\n * The logic is straightforward: a check is performed every `props.interval` seconds. If any changes are detected, `props.autosave()` is called.\r\n * The time between the change and the autosave varies but is no larger than `props.interval` seconds. Refer to the code below for more details, such as\r\n * the specific way of detecting changes.\r\n *\r\n * There are two caveats:\r\n * * If `props.isAutosaveable` happens to be false at a time of checking for changes, the check is retried every second.\r\n * * The timer may be disabled by setting `props.disableIntervalChecks` to `true`. In that mode, any change will immediately trigger `props.autosave()`.\r\n *\r\n * @param {Object}   props                       - The properties passed to the component.\r\n * @param {Function} props.autosave              - The function to call when changes need to be saved.\r\n * @param {number}   props.interval              - The maximum time in seconds between an unsaved change and an autosave.\r\n * @param {boolean}  props.isAutosaveable        - If false, the check for changes is retried every second.\r\n * @param {boolean}  props.disableIntervalChecks - If true, disables the timer and any change will immediately trigger `props.autosave()`.\r\n * @param {boolean}  props.isDirty               - Indicates if there are unsaved changes.\r\n *\r\n * @example\r\n * ```jsx\r\n * <AutosaveMonitor interval={30000} />\r\n * ```\r\n */\r\nexport default compose( [\r\n\twithSelect( ( select, ownProps ) => {\r\n\t\tconst { getReferenceByDistinctEdits } = select( coreStore );\r\n\r\n\t\tconst {\r\n\t\t\tisEditedPostDirty,\r\n\t\t\tisEditedPostAutosaveable,\r\n\t\t\tisAutosavingPost,\r\n\t\t\tgetEditorSettings,\r\n\t\t} = select( editorStore );\r\n\r\n\t\tconst { interval = getEditorSettings().autosaveInterval } = ownProps;\r\n\r\n\t\treturn {\r\n\t\t\teditsReference: getReferenceByDistinctEdits(),\r\n\t\t\tisDirty: isEditedPostDirty(),\r\n\t\t\tisAutosaveable: isEditedPostAutosaveable(),\r\n\t\t\tisAutosaving: isAutosavingPost(),\r\n\t\t\tinterval,\r\n\t\t};\r\n\t} ),\r\n\twithDispatch( ( dispatch, ownProps ) => ( {\r\n\t\tautosave() {\r\n\t\t\tconst { autosave = dispatch( editorStore ).autosave } = ownProps;\r\n\t\t\tautosave();\r\n\t\t},\r\n\t} ) ),\r\n] )( AutosaveMonitor );\r\n"],"mappings":"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","ignoreList":[]}