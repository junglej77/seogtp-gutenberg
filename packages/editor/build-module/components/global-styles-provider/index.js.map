{"version":3,"names":["deepmerge","isPlainObject","privateApis","blockEditorPrivateApis","store","coreStore","useSelect","useDispatch","useMemo","useCallback","unlock","jsx","_jsx","GlobalStylesContext","cleanEmptyObject","mergeBaseAndUserConfigs","base","user","isMergeableObject","customMerge","key","baseConfig","userConfig","undefined","useGlobalStylesUserConfig","globalStylesId","isReady","settings","styles","_links","title","select","getEditedEntityRecord","hasFinishedResolution","canUser","_globalStylesId","__experimentalGetCurrentGlobalStylesId","record","kind","name","id","hasResolved","raw","editEntityRecord","config","setConfig","callbackOrObject","options","_record$title","_record$styles","_record$settings","_record$_links","console","log","currentConfig","updatedConfig","useGlobalStylesBaseConfig","__experimentalGetCurrentThemeBaseGlobalStyles","useGlobalStylesContext","isUserConfigReady","setUserConfig","isBaseConfigReady","mergedConfig","context","merged","GlobalStylesProvider","children","Provider","value"],"sources":["@wordpress/editor/src/components/global-styles-provider/index.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport deepmerge from 'deepmerge';\r\nimport { isPlainObject } from 'is-plain-object';\r\n\r\n/**\r\n * WordPress dependencies\r\n */\r\nimport { privateApis as blockEditorPrivateApis } from '@wordpress/block-editor';\r\nimport { store as coreStore } from '@wordpress/core-data';\r\nimport { useSelect, useDispatch } from '@wordpress/data';\r\nimport { useMemo, useCallback } from '@wordpress/element';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { unlock } from '../../lock-unlock';\r\n\r\nconst { GlobalStylesContext, cleanEmptyObject } = unlock(\r\n\tblockEditorPrivateApis\r\n);\r\n\r\nexport function mergeBaseAndUserConfigs( base, user ) {\r\n\treturn deepmerge( base, user, {\r\n\t\t/*\r\n\t\t * We only pass as arrays the presets,\r\n\t\t * in which case we want the new array of values\r\n\t\t * to override the old array (no merging).\r\n\t\t */\r\n\t\tisMergeableObject: isPlainObject,\r\n\t\t/*\r\n\t\t * Exceptions to the above rule.\r\n\t\t * Background images should be replaced, not merged,\r\n\t\t * as they themselves are specific object definitions for the style.\r\n\t\t */\r\n\t\tcustomMerge: ( key ) => {\r\n\t\t\tif ( key === 'backgroundImage' ) {\r\n\t\t\t\treturn ( baseConfig, userConfig ) => userConfig;\r\n\t\t\t}\r\n\t\t\treturn undefined;\r\n\t\t},\r\n\t} );\r\n}\r\n\r\nfunction useGlobalStylesUserConfig() {\r\n\tconst { globalStylesId, isReady, settings, styles, _links,title } = useSelect(\r\n\t\t( select ) => {\r\n\t\t\tconst { getEditedEntityRecord, hasFinishedResolution, canUser } =\r\n\t\t\t\tselect( coreStore );\r\n\t\t\tconst _globalStylesId =\r\n\t\t\t\tselect( coreStore ).__experimentalGetCurrentGlobalStylesId();\r\n\r\n\t\t\tconst record =\r\n\t\t\t\t_globalStylesId &&\r\n\t\t\t\tcanUser( 'read', {\r\n\t\t\t\t\tkind: 'root',\r\n\t\t\t\t\tname: 'globalStyles',\r\n\t\t\t\t\tid: _globalStylesId,\r\n\t\t\t\t} )\r\n\t\t\t\t\t? getEditedEntityRecord(\r\n\t\t\t\t\t\t\t'root',\r\n\t\t\t\t\t\t\t'globalStyles',\r\n\t\t\t\t\t\t\t_globalStylesId\r\n\t\t\t\t\t  )\r\n\t\t\t\t\t: undefined;\r\n\r\n\t\t\tlet hasResolved = false;\r\n\t\t\tif (\r\n\t\t\t\thasFinishedResolution(\r\n\t\t\t\t\t'__experimentalGetCurrentGlobalStylesId'\r\n\t\t\t\t)\r\n\t\t\t) {\r\n\t\t\t\thasResolved = _globalStylesId\r\n\t\t\t\t\t? hasFinishedResolution( 'getEditedEntityRecord', [\r\n\t\t\t\t\t\t\t'root',\r\n\t\t\t\t\t\t\t'globalStyles',\r\n\t\t\t\t\t\t\t_globalStylesId,\r\n\t\t\t\t\t  ] )\r\n\t\t\t\t\t: true;\r\n\t\t\t}\r\n\r\n\t\t\treturn {\r\n\t\t\t\tglobalStylesId: _globalStylesId,\r\n\t\t\t\tisReady: hasResolved,\r\n\t\t\t\tsettings: record?.settings,\r\n\t\t\t\tstyles: record?.styles,\r\n\t\t\t\ttitle: record?.title?.raw,\r\n\t\t\t\t_links: record?._links,\r\n\t\t\t};\r\n\t\t},\r\n\t\t[]\r\n\t);\r\n\r\n\tconst { getEditedEntityRecord } = useSelect( coreStore );\r\n\tconst { editEntityRecord } = useDispatch( coreStore );\r\n\tconst config = useMemo( () => {\r\n\t\treturn {\r\n\t\t\tsettings: settings ?? {},\r\n\t\t\tstyles: styles ?? {},\r\n\t\t\ttitle: title ?? '',\r\n\t\t\t_links: _links ?? {},\r\n\t\t};\r\n\t}, [ settings, styles, _links ] );\r\n\r\n\tconst setConfig = useCallback(\r\n\t\t/**\r\n\t\t * Set the global styles config.\r\n\t\t * @param {Function|Object} callbackOrObject If the callbackOrObject is a function, pass the current config to the callback so the consumer can merge values.\r\n\t\t *                                           Otherwise, overwrite the current config with the incoming object.\r\n\t\t * @param {Object}          options          Options for editEntityRecord Core selector.\r\n\t\t */\r\n\t\t( callbackOrObject, options = {} ) => {\r\n\t\t\tconst record = getEditedEntityRecord(\r\n\t\t\t\t'root',\r\n\t\t\t\t'globalStyles',\r\n\t\t\t\tglobalStylesId\r\n\t\t\t);\r\n\t\t\tconsole.log( record );\r\n\t\t\tconst currentConfig = {\r\n\t\t\t\ttitle: record?.title ?? '',  // seogtp添加 title\r\n\t\t\t\tstyles: record?.styles ?? {},\r\n\t\t\t\tsettings: record?.settings ?? {},\r\n\t\t\t\t_links: record?._links ?? {},\r\n\t\t\t};\r\n\t\t\tconst updatedConfig =\r\n\t\t\t\ttypeof callbackOrObject === 'function'\r\n\t\t\t\t\t? callbackOrObject( currentConfig )\r\n\t\t\t\t\t: callbackOrObject;\r\n\t\t\teditEntityRecord(\r\n\t\t\t\t'root',\r\n\t\t\t\t'globalStyles',\r\n\t\t\t\tglobalStylesId,\r\n\t\t\t\t{\r\n\t\t\t\t\tstyles: cleanEmptyObject( updatedConfig.styles ) || {},\r\n\t\t\t\t\tsettings: cleanEmptyObject( updatedConfig.settings ) || {},\r\n\t\t\t\t\t_links: cleanEmptyObject( updatedConfig._links ) || {},\r\n\t\t\t\t\ttitle: updatedConfig.title || '',  // seogtp 确保更新时保留 title\r\n\t\t\t\t},\r\n\t\t\t\toptions\r\n\t\t\t);\r\n\t\t},\r\n\t\t[ globalStylesId, editEntityRecord, getEditedEntityRecord ]\r\n\t);\r\n\r\n\treturn [ isReady, config, setConfig ];\r\n}\r\n\r\nfunction useGlobalStylesBaseConfig() {\r\n\tconst baseConfig = useSelect( ( select ) => {\r\n\t\tconst { __experimentalGetCurrentThemeBaseGlobalStyles, canUser } =\r\n\t\t\tselect( coreStore );\r\n\r\n\t\treturn (\r\n\t\t\tcanUser( 'read', { kind: 'root', name: 'theme' } ) &&\r\n\t\t\t__experimentalGetCurrentThemeBaseGlobalStyles()\r\n\t\t);\r\n\t}, [] );\r\n\r\n\treturn [ !! baseConfig, baseConfig ];\r\n}\r\n\r\nexport function useGlobalStylesContext() {\r\n\tconst [ isUserConfigReady, userConfig, setUserConfig ] =\r\n\t\tuseGlobalStylesUserConfig();\r\n\tconst [ isBaseConfigReady, baseConfig ] = useGlobalStylesBaseConfig();\r\n\r\n\tconst mergedConfig = useMemo( () => {\r\n\t\tif ( ! baseConfig || ! userConfig ) {\r\n\t\t\treturn {};\r\n\t\t}\r\n\r\n\t\treturn mergeBaseAndUserConfigs( baseConfig, userConfig );\r\n\t}, [ userConfig, baseConfig ] );\r\n\r\n\tconst context = useMemo( () => {\r\n\t\treturn {\r\n\t\t\tisReady: isUserConfigReady && isBaseConfigReady,\r\n\t\t\tuser: userConfig,\r\n\t\t\tbase: baseConfig,\r\n\t\t\tmerged: mergedConfig,\r\n\t\t\tsetUserConfig,\r\n\t\t};\r\n\t}, [\r\n\t\tmergedConfig,\r\n\t\tuserConfig,\r\n\t\tbaseConfig,\r\n\t\tsetUserConfig,\r\n\t\tisUserConfigReady,\r\n\t\tisBaseConfigReady,\r\n\t] );\r\n\r\n\treturn context;\r\n}\r\n\r\nexport function GlobalStylesProvider( { children } ) {\r\n\tconst context = useGlobalStylesContext();\r\n\tif ( ! context.isReady ) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\treturn (\r\n\t\t<GlobalStylesContext.Provider value={ context }>\r\n\t\t\t{ children }\r\n\t\t</GlobalStylesContext.Provider>\r\n\t);\r\n}\r\n"],"mappings":"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","ignoreList":[]}