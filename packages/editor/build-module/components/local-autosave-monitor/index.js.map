{"version":3,"names":["useCallback","useEffect","useRef","ifCondition","usePrevious","useSelect","useDispatch","__","parse","store","noticesStore","AutosaveMonitor","localAutosaveGet","localAutosaveClear","editorStore","jsx","_jsx","requestIdleCallback","window","requestAnimationFrame","hasStorageSupport","hasSessionStorageSupport","undefined","sessionStorage","setItem","removeItem","useAutosaveNotice","postId","isEditedPostNew","hasRemoteAutosave","select","getCurrentPostId","getEditorSettings","autosave","getEditedPostAttribute","createWarningNotice","removeNotice","editPost","resetEditorBlocks","localAutosave","JSON","post_title","title","content","excerpt","edits","hasDifference","Object","keys","some","key","id","actions","label","onClick","editsContent","editsWithoutContent","useAutosavePurge","isDirty","isAutosaving","didError","isEditedPostDirty","isAutosavingPost","didPostSaveRequestFail","lastIsDirtyRef","lastIsAutosavingRef","current","wasEditedPostNew","prevPostId","LocalAutosaveMonitor","deferredAutosave","local","localAutosaveInterval","interval"],"sources":["@wordpress/editor/src/components/local-autosave-monitor/index.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useCallback, useEffect, useRef } from '@wordpress/element';\r\nimport { ifCondition, usePrevious } from '@wordpress/compose';\r\nimport { useSelect, useDispatch } from '@wordpress/data';\r\nimport { __ } from '@wordpress/i18n';\r\nimport { parse } from '@wordpress/blocks';\r\nimport { store as noticesStore } from '@wordpress/notices';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport AutosaveMonitor from '../autosave-monitor';\r\nimport {\r\n\tlocalAutosaveGet,\r\n\tlocalAutosaveClear,\r\n} from '../../store/local-autosave';\r\nimport { store as editorStore } from '../../store';\r\n\r\nconst requestIdleCallback = window.requestIdleCallback\r\n\t? window.requestIdleCallback\r\n\t: window.requestAnimationFrame;\r\n\r\nlet hasStorageSupport;\r\n\r\n/**\r\n * Function which returns true if the current environment supports browser\r\n * sessionStorage, or false otherwise. The result of this function is cached and\r\n * reused in subsequent invocations.\r\n */\r\nconst hasSessionStorageSupport = () => {\r\n\tif ( hasStorageSupport !== undefined ) {\r\n\t\treturn hasStorageSupport;\r\n\t}\r\n\r\n\ttry {\r\n\t\t// Private Browsing in Safari 10 and earlier will throw an error when\r\n\t\t// attempting to set into sessionStorage. The test here is intentional in\r\n\t\t// causing a thrown error as condition bailing from local autosave.\r\n\t\twindow.sessionStorage.setItem( '__wpEditorTestSessionStorage', '' );\r\n\t\twindow.sessionStorage.removeItem( '__wpEditorTestSessionStorage' );\r\n\t\thasStorageSupport = true;\r\n\t} catch {\r\n\t\thasStorageSupport = false;\r\n\t}\r\n\r\n\treturn hasStorageSupport;\r\n};\r\n\r\n/**\r\n * Custom hook which manages the creation of a notice prompting the user to\r\n * restore a local autosave, if one exists.\r\n */\r\nfunction useAutosaveNotice() {\r\n\tconst { postId, isEditedPostNew, hasRemoteAutosave } = useSelect(\r\n\t\t( select ) => ( {\r\n\t\t\tpostId: select( editorStore ).getCurrentPostId(),\r\n\t\t\tisEditedPostNew: select( editorStore ).isEditedPostNew(),\r\n\t\t\thasRemoteAutosave:\r\n\t\t\t\t!! select( editorStore ).getEditorSettings().autosave,\r\n\t\t} ),\r\n\t\t[]\r\n\t);\r\n\tconst { getEditedPostAttribute } = useSelect( editorStore );\r\n\r\n\tconst { createWarningNotice, removeNotice } = useDispatch( noticesStore );\r\n\tconst { editPost, resetEditorBlocks } = useDispatch( editorStore );\r\n\r\n\tuseEffect( () => {\r\n\t\tlet localAutosave = localAutosaveGet( postId, isEditedPostNew );\r\n\t\tif ( ! localAutosave ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlocalAutosave = JSON.parse( localAutosave );\r\n\t\t} catch {\r\n\t\t\t// Not usable if it can't be parsed.\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst { post_title: title, content, excerpt } = localAutosave;\r\n\t\tconst edits = { title, content, excerpt };\r\n\r\n\t\t{\r\n\t\t\t// Only display a notice if there is a difference between what has been\r\n\t\t\t// saved and that which is stored in sessionStorage.\r\n\t\t\tconst hasDifference = Object.keys( edits ).some( ( key ) => {\r\n\t\t\t\treturn edits[ key ] !== getEditedPostAttribute( key );\r\n\t\t\t} );\r\n\r\n\t\t\tif ( ! hasDifference ) {\r\n\t\t\t\t// If there is no difference, it can be safely ejected from storage.\r\n\t\t\t\tlocalAutosaveClear( postId, isEditedPostNew );\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ( hasRemoteAutosave ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst id = 'wpEditorAutosaveRestore';\r\n\r\n\t\tcreateWarningNotice(\r\n\t\t\t__(\r\n\t\t\t\t'The backup of this post in your browser is different from the version below.'\r\n\t\t\t),\r\n\t\t\t{\r\n\t\t\t\tid,\r\n\t\t\t\tactions: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlabel: __( 'Restore the backup' ),\r\n\t\t\t\t\t\tonClick() {\r\n\t\t\t\t\t\t\tconst {\r\n\t\t\t\t\t\t\t\tcontent: editsContent,\r\n\t\t\t\t\t\t\t\t...editsWithoutContent\r\n\t\t\t\t\t\t\t} = edits;\r\n\t\t\t\t\t\t\teditPost( editsWithoutContent );\r\n\t\t\t\t\t\t\tresetEditorBlocks( parse( edits.content ) );\r\n\t\t\t\t\t\t\tremoveNotice( id );\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t}\r\n\t\t);\r\n\t}, [ isEditedPostNew, postId ] );\r\n}\r\n\r\n/**\r\n * Custom hook which ejects a local autosave after a successful save occurs.\r\n */\r\nfunction useAutosavePurge() {\r\n\tconst { postId, isEditedPostNew, isDirty, isAutosaving, didError } =\r\n\t\tuseSelect(\r\n\t\t\t( select ) => ( {\r\n\t\t\t\tpostId: select( editorStore ).getCurrentPostId(),\r\n\t\t\t\tisEditedPostNew: select( editorStore ).isEditedPostNew(),\r\n\t\t\t\tisDirty: select( editorStore ).isEditedPostDirty(),\r\n\t\t\t\tisAutosaving: select( editorStore ).isAutosavingPost(),\r\n\t\t\t\tdidError: select( editorStore ).didPostSaveRequestFail(),\r\n\t\t\t} ),\r\n\t\t\t[]\r\n\t\t);\r\n\r\n\tconst lastIsDirtyRef = useRef( isDirty );\r\n\tconst lastIsAutosavingRef = useRef( isAutosaving );\r\n\r\n\tuseEffect( () => {\r\n\t\tif (\r\n\t\t\t! didError &&\r\n\t\t\t( ( lastIsAutosavingRef.current && ! isAutosaving ) ||\r\n\t\t\t\t( lastIsDirtyRef.current && ! isDirty ) )\r\n\t\t) {\r\n\t\t\tlocalAutosaveClear( postId, isEditedPostNew );\r\n\t\t}\r\n\r\n\t\tlastIsDirtyRef.current = isDirty;\r\n\t\tlastIsAutosavingRef.current = isAutosaving;\r\n\t}, [ isDirty, isAutosaving, didError ] );\r\n\r\n\t// Once the isEditedPostNew changes from true to false, let's clear the auto-draft autosave.\r\n\tconst wasEditedPostNew = usePrevious( isEditedPostNew );\r\n\tconst prevPostId = usePrevious( postId );\r\n\tuseEffect( () => {\r\n\t\tif ( prevPostId === postId && wasEditedPostNew && ! isEditedPostNew ) {\r\n\t\t\tlocalAutosaveClear( postId, true );\r\n\t\t}\r\n\t}, [ isEditedPostNew, postId ] );\r\n}\r\n\r\nfunction LocalAutosaveMonitor() {\r\n\tconst { autosave } = useDispatch( editorStore );\r\n\tconst deferredAutosave = useCallback( () => {\r\n\t\trequestIdleCallback( () => autosave( { local: true } ) );\r\n\t}, [] );\r\n\tuseAutosaveNotice();\r\n\tuseAutosavePurge();\r\n\r\n\tconst localAutosaveInterval = useSelect(\r\n\t\t( select ) =>\r\n\t\t\tselect( editorStore ).getEditorSettings().localAutosaveInterval,\r\n\t\t[]\r\n\t);\r\n\r\n\treturn (\r\n\t\t<AutosaveMonitor\r\n\t\t\tinterval={ localAutosaveInterval }\r\n\t\t\tautosave={ deferredAutosave }\r\n\t\t/>\r\n\t);\r\n}\r\n\r\n/**\r\n * Monitors local autosaves of a post in the editor.\r\n * It uses several hooks and functions to manage autosave behavior:\r\n * - `useAutosaveNotice` hook: Manages the creation of a notice prompting the user to restore a local autosave, if one exists.\r\n * - `useAutosavePurge` hook: Ejects a local autosave after a successful save occurs.\r\n * - `hasSessionStorageSupport` function: Checks if the current environment supports browser sessionStorage.\r\n * - `LocalAutosaveMonitor` component: Uses the `AutosaveMonitor` component to perform autosaves at a specified interval.\r\n *\r\n * The module also checks for sessionStorage support and conditionally exports the `LocalAutosaveMonitor` component based on that.\r\n *\r\n * @module LocalAutosaveMonitor\r\n */\r\nexport default ifCondition( hasSessionStorageSupport )( LocalAutosaveMonitor );\r\n"],"mappings":"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","ignoreList":[]}