{"version":3,"names":["__","useState","useLayoutEffect","useEffect","getTextContent","applyFormat","removeFormat","slice","isCollapsed","insert","create","isURL","isEmail","isPhoneNumber","RichTextToolbarButton","RichTextShortcut","decodeEntities","link","linkIcon","speak","InlineLinkUI","isValidHref","jsx","_jsx","Fragment","_Fragment","jsxs","_jsxs","name","title","Edit","isActive","activeAttributes","value","onChange","onFocus","contentRef","addingLink","setAddingLink","openedBy","setOpenedBy","editableContentElement","current","handleClick","event","target","closest","el","action","addEventListener","removeEventListener","addLink","text","type","attributes","url","replace","stopAddingLink","tagName","focus","onFocusOutside","onRemoveFormat","shouldAutoFocus","children","character","onUse","icon","onClick","currentTarget","shortcutType","shortcutCharacter","focusOnMount","className","id","_id","rel","__unstablePasteRule","html","plainText","pastedText","trim","test","window","console","log","format","length","edit"],"sources":["@wordpress/format-library/src/link/index.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { __ } from '@wordpress/i18n';\r\nimport { useState, useLayoutEffect, useEffect } from '@wordpress/element';\r\nimport {\r\n\tgetTextContent,\r\n\tapplyFormat,\r\n\tremoveFormat,\r\n\tslice,\r\n\tisCollapsed,\r\n\tinsert,\r\n\tcreate,\r\n} from '@wordpress/rich-text';\r\nimport { isURL, isEmail, isPhoneNumber } from '@wordpress/url';\r\nimport {\r\n\tRichTextToolbarButton,\r\n\tRichTextShortcut,\r\n} from '@wordpress/block-editor';\r\nimport { decodeEntities } from '@wordpress/html-entities';\r\nimport { link as linkIcon } from '@wordpress/icons';\r\nimport { speak } from '@wordpress/a11y';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport InlineLinkUI from './inline';\r\nimport { isValidHref } from './utils';\r\n\r\nconst name = 'core/link';\r\nconst title = __( 'Link' );\r\n\r\nfunction Edit( {\r\n\tisActive,\r\n\tactiveAttributes,\r\n\tvalue,\r\n\tonChange,\r\n\tonFocus,\r\n\tcontentRef,\r\n} ) {\r\n\tconst [ addingLink, setAddingLink ] = useState( false );\r\n\r\n\t// We only need to store the button element that opened the popover. We can ignore the other states, as they will be handled by the onFocus prop to return to the rich text field.\r\n\tconst [ openedBy, setOpenedBy ] = useState( null );\r\n\r\n\tuseEffect( () => {\r\n\t\t// When the link becomes inactive (i.e. isActive is false), reset the editingLink state\r\n\t\t// and the creatingLink state. This means that if the Link UI is displayed and the link\r\n\t\t// becomes inactive (e.g. used arrow keys to move cursor outside of link bounds), the UI will close.\r\n\t\tif ( ! isActive ) {\r\n\t\t\tsetAddingLink( false );\r\n\t\t}\r\n\t}, [ isActive ] );\r\n\r\n\tuseLayoutEffect( () => {\r\n\t\tconst editableContentElement = contentRef.current;\r\n\t\tif ( ! editableContentElement ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tfunction handleClick( event ) {\r\n\t\t\t// There is a situation whereby there is an existing link in the rich text\r\n\t\t\t// and the user clicks on the leftmost edge of that link and fails to activate\r\n\t\t\t// the link format, but the click event still fires on the `<a>` element.\r\n\t\t\t// This causes the `editingLink` state to be set to `true` and the link UI\r\n\t\t\t// to be rendered in \"creating\" mode. We need to check isActive to see if\r\n\t\t\t// we have an active link format.\r\n\t\t\tconst link = event.target.closest( '[contenteditable] a' );\r\n\t\t\tif (\r\n\t\t\t\t! link || // other formats (e.g. bold) may be nested within the link.\r\n\t\t\t\t! isActive\r\n\t\t\t) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tsetAddingLink( true );\r\n\t\t\tsetOpenedBy( {\r\n\t\t\t\tel: link,\r\n\t\t\t\taction: 'click',\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\teditableContentElement.addEventListener( 'click', handleClick );\r\n\r\n\t\treturn () => {\r\n\t\t\teditableContentElement.removeEventListener( 'click', handleClick );\r\n\t\t};\r\n\t}, [ contentRef, isActive ] );\r\n\r\n\tfunction addLink( target ) {\r\n\t\tconst text = getTextContent( slice( value ) );\r\n\r\n\t\tif ( ! isActive && text && isURL( text ) && isValidHref( text ) ) {\r\n\t\t\tonChange(\r\n\t\t\t\tapplyFormat( value, {\r\n\t\t\t\t\ttype: name,\r\n\t\t\t\t\tattributes: { url: text },\r\n\t\t\t\t} )\r\n\t\t\t);\r\n\t\t} else if ( ! isActive && text && isEmail( text ) ) {\r\n\t\t\tonChange(\r\n\t\t\t\tapplyFormat( value, {\r\n\t\t\t\t\ttype: name,\r\n\t\t\t\t\tattributes: { url: `mailto:${ text }` },\r\n\t\t\t\t} )\r\n\t\t\t);\r\n\t\t} else if ( ! isActive && text && isPhoneNumber( text ) ) {\r\n\t\t\tonChange(\r\n\t\t\t\tapplyFormat( value, {\r\n\t\t\t\t\ttype: name,\r\n\t\t\t\t\tattributes: { url: `tel:${ text.replace( /\\D/g, '' ) }` },\r\n\t\t\t\t} )\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tif ( target ) {\r\n\t\t\t\tsetOpenedBy( {\r\n\t\t\t\t\tel: target,\r\n\t\t\t\t\taction: null, // We don't need to distinguish between click or keyboard here\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\t\t\tsetAddingLink( true );\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Runs when the popover is closed via escape keypress, unlinking the selected text,\r\n\t * but _not_ on a click outside the popover. onFocusOutside handles that.\r\n\t */\r\n\tfunction stopAddingLink() {\r\n\t\t// Don't let the click handler on the toolbar button trigger again.\r\n\r\n\t\t// There are two places for us to return focus to on Escape keypress:\r\n\t\t// 1. The rich text field.\r\n\t\t// 2. The toolbar button.\r\n\r\n\t\t// The toolbar button is the only one we need to handle returning focus to.\r\n\t\t// Otherwise, we rely on the passed in onFocus to return focus to the rich text field.\r\n\r\n\t\t// Close the popover\r\n\t\tsetAddingLink( false );\r\n\r\n\t\t// Return focus to the toolbar button or the rich text field\r\n\t\tif ( openedBy?.el?.tagName === 'BUTTON' ) {\r\n\t\t\topenedBy.el.focus();\r\n\t\t} else {\r\n\t\t\tonFocus();\r\n\t\t}\r\n\t\t// Remove the openedBy state\r\n\t\tsetOpenedBy( null );\r\n\t}\r\n\r\n\t// Test for this:\r\n\t// 1. Click on the link button\r\n\t// 2. Click the Options button in the top right of header\r\n\t// 3. Focus should be in the dropdown of the Options button\r\n\t// 4. Press Escape\r\n\t// 5. Focus should be on the Options button\r\n\tfunction onFocusOutside() {\r\n\t\tsetAddingLink( false );\r\n\t\tsetOpenedBy( null );\r\n\t}\r\n\r\n\tfunction onRemoveFormat() {\r\n\t\tonChange( removeFormat( value, name ) );\r\n\t\tspeak( __( 'Link removed.' ), 'assertive' );\r\n\t}\r\n\r\n\t// Only autofocus if we have clicked a link within the editor\r\n\tconst shouldAutoFocus = ! (\r\n\t\topenedBy?.el?.tagName === 'A' && openedBy?.action === 'click'\r\n\t);\r\n\r\n\treturn (\r\n\t\t<>\r\n\t\t\t<RichTextShortcut type=\"primary\" character=\"k\" onUse={ addLink } />\r\n\t\t\t<RichTextShortcut\r\n\t\t\t\ttype=\"primaryShift\"\r\n\t\t\t\tcharacter=\"k\"\r\n\t\t\t\tonUse={ onRemoveFormat }\r\n\t\t\t/>\r\n\t\t\t<RichTextToolbarButton\r\n\t\t\t\tname=\"link\"\r\n\t\t\t\ticon={ linkIcon }\r\n\t\t\t\ttitle={ isActive ? __( 'Link' ) : title }\r\n\t\t\t\tonClick={ ( event ) => {\r\n\t\t\t\t\taddLink( event.currentTarget );\r\n\t\t\t\t} }\r\n\t\t\t\tisActive={ isActive || addingLink }\r\n\t\t\t\tshortcutType=\"primary\"\r\n\t\t\t\tshortcutCharacter=\"k\"\r\n\t\t\t\taria-haspopup=\"true\"\r\n\t\t\t\taria-expanded={ addingLink }\r\n\t\t\t/>\r\n\t\t\t{ addingLink && (\r\n\t\t\t\t<InlineLinkUI\r\n\t\t\t\t\tstopAddingLink={ stopAddingLink }\r\n\t\t\t\t\tonFocusOutside={ onFocusOutside }\r\n\t\t\t\t\tisActive={ isActive }\r\n\t\t\t\t\tactiveAttributes={ activeAttributes }\r\n\t\t\t\t\tvalue={ value }\r\n\t\t\t\t\tonChange={ onChange }\r\n\t\t\t\t\tcontentRef={ contentRef }\r\n\t\t\t\t\tfocusOnMount={ shouldAutoFocus ? 'firstElement' : false }\r\n\t\t\t\t/>\r\n\t\t\t) }\r\n\t\t</>\r\n\t);\r\n}\r\n\r\nexport const link = {\r\n\tname,\r\n\ttitle,\r\n\ttagName: 'a',\r\n\tclassName: null,\r\n\tattributes: {\r\n\t\turl: 'href',\r\n\t\ttype: 'data-type',\r\n\t\tid: 'data-id',\r\n\t\t_id: 'id',\r\n\t\ttarget: 'target',\r\n\t\trel: 'rel',\r\n\t},\r\n\t__unstablePasteRule( value, { html, plainText } ) {\r\n\t\tconst pastedText = ( html || plainText )\r\n\t\t\t.replace( /<[^>]+>/g, '' )\r\n\t\t\t.trim();\r\n\r\n\t\t// A URL was pasted, turn the selection into a link.\r\n\t\t// For the link pasting feature, allow only http(s) protocols.\r\n\t\tif ( ! isURL( pastedText ) || ! /^https?:/.test( pastedText ) ) {\r\n\t\t\treturn value;\r\n\t\t}\r\n\r\n\t\t// Allows us to ask for this information when we get a report.\r\n\t\twindow.console.log( 'Created link:\\n\\n', pastedText );\r\n\r\n\t\tconst format = {\r\n\t\t\ttype: name,\r\n\t\t\tattributes: {\r\n\t\t\t\turl: decodeEntities( pastedText ),\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tif ( isCollapsed( value ) ) {\r\n\t\t\treturn insert(\r\n\t\t\t\tvalue,\r\n\t\t\t\tapplyFormat(\r\n\t\t\t\t\tcreate( { text: plainText } ),\r\n\t\t\t\t\tformat,\r\n\t\t\t\t\t0,\r\n\t\t\t\t\tplainText.length\r\n\t\t\t\t)\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn applyFormat( value, format );\r\n\t},\r\n\tedit: Edit,\r\n};\r\n"],"mappings":"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","ignoreList":[]}