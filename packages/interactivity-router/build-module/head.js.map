{"version":3,"names":["updateHead","newHead","getTagId","tag","id","outerHTML","newHeadMap","Map","child","set","toRemove","document","head","children","nodeName","push","has","delete","toAppend","values","forEach","n","remove","append","fetchHeadAssets","doc","headElements","headTags","assets","tagName","selector","attribute","asset","tags","querySelectorAll","Promise","all","Array","from","map","attributeValue","getAttribute","response","fetch","text","e","console","error","headElement","get","element","createElement","innerText","attr","attributes","setAttribute","name","value","querySelector"],"sources":["@wordpress/interactivity-router/src/head.ts"],"sourcesContent":["/**\r\n * Helper to update only the necessary tags in the head.\r\n *\r\n * @async\r\n * @param newHead The head elements of the new page.\r\n */\r\nexport const updateHead = async ( newHead: HTMLHeadElement[] ) => {\r\n\t// Helper to get the tag id store in the cache.\r\n\tconst getTagId = ( tag: Element ) => tag.id || tag.outerHTML;\r\n\r\n\t// Map incoming head tags by their content.\r\n\tconst newHeadMap = new Map< string, Element >();\r\n\tfor ( const child of newHead ) {\r\n\t\tnewHeadMap.set( getTagId( child ), child );\r\n\t}\r\n\r\n\tconst toRemove: Element[] = [];\r\n\r\n\t// Detect nodes that should be added or removed.\r\n\tfor ( const child of document.head.children ) {\r\n\t\tconst id = getTagId( child );\r\n\t\t// Always remove styles and links as they might change.\r\n\t\tif ( child.nodeName === 'LINK' || child.nodeName === 'STYLE' ) {\r\n\t\t\ttoRemove.push( child );\r\n\t\t} else if ( newHeadMap.has( id ) ) {\r\n\t\t\tnewHeadMap.delete( id );\r\n\t\t} else if ( child.nodeName !== 'SCRIPT' && child.nodeName !== 'META' ) {\r\n\t\t\ttoRemove.push( child );\r\n\t\t}\r\n\t}\r\n\r\n\t// Prepare new assets.\r\n\tconst toAppend = [ ...newHeadMap.values() ];\r\n\r\n\t// Apply the changes.\r\n\ttoRemove.forEach( ( n ) => n.remove() );\r\n\tdocument.head.append( ...toAppend );\r\n};\r\n\r\n/**\r\n * Fetches and processes head assets (stylesheets and scripts) from a specified document.\r\n *\r\n * @async\r\n * @param doc               The document from which to fetch head assets. It should support standard DOM querying methods.\r\n * @param headElements      A map of head elements to modify tracking the URLs of already processed assets to avoid duplicates.\r\n * @param headElements.tag\r\n * @param headElements.text\r\n *\r\n * @return Returns an array of HTML elements representing the head assets.\r\n */\r\nexport const fetchHeadAssets = async (\r\n\tdoc: Document,\r\n\theadElements: Map< string, { tag: HTMLElement; text: string } >\r\n): Promise< HTMLElement[] > => {\r\n\tconst headTags = [];\r\n\tconst assets = [\r\n\t\t{\r\n\t\t\ttagName: 'style',\r\n\t\t\tselector: 'link[rel=stylesheet]',\r\n\t\t\tattribute: 'href',\r\n\t\t},\r\n\t\t{ tagName: 'script', selector: 'script[src]', attribute: 'src' },\r\n\t];\r\n\tfor ( const asset of assets ) {\r\n\t\tconst { tagName, selector, attribute } = asset;\r\n\t\tconst tags = doc.querySelectorAll<\r\n\t\t\tHTMLScriptElement | HTMLStyleElement\r\n\t\t>( selector );\r\n\r\n\t\t// Use Promise.all to wait for fetch to complete\r\n\t\tawait Promise.all(\r\n\t\t\tArray.from( tags ).map( async ( tag ) => {\r\n\t\t\t\tconst attributeValue = tag.getAttribute( attribute );\r\n\t\t\t\tif ( ! headElements.has( attributeValue ) ) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst response = await fetch( attributeValue );\r\n\t\t\t\t\t\tconst text = await response.text();\r\n\t\t\t\t\t\theadElements.set( attributeValue, {\r\n\t\t\t\t\t\t\ttag,\r\n\t\t\t\t\t\t\ttext,\r\n\t\t\t\t\t\t} );\r\n\t\t\t\t\t} catch ( e ) {\r\n\t\t\t\t\t\t// eslint-disable-next-line no-console\r\n\t\t\t\t\t\tconsole.error( e );\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst headElement = headElements.get( attributeValue );\r\n\t\t\t\tconst element = doc.createElement( tagName );\r\n\t\t\t\telement.innerText = headElement.text;\r\n\t\t\t\tfor ( const attr of headElement.tag.attributes ) {\r\n\t\t\t\t\telement.setAttribute( attr.name, attr.value );\r\n\t\t\t\t}\r\n\t\t\t\theadTags.push( element );\r\n\t\t\t} )\r\n\t\t);\r\n\t}\r\n\r\n\treturn [\r\n\t\tdoc.querySelector( 'title' ),\r\n\t\t...doc.querySelectorAll( 'style' ),\r\n\t\t...headTags,\r\n\t];\r\n};\r\n"],"mappings":"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","ignoreList":[]}