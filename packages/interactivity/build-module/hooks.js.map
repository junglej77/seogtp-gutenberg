{"version":3,"names":["h","createElement","options","createContext","cloneElement","useRef","useCallback","useContext","store","stores","universalUnlock","warn","getScope","setScope","resetScope","context","directiveCallbacks","directivePriorities","directive","name","callback","priority","resolve","path","namespace","resolvedStore","get","undefined","lock","current","split","reduce","acc","key","e","getEvaluate","scope","entry","args","value","Error","hasNegationOperator","slice","result","getPriorityLevels","directives","byPriority","Object","keys","obj","push","entries","sort","p1","p2","parseInt","map","arr","Directives","priorityLevels","currentPriorityLevel","nextPriorityLevels","element","originalProps","previousScope","evaluate","ref","attributes","props","children","length","directiveArgs","directiveName","wrapper","old","vnode","__directives","find","suffix","type","top"],"sources":["@wordpress/interactivity/src/hooks.tsx"],"sourcesContent":["// eslint-disable-next-line eslint-comments/disable-enable-pair\r\n/* eslint-disable react-hooks/exhaustive-deps */\r\n\r\n/**\r\n * External dependencies\r\n */\r\nimport {\r\n\th as createElement,\r\n\toptions,\r\n\tcreateContext,\r\n\tcloneElement,\r\n\ttype ComponentChildren,\r\n} from 'preact';\r\nimport { useRef, useCallback, useContext } from 'preact/hooks';\r\nimport type { VNode, Context } from 'preact';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { store, stores, universalUnlock } from './store';\r\nimport { warn } from './utils';\r\nimport { getScope, setScope, resetScope, type Scope } from './scopes';\r\nexport interface DirectiveEntry {\r\n\tvalue: string | object;\r\n\tnamespace: string;\r\n\tsuffix: string;\r\n}\r\n\r\ntype DirectiveEntries = Record< string, DirectiveEntry[] >;\r\n\r\ninterface DirectiveArgs {\r\n\t/**\r\n\t * Object map with the defined directives of the element being evaluated.\r\n\t */\r\n\tdirectives: DirectiveEntries;\r\n\t/**\r\n\t * Props present in the current element.\r\n\t */\r\n\tprops: { children?: ComponentChildren };\r\n\t/**\r\n\t * Virtual node representing the element.\r\n\t */\r\n\telement: VNode< {\r\n\t\tclass?: string;\r\n\t\tstyle?: string | Record< string, string | number >;\r\n\t\tcontent?: ComponentChildren;\r\n\t} >;\r\n\t/**\r\n\t * The inherited context.\r\n\t */\r\n\tcontext: Context< any >;\r\n\t/**\r\n\t * Function that resolves a given path to a value either in the store or the\r\n\t * context.\r\n\t */\r\n\tevaluate: Evaluate;\r\n}\r\n\r\ninterface DirectiveCallback {\r\n\t( args: DirectiveArgs ): VNode< any > | null | void;\r\n}\r\n\r\ninterface DirectiveOptions {\r\n\t/**\r\n\t * Value that specifies the priority to evaluate directives of this type.\r\n\t * Lower numbers correspond with earlier execution.\r\n\t *\r\n\t * @default 10\r\n\t */\r\n\tpriority?: number;\r\n}\r\n\r\nexport interface Evaluate {\r\n\t( entry: DirectiveEntry, ...args: any[] ): any;\r\n}\r\n\r\ninterface GetEvaluate {\r\n\t( args: { scope: Scope } ): Evaluate;\r\n}\r\n\r\ntype PriorityLevel = string[];\r\n\r\ninterface GetPriorityLevels {\r\n\t( directives: DirectiveEntries ): PriorityLevel[];\r\n}\r\n\r\ninterface DirectivesProps {\r\n\tdirectives: DirectiveEntries;\r\n\tpriorityLevels: PriorityLevel[];\r\n\telement: VNode;\r\n\toriginalProps: any;\r\n\tpreviousScope?: Scope;\r\n}\r\n\r\n// Main context.\r\nconst context = createContext< any >( {} );\r\n\r\n// WordPress Directives.\r\nconst directiveCallbacks: Record< string, DirectiveCallback > = {};\r\nconst directivePriorities: Record< string, number > = {};\r\n\r\n/**\r\n * Register a new directive type in the Interactivity API runtime.\r\n *\r\n * @example\r\n * ```js\r\n * directive(\r\n *   'alert', // Name without the `data-wp-` prefix.\r\n *   ( { directives: { alert }, element, evaluate } ) => {\r\n *     const defaultEntry = alert.find( entry => entry.suffix === 'default' );\r\n *     element.props.onclick = () => { alert( evaluate( defaultEntry ) ); }\r\n *   }\r\n * )\r\n * ```\r\n *\r\n * The previous code registers a custom directive type for displaying an alert\r\n * message whenever an element using it is clicked. The message text is obtained\r\n * from the store under the inherited namespace, using `evaluate`.\r\n *\r\n * When the HTML is processed by the Interactivity API, any element containing\r\n * the `data-wp-alert` directive will have the `onclick` event handler, e.g.,\r\n *\r\n * ```html\r\n * <div data-wp-interactive=\"messages\">\r\n *   <button data-wp-alert=\"state.alert\">Click me!</button>\r\n * </div>\r\n * ```\r\n * Note that, in the previous example, the directive callback gets the path\r\n * value (`state.alert`) from the directive entry with suffix `default`. A\r\n * custom suffix can also be specified by appending `--` to the directive\r\n * attribute, followed by the suffix, like in the following HTML snippet:\r\n *\r\n * ```html\r\n * <div data-wp-interactive=\"myblock\">\r\n *   <button\r\n *     data-wp-color--text=\"state.text\"\r\n *     data-wp-color--background=\"state.background\"\r\n *   >Click me!</button>\r\n * </div>\r\n * ```\r\n *\r\n * This could be an hypothetical implementation of the custom directive used in\r\n * the snippet above.\r\n *\r\n * @example\r\n * ```js\r\n * directive(\r\n *   'color', // Name without prefix and suffix.\r\n *   ( { directives: { color: colors }, ref, evaluate } ) =>\r\n *     colors.forEach( ( color ) => {\r\n *       if ( color.suffix = 'text' ) {\r\n *         ref.style.setProperty(\r\n *           'color',\r\n *           evaluate( color.text )\r\n *         );\r\n *       }\r\n *       if ( color.suffix = 'background' ) {\r\n *         ref.style.setProperty(\r\n *           'background-color',\r\n *           evaluate( color.background )\r\n *         );\r\n *       }\r\n *     } );\r\n *   }\r\n * )\r\n * ```\r\n *\r\n * @param name             Directive name, without the `data-wp-` prefix.\r\n * @param callback         Function that runs the directive logic.\r\n * @param options          Options object.\r\n * @param options.priority Option to control the directive execution order. The\r\n *                         lesser, the highest priority. Default is `10`.\r\n */\r\nexport const directive = (\r\n\tname: string,\r\n\tcallback: DirectiveCallback,\r\n\t{ priority = 10 }: DirectiveOptions = {}\r\n) => {\r\n\tdirectiveCallbacks[ name ] = callback;\r\n\tdirectivePriorities[ name ] = priority;\r\n};\r\n\r\n// Resolve the path to some property of the store object.\r\nconst resolve = ( path: string, namespace: string ) => {\r\n\tif ( ! namespace ) {\r\n\t\twarn(\r\n\t\t\t`Namespace missing for \"${ path }\". The value for that path won't be resolved.`\r\n\t\t);\r\n\t\treturn;\r\n\t}\r\n\tlet resolvedStore = stores.get( namespace );\r\n\tif ( typeof resolvedStore === 'undefined' ) {\r\n\t\tresolvedStore = store( namespace, undefined, {\r\n\t\t\tlock: universalUnlock,\r\n\t\t} );\r\n\t}\r\n\tconst current = {\r\n\t\t...resolvedStore,\r\n\t\tcontext: getScope().context[ namespace ],\r\n\t};\r\n\ttry {\r\n\t\t// TODO: Support lazy/dynamically initialized stores\r\n\t\treturn path.split( '.' ).reduce( ( acc, key ) => acc[ key ], current );\r\n\t} catch ( e ) {}\r\n};\r\n\r\n// Generate the evaluate function.\r\nexport const getEvaluate: GetEvaluate =\r\n\t( { scope } ) =>\r\n\t( entry, ...args ) => {\r\n\t\tlet { value: path, namespace } = entry;\r\n\t\tif ( typeof path !== 'string' ) {\r\n\t\t\tthrow new Error( 'The `value` prop should be a string path' );\r\n\t\t}\r\n\t\t// If path starts with !, remove it and save a flag.\r\n\t\tconst hasNegationOperator =\r\n\t\t\tpath[ 0 ] === '!' && !! ( path = path.slice( 1 ) );\r\n\t\tsetScope( scope );\r\n\t\tconst value = resolve( path, namespace );\r\n\t\tconst result = typeof value === 'function' ? value( ...args ) : value;\r\n\t\tresetScope();\r\n\t\treturn hasNegationOperator ? ! result : result;\r\n\t};\r\n\r\n// Separate directives by priority. The resulting array contains objects\r\n// of directives grouped by same priority, and sorted in ascending order.\r\nconst getPriorityLevels: GetPriorityLevels = ( directives ) => {\r\n\tconst byPriority = Object.keys( directives ).reduce<\r\n\t\tRecord< number, string[] >\r\n\t>( ( obj, name ) => {\r\n\t\tif ( directiveCallbacks[ name ] ) {\r\n\t\t\tconst priority = directivePriorities[ name ];\r\n\t\t\t( obj[ priority ] = obj[ priority ] || [] ).push( name );\r\n\t\t}\r\n\t\treturn obj;\r\n\t}, {} );\r\n\r\n\treturn Object.entries( byPriority )\r\n\t\t.sort( ( [ p1 ], [ p2 ] ) => parseInt( p1 ) - parseInt( p2 ) )\r\n\t\t.map( ( [ , arr ] ) => arr );\r\n};\r\n\r\n// Component that wraps each priority level of directives of an element.\r\nconst Directives = ( {\r\n\tdirectives,\r\n\tpriorityLevels: [ currentPriorityLevel, ...nextPriorityLevels ],\r\n\telement,\r\n\toriginalProps,\r\n\tpreviousScope,\r\n}: DirectivesProps ) => {\r\n\t// Initialize the scope of this element. These scopes are different per each\r\n\t// level because each level has a different context, but they share the same\r\n\t// element ref, state and props.\r\n\tconst scope = useRef< Scope >( {} as Scope ).current;\r\n\tscope.evaluate = useCallback( getEvaluate( { scope } ), [] );\r\n\tscope.context = useContext( context );\r\n\t/* eslint-disable react-hooks/rules-of-hooks */\r\n\tscope.ref = previousScope?.ref || useRef( null );\r\n\t/* eslint-enable react-hooks/rules-of-hooks */\r\n\r\n\t// Create a fresh copy of the vnode element and add the props to the scope,\r\n\t// named as attributes (HTML Attributes).\r\n\telement = cloneElement( element, { ref: scope.ref } );\r\n\tscope.attributes = element.props;\r\n\r\n\t// Recursively render the wrapper for the next priority level.\r\n\tconst children =\r\n\t\tnextPriorityLevels.length > 0\r\n\t\t\t? createElement( Directives, {\r\n\t\t\t\t\tdirectives,\r\n\t\t\t\t\tpriorityLevels: nextPriorityLevels,\r\n\t\t\t\t\telement,\r\n\t\t\t\t\toriginalProps,\r\n\t\t\t\t\tpreviousScope: scope,\r\n\t\t\t  } )\r\n\t\t\t: element;\r\n\r\n\tconst props = { ...originalProps, children };\r\n\tconst directiveArgs = {\r\n\t\tdirectives,\r\n\t\tprops,\r\n\t\telement,\r\n\t\tcontext,\r\n\t\tevaluate: scope.evaluate,\r\n\t};\r\n\r\n\tsetScope( scope );\r\n\r\n\tfor ( const directiveName of currentPriorityLevel ) {\r\n\t\tconst wrapper = directiveCallbacks[ directiveName ]?.( directiveArgs );\r\n\t\tif ( wrapper !== undefined ) {\r\n\t\t\tprops.children = wrapper;\r\n\t\t}\r\n\t}\r\n\r\n\tresetScope();\r\n\r\n\treturn props.children;\r\n};\r\n\r\n// Preact Options Hook called each time a vnode is created.\r\nconst old = options.vnode;\r\noptions.vnode = ( vnode: VNode< any > ) => {\r\n\tif ( vnode.props.__directives ) {\r\n\t\tconst props = vnode.props;\r\n\t\tconst directives = props.__directives;\r\n\t\tif ( directives.key ) {\r\n\t\t\tvnode.key = directives.key.find(\r\n\t\t\t\t( { suffix } ) => suffix === 'default'\r\n\t\t\t).value;\r\n\t\t}\r\n\t\tdelete props.__directives;\r\n\t\tconst priorityLevels = getPriorityLevels( directives );\r\n\t\tif ( priorityLevels.length > 0 ) {\r\n\t\t\tvnode.props = {\r\n\t\t\t\tdirectives,\r\n\t\t\t\tpriorityLevels,\r\n\t\t\t\toriginalProps: props,\r\n\t\t\t\ttype: vnode.type,\r\n\t\t\t\telement: createElement( vnode.type as any, props ),\r\n\t\t\t\ttop: true,\r\n\t\t\t};\r\n\t\t\tvnode.type = Directives;\r\n\t\t}\r\n\t}\r\n\r\n\tif ( old ) {\r\n\t\told( vnode );\r\n\t}\r\n};\r\n"],"mappings":"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","ignoreList":[]}