{"version":3,"names":["computed","signal","batch","getNamespaceFromProxy","getScope","setNamespace","resetNamespace","withScope","NO_SCOPE","PropSignal","constructor","owner","computedsByScope","WeakMap","setValue","value","update","setGetter","getter","get","getComputed","scope","valueSignal","getterSignal","has","callback","call","set","peek"],"sources":["@wordpress/interactivity/src/proxies/signals.ts"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport {\r\n\tcomputed,\r\n\tsignal,\r\n\tbatch,\r\n\ttype Signal,\r\n\ttype ReadonlySignal,\r\n} from '@preact/signals';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { getNamespaceFromProxy } from './registry';\r\nimport { getScope } from '../scopes';\r\nimport { setNamespace, resetNamespace } from '../namespaces';\r\nimport { withScope } from '../utils';\r\n\r\n/**\r\n * Identifier for property computeds not associated to any scope.\r\n */\r\nconst NO_SCOPE = {};\r\n\r\n/**\r\n * Structure that manages reactivity for a property in a state object. It uses\r\n * signals to keep track of property value or getter modifications.\r\n */\r\nexport class PropSignal {\r\n\t/**\r\n\t * Proxy that holds the property this PropSignal is associated with.\r\n\t */\r\n\tprivate owner: object;\r\n\r\n\t/**\r\n\t * Relation of computeds by scope. These computeds are read-only signals\r\n\t * that depend on whether the property is a value or a getter and,\r\n\t * therefore, can return different values depending on the scope in which\r\n\t * the getter is accessed.\r\n\t */\r\n\tprivate computedsByScope: WeakMap< WeakKey, ReadonlySignal >;\r\n\r\n\t/**\r\n\t * Signal with the value assigned to the related property.\r\n\t */\r\n\tprivate valueSignal?: Signal;\r\n\r\n\t/**\r\n\t * Signal with the getter assigned to the related property.\r\n\t */\r\n\tprivate getterSignal?: Signal< ( () => any ) | undefined >;\r\n\r\n\t/**\r\n\t * Structure that manages reactivity for a property in a state object, using\r\n\t * signals to keep track of property value or getter modifications.\r\n\t *\r\n\t * @param owner Proxy that holds the property this instance is associated\r\n\t *              with.\r\n\t */\r\n\tconstructor( owner: object ) {\r\n\t\tthis.owner = owner;\r\n\t\tthis.computedsByScope = new WeakMap();\r\n\t}\r\n\r\n\t/**\r\n\t * Changes the internal value. If a getter was set before, it is set to\r\n\t * `undefined`.\r\n\t *\r\n\t * @param value New value.\r\n\t */\r\n\tpublic setValue( value: unknown ) {\r\n\t\tthis.update( { value } );\r\n\t}\r\n\r\n\t/**\r\n\t * Changes the internal getter. If a value was set before, it is set to\r\n\t * `undefined`.\r\n\t *\r\n\t * @param getter New getter.\r\n\t */\r\n\tpublic setGetter( getter: () => any ) {\r\n\t\tthis.update( { get: getter } );\r\n\t}\r\n\r\n\t/**\r\n\t * Returns the computed that holds the result of evaluating the prop in the\r\n\t * current scope.\r\n\t *\r\n\t * These computeds are read-only signals that depend on whether the property\r\n\t * is a value or a getter and, therefore, can return different values\r\n\t * depending on the scope in which the getter is accessed.\r\n\t *\r\n\t * @return Computed that depends on the scope.\r\n\t */\r\n\tpublic getComputed(): ReadonlySignal {\r\n\t\tconst scope = getScope() || NO_SCOPE;\r\n\r\n\t\tif ( ! this.valueSignal && ! this.getterSignal ) {\r\n\t\t\tthis.update( {} );\r\n\t\t}\r\n\r\n\t\tif ( ! this.computedsByScope.has( scope ) ) {\r\n\t\t\tconst callback = () => {\r\n\t\t\t\tconst getter = this.getterSignal?.value;\r\n\t\t\t\treturn getter\r\n\t\t\t\t\t? getter.call( this.owner )\r\n\t\t\t\t\t: this.valueSignal?.value;\r\n\t\t\t};\r\n\r\n\t\t\tsetNamespace( getNamespaceFromProxy( this.owner ) );\r\n\t\t\tthis.computedsByScope.set(\r\n\t\t\t\tscope,\r\n\t\t\t\tcomputed( withScope( callback ) )\r\n\t\t\t);\r\n\t\t\tresetNamespace();\r\n\t\t}\r\n\r\n\t\treturn this.computedsByScope.get( scope )!;\r\n\t}\r\n\r\n\t/**\r\n\t *  Update the internal signals for the value and the getter of the\r\n\t *  corresponding prop.\r\n\t *\r\n\t * @param param0\r\n\t * @param param0.get   New getter.\r\n\t * @param param0.value New value.\r\n\t */\r\n\tprivate update( { get, value }: { get?: () => any; value?: unknown } ) {\r\n\t\tif ( ! this.valueSignal ) {\r\n\t\t\tthis.valueSignal = signal( value );\r\n\t\t\tthis.getterSignal = signal( get );\r\n\t\t} else if (\r\n\t\t\tvalue !== this.valueSignal.peek() ||\r\n\t\t\tget !== this.getterSignal!.peek()\r\n\t\t) {\r\n\t\t\tbatch( () => {\r\n\t\t\t\tthis.valueSignal!.value = value;\r\n\t\t\t\tthis.getterSignal!.value = get;\r\n\t\t\t} );\r\n\t\t}\r\n\t}\r\n}\r\n"],"mappings":"AAAA;AACA;AACA;AACA,SACCA,QAAQ,EACRC,MAAM,EACNC,KAAK,QAGC,iBAAiB;;AAExB;AACA;AACA;AACA,SAASC,qBAAqB,QAAQ,YAAY;AAClD,SAASC,QAAQ,QAAQ,WAAW;AACpC,SAASC,YAAY,EAAEC,cAAc,QAAQ,eAAe;AAC5D,SAASC,SAAS,QAAQ,UAAU;;AAEpC;AACA;AACA;AACA,MAAMC,QAAQ,GAAG,CAAC,CAAC;;AAEnB;AACA;AACA;AACA;AACA,OAAO,MAAMC,UAAU,CAAC;EACvB;AACD;AACA;;EAGC;AACD;AACA;AACA;AACA;AACA;;EAGC;AACD;AACA;;EAGC;AACD;AACA;;EAGC;AACD;AACA;AACA;AACA;AACA;AACA;EACCC,WAAWA,CAAEC,KAAa,EAAG;IAC5B,IAAI,CAACA,KAAK,GAAGA,KAAK;IAClB,IAAI,CAACC,gBAAgB,GAAG,IAAIC,OAAO,CAAC,CAAC;EACtC;;EAEA;AACD;AACA;AACA;AACA;AACA;EACQC,QAAQA,CAAEC,KAAc,EAAG;IACjC,IAAI,CAACC,MAAM,CAAE;MAAED;IAAM,CAAE,CAAC;EACzB;;EAEA;AACD;AACA;AACA;AACA;AACA;EACQE,SAASA,CAAEC,MAAiB,EAAG;IACrC,IAAI,CAACF,MAAM,CAAE;MAAEG,GAAG,EAAED;IAAO,CAAE,CAAC;EAC/B;;EAEA;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACQE,WAAWA,CAAA,EAAmB;IACpC,MAAMC,KAAK,GAAGjB,QAAQ,CAAC,CAAC,IAAII,QAAQ;IAEpC,IAAK,CAAE,IAAI,CAACc,WAAW,IAAI,CAAE,IAAI,CAACC,YAAY,EAAG;MAChD,IAAI,CAACP,MAAM,CAAE,CAAC,CAAE,CAAC;IAClB;IAEA,IAAK,CAAE,IAAI,CAACJ,gBAAgB,CAACY,GAAG,CAAEH,KAAM,CAAC,EAAG;MAC3C,MAAMI,QAAQ,GAAGA,CAAA,KAAM;QACtB,MAAMP,MAAM,GAAG,IAAI,CAACK,YAAY,EAAER,KAAK;QACvC,OAAOG,MAAM,GACVA,MAAM,CAACQ,IAAI,CAAE,IAAI,CAACf,KAAM,CAAC,GACzB,IAAI,CAACW,WAAW,EAAEP,KAAK;MAC3B,CAAC;MAEDV,YAAY,CAAEF,qBAAqB,CAAE,IAAI,CAACQ,KAAM,CAAE,CAAC;MACnD,IAAI,CAACC,gBAAgB,CAACe,GAAG,CACxBN,KAAK,EACLrB,QAAQ,CAAEO,SAAS,CAAEkB,QAAS,CAAE,CACjC,CAAC;MACDnB,cAAc,CAAC,CAAC;IACjB;IAEA,OAAO,IAAI,CAACM,gBAAgB,CAACO,GAAG,CAAEE,KAAM,CAAC;EAC1C;;EAEA;AACD;AACA;AACA;AACA;AACA;AACA;AACA;EACSL,MAAMA,CAAE;IAAEG,GAAG;IAAEJ;EAA4C,CAAC,EAAG;IACtE,IAAK,CAAE,IAAI,CAACO,WAAW,EAAG;MACzB,IAAI,CAACA,WAAW,GAAGrB,MAAM,CAAEc,KAAM,CAAC;MAClC,IAAI,CAACQ,YAAY,GAAGtB,MAAM,CAAEkB,GAAI,CAAC;IAClC,CAAC,MAAM,IACNJ,KAAK,KAAK,IAAI,CAACO,WAAW,CAACM,IAAI,CAAC,CAAC,IACjCT,GAAG,KAAK,IAAI,CAACI,YAAY,CAAEK,IAAI,CAAC,CAAC,EAChC;MACD1B,KAAK,CAAE,MAAM;QACZ,IAAI,CAACoB,WAAW,CAAEP,KAAK,GAAGA,KAAK;QAC/B,IAAI,CAACQ,YAAY,CAAER,KAAK,GAAGI,GAAG;MAC/B,CAAE,CAAC;IACJ;EACD;AACD","ignoreList":[]}