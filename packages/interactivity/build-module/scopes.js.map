{"version":3,"names":["getNamespace","scopeStack","getScope","slice","setScope","scope","push","resetScope","pop","immutableMap","WeakMap","immutableError","Error","immutableHandlers","get","target","key","receiver","value","Reflect","deepImmutable","set","deleteProperty","has","Proxy","getContext","namespace","globalThis","SCRIPT_DEBUG","context","getElement","ref","attributes","Object","freeze","current"],"sources":["@wordpress/interactivity/src/scopes.ts"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport type { h as createElement, RefObject } from 'preact';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { getNamespace } from './namespaces';\r\nimport type { Evaluate } from './hooks';\r\n\r\nexport interface Scope {\r\n\tevaluate: Evaluate;\r\n\tcontext: object;\r\n\tref: RefObject< HTMLElement >;\r\n\tattributes: createElement.JSX.HTMLAttributes;\r\n}\r\n\r\n// Store stacks for the current scope and the default namespaces and export APIs\r\n// to interact with them.\r\nconst scopeStack: Scope[] = [];\r\n\r\nexport const getScope = () => scopeStack.slice( -1 )[ 0 ];\r\n\r\nexport const setScope = ( scope: Scope ) => {\r\n\tscopeStack.push( scope );\r\n};\r\nexport const resetScope = () => {\r\n\tscopeStack.pop();\r\n};\r\n\r\n// Wrap the element props to prevent modifications.\r\nconst immutableMap = new WeakMap();\r\nconst immutableError = () => {\r\n\tthrow new Error(\r\n\t\t'Please use `data-wp-bind` to modify the attributes of an element.'\r\n\t);\r\n};\r\nconst immutableHandlers: ProxyHandler< object > = {\r\n\tget( target, key, receiver ) {\r\n\t\tconst value = Reflect.get( target, key, receiver );\r\n\t\treturn !! value && typeof value === 'object'\r\n\t\t\t? deepImmutable( value )\r\n\t\t\t: value;\r\n\t},\r\n\tset: immutableError,\r\n\tdeleteProperty: immutableError,\r\n};\r\nconst deepImmutable = < T extends object = {} >( target: T ): T => {\r\n\tif ( ! immutableMap.has( target ) ) {\r\n\t\timmutableMap.set( target, new Proxy( target, immutableHandlers ) );\r\n\t}\r\n\treturn immutableMap.get( target );\r\n};\r\n\r\n/**\r\n * Retrieves the context inherited by the element evaluating a function from the\r\n * store. The returned value depends on the element and the namespace where the\r\n * function calling `getContext()` exists.\r\n *\r\n * @param namespace Store namespace. By default, the namespace where the calling\r\n *                  function exists is used.\r\n * @return The context content.\r\n */\r\nexport const getContext = < T extends object >( namespace?: string ): T => {\r\n\tconst scope = getScope();\r\n\tif ( globalThis.SCRIPT_DEBUG ) {\r\n\t\tif ( ! scope ) {\r\n\t\t\tthrow Error(\r\n\t\t\t\t'Cannot call `getContext()` when there is no scope. If you are using an async function, please consider using a generator instead. If you are using some sort of async callbacks, like `setTimeout`, please wrap the callback with `withScope(callback)`.'\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\treturn scope.context[ namespace || getNamespace() ];\r\n};\r\n\r\n/**\r\n * Retrieves a representation of the element where a function from the store\r\n * is being evalutated. Such representation is read-only, and contains a\r\n * reference to the DOM element, its props and a local reactive state.\r\n *\r\n * @return Element representation.\r\n */\r\nexport const getElement = () => {\r\n\tconst scope = getScope();\r\n\tif ( globalThis.SCRIPT_DEBUG ) {\r\n\t\tif ( ! scope ) {\r\n\t\t\tthrow Error(\r\n\t\t\t\t'Cannot call `getElement()` when there is no scope. If you are using an async function, please consider using a generator instead. If you are using some sort of async callbacks, like `setTimeout`, please wrap the callback with `withScope(callback)`.'\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\tconst { ref, attributes } = scope;\r\n\treturn Object.freeze( {\r\n\t\tref: ref.current,\r\n\t\tattributes: deepImmutable( attributes ),\r\n\t} );\r\n};\r\n"],"mappings":"AAAA;AACA;AACA;;AAGA;AACA;AACA;AACA,SAASA,YAAY,QAAQ,cAAc;AAU3C;AACA;AACA,MAAMC,UAAmB,GAAG,EAAE;AAE9B,OAAO,MAAMC,QAAQ,GAAGA,CAAA,KAAMD,UAAU,CAACE,KAAK,CAAE,CAAC,CAAE,CAAC,CAAE,CAAC,CAAE;AAEzD,OAAO,MAAMC,QAAQ,GAAKC,KAAY,IAAM;EAC3CJ,UAAU,CAACK,IAAI,CAAED,KAAM,CAAC;AACzB,CAAC;AACD,OAAO,MAAME,UAAU,GAAGA,CAAA,KAAM;EAC/BN,UAAU,CAACO,GAAG,CAAC,CAAC;AACjB,CAAC;;AAED;AACA,MAAMC,YAAY,GAAG,IAAIC,OAAO,CAAC,CAAC;AAClC,MAAMC,cAAc,GAAGA,CAAA,KAAM;EAC5B,MAAM,IAAIC,KAAK,CACd,mEACD,CAAC;AACF,CAAC;AACD,MAAMC,iBAAyC,GAAG;EACjDC,GAAGA,CAAEC,MAAM,EAAEC,GAAG,EAAEC,QAAQ,EAAG;IAC5B,MAAMC,KAAK,GAAGC,OAAO,CAACL,GAAG,CAAEC,MAAM,EAAEC,GAAG,EAAEC,QAAS,CAAC;IAClD,OAAO,CAAC,CAAEC,KAAK,IAAI,OAAOA,KAAK,KAAK,QAAQ,GACzCE,aAAa,CAAEF,KAAM,CAAC,GACtBA,KAAK;EACT,CAAC;EACDG,GAAG,EAAEV,cAAc;EACnBW,cAAc,EAAEX;AACjB,CAAC;AACD,MAAMS,aAAa,GAA8BL,MAAS,IAAS;EAClE,IAAK,CAAEN,YAAY,CAACc,GAAG,CAAER,MAAO,CAAC,EAAG;IACnCN,YAAY,CAACY,GAAG,CAAEN,MAAM,EAAE,IAAIS,KAAK,CAAET,MAAM,EAAEF,iBAAkB,CAAE,CAAC;EACnE;EACA,OAAOJ,YAAY,CAACK,GAAG,CAAEC,MAAO,CAAC;AAClC,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAMU,UAAU,GAAyBC,SAAkB,IAAS;EAC1E,MAAMrB,KAAK,GAAGH,QAAQ,CAAC,CAAC;EACxB,IAAKyB,UAAU,CAACC,YAAY,EAAG;IAC9B,IAAK,CAAEvB,KAAK,EAAG;MACd,MAAMO,KAAK,CACV,0PACD,CAAC;IACF;EACD;EACA,OAAOP,KAAK,CAACwB,OAAO,CAAEH,SAAS,IAAI1B,YAAY,CAAC,CAAC,CAAE;AACpD,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAM8B,UAAU,GAAGA,CAAA,KAAM;EAC/B,MAAMzB,KAAK,GAAGH,QAAQ,CAAC,CAAC;EACxB,IAAKyB,UAAU,CAACC,YAAY,EAAG;IAC9B,IAAK,CAAEvB,KAAK,EAAG;MACd,MAAMO,KAAK,CACV,0PACD,CAAC;IACF;EACD;EACA,MAAM;IAAEmB,GAAG;IAAEC;EAAW,CAAC,GAAG3B,KAAK;EACjC,OAAO4B,MAAM,CAACC,MAAM,CAAE;IACrBH,GAAG,EAAEA,GAAG,CAACI,OAAO;IAChBH,UAAU,EAAEZ,aAAa,CAAEY,UAAW;EACvC,CAAE,CAAC;AACJ,CAAC","ignoreList":[]}