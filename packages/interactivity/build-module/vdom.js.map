{"version":3,"names":["h","directivePrefix","p","warn","ignoreAttr","islandAttr","fullPrefix","namespaces","currentNamespace","_namespaces","length","isObject","item","Boolean","constructor","Object","directiveParser","RegExp","nsPathRegExp","hydratedIslands","WeakSet","toVdom","root","treeWalker","document","createTreeWalker","walk","node","nodeType","data","_nodeValue","next","nextSibling","replaceWith","window","Text","nodeValue","remove","elementNode","attributes","localName","props","children","directives","ignore","island","i","attributeName","name","attributeValue","value","slice","_regexResult$","_regexResult$2","regexResult","exec","namespace","parsedValue","JSON","parse","islandNamespace","push","innerHTML","__directives","add","reduce","obj","ns","directiveMatch","prefix","suffix","content","childNodes","map","childNode","child","firstChild","vnode","nextChild","parentNode","pop","currentNode"],"sources":["@wordpress/interactivity/src/vdom.ts"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport { h, type ComponentChild, type JSX } from 'preact';\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { directivePrefix as p } from './constants';\r\nimport { warn } from './utils';\r\n\r\nconst ignoreAttr = `data-${ p }-ignore`;\r\nconst islandAttr = `data-${ p }-interactive`;\r\nconst fullPrefix = `data-${ p }-`;\r\nconst namespaces: Array< string | null > = [];\r\nconst currentNamespace = () => namespaces[ namespaces.length - 1 ] ?? null;\r\nconst isObject = ( item: unknown ): item is Record< string, unknown > =>\r\n\tBoolean( item && typeof item === 'object' && item.constructor === Object );\r\n\r\n// Regular expression for directive parsing.\r\nconst directiveParser = new RegExp(\r\n\t`^data-${ p }-` + // ${p} must be a prefix string, like 'wp'.\r\n\t\t// Match alphanumeric characters including hyphen-separated\r\n\t\t// segments. It excludes underscore intentionally to prevent confusion.\r\n\t\t// E.g., \"custom-directive\".\r\n\t\t'([a-z0-9]+(?:-[a-z0-9]+)*)' +\r\n\t\t// (Optional) Match '--' followed by any alphanumeric charachters. It\r\n\t\t// excludes underscore intentionally to prevent confusion, but it can\r\n\t\t// contain multiple hyphens. E.g., \"--custom-prefix--with-more-info\".\r\n\t\t'(?:--([a-z0-9_-]+))?$',\r\n\t'i' // Case insensitive.\r\n);\r\n\r\n// Regular expression for reference parsing. It can contain a namespace before\r\n// the reference, separated by `::`, like `some-namespace::state.somePath`.\r\n// Namespaces can contain any alphanumeric characters, hyphens, underscores or\r\n// forward slashes. References don't have any restrictions.\r\nconst nsPathRegExp = /^([\\w_\\/-]+)::(.+)$/;\r\n\r\nexport const hydratedIslands = new WeakSet();\r\n\r\n/**\r\n * Recursive function that transforms a DOM tree into vDOM.\r\n *\r\n * @param root The root element or node to start traversing on.\r\n * @return The resulting vDOM tree.\r\n */\r\nexport function toVdom( root: Node ): Array< ComponentChild > {\r\n\tconst treeWalker = document.createTreeWalker(\r\n\t\troot,\r\n\t\t205 // TEXT + CDATA_SECTION + COMMENT + PROCESSING_INSTRUCTION + ELEMENT\r\n\t);\r\n\r\n\tfunction walk(\r\n\t\tnode: Node\r\n\t): [ ComponentChild ] | [ ComponentChild, Node | null ] {\r\n\t\tconst { nodeType } = node;\r\n\r\n\t\t// TEXT_NODE (3)\r\n\t\tif ( nodeType === 3 ) {\r\n\t\t\treturn [ ( node as Text ).data ];\r\n\t\t}\r\n\r\n\t\t// CDATA_SECTION_NODE (4)\r\n\t\tif ( nodeType === 4 ) {\r\n\t\t\tconst next = treeWalker.nextSibling();\r\n\t\t\t( node as CDATASection ).replaceWith(\r\n\t\t\t\tnew window.Text( ( node as CDATASection ).nodeValue ?? '' )\r\n\t\t\t);\r\n\t\t\treturn [ node.nodeValue, next ];\r\n\t\t}\r\n\r\n\t\t// COMMENT_NODE (8) || PROCESSING_INSTRUCTION_NODE (7)\r\n\t\tif ( nodeType === 8 || nodeType === 7 ) {\r\n\t\t\tconst next = treeWalker.nextSibling();\r\n\t\t\t( node as Comment | ProcessingInstruction ).remove();\r\n\t\t\treturn [ null, next ];\r\n\t\t}\r\n\r\n\t\tconst elementNode = node as HTMLElement;\r\n\t\tconst { attributes } = elementNode;\r\n\t\tconst localName = elementNode.localName as keyof JSX.IntrinsicElements;\r\n\r\n\t\tconst props: Record< string, any > = {};\r\n\t\tconst children: Array< ComponentChild > = [];\r\n\t\tconst directives: Array<\r\n\t\t\t[ name: string, namespace: string | null, value: unknown ]\r\n\t\t> = [];\r\n\t\tlet ignore = false;\r\n\t\tlet island = false;\r\n\r\n\t\tfor ( let i = 0; i < attributes.length; i++ ) {\r\n\t\t\tconst attributeName = attributes[ i ].name;\r\n\t\t\tconst attributeValue = attributes[ i ].value;\r\n\t\t\tif (\r\n\t\t\t\tattributeName[ fullPrefix.length ] &&\r\n\t\t\t\tattributeName.slice( 0, fullPrefix.length ) === fullPrefix\r\n\t\t\t) {\r\n\t\t\t\tif ( attributeName === ignoreAttr ) {\r\n\t\t\t\t\tignore = true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst regexResult = nsPathRegExp.exec( attributeValue );\r\n\t\t\t\t\tconst namespace = regexResult?.[ 1 ] ?? null;\r\n\t\t\t\t\tlet value: any = regexResult?.[ 2 ] ?? attributeValue;\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst parsedValue = JSON.parse( value );\r\n\t\t\t\t\t\tvalue = isObject( parsedValue ) ? parsedValue : value;\r\n\t\t\t\t\t} catch {}\r\n\t\t\t\t\tif ( attributeName === islandAttr ) {\r\n\t\t\t\t\t\tisland = true;\r\n\t\t\t\t\t\tconst islandNamespace =\r\n\t\t\t\t\t\t\t// eslint-disable-next-line no-nested-ternary\r\n\t\t\t\t\t\t\ttypeof value === 'string'\r\n\t\t\t\t\t\t\t\t? value\r\n\t\t\t\t\t\t\t\t: typeof value?.namespace === 'string'\r\n\t\t\t\t\t\t\t\t? value.namespace\r\n\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\tnamespaces.push( islandNamespace );\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdirectives.push( [ attributeName, namespace, value ] );\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else if ( attributeName === 'ref' ) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tprops[ attributeName ] = attributeValue;\r\n\t\t}\r\n\r\n\t\tif ( ignore && ! island ) {\r\n\t\t\treturn [\r\n\t\t\t\th< any, any >( localName, {\r\n\t\t\t\t\t...props,\r\n\t\t\t\t\tinnerHTML: elementNode.innerHTML,\r\n\t\t\t\t\t__directives: { ignore: true },\r\n\t\t\t\t} ),\r\n\t\t\t];\r\n\t\t}\r\n\t\tif ( island ) {\r\n\t\t\thydratedIslands.add( elementNode );\r\n\t\t}\r\n\r\n\t\tif ( directives.length ) {\r\n\t\t\tprops.__directives = directives.reduce(\r\n\t\t\t\t( obj, [ name, ns, value ] ) => {\r\n\t\t\t\t\tconst directiveMatch = directiveParser.exec( name );\r\n\t\t\t\t\tif ( directiveMatch === null ) {\r\n\t\t\t\t\t\twarn( `Found malformed directive name: ${ name }.` );\r\n\t\t\t\t\t\treturn obj;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst prefix = directiveMatch[ 1 ] || '';\r\n\t\t\t\t\tconst suffix = directiveMatch[ 2 ] || 'default';\r\n\r\n\t\t\t\t\tobj[ prefix ] = obj[ prefix ] || [];\r\n\t\t\t\t\tobj[ prefix ].push( {\r\n\t\t\t\t\t\tnamespace: ns ?? currentNamespace(),\r\n\t\t\t\t\t\tvalue,\r\n\t\t\t\t\t\tsuffix,\r\n\t\t\t\t\t} );\r\n\t\t\t\t\treturn obj;\r\n\t\t\t\t},\r\n\t\t\t\t{}\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\t// @ts-expect-error Fixed in upcoming preact release https://github.com/preactjs/preact/pull/4334\r\n\t\tif ( localName === 'template' ) {\r\n\t\t\tprops.content = [\r\n\t\t\t\t...( elementNode as HTMLTemplateElement ).content.childNodes,\r\n\t\t\t].map( ( childNode ) => toVdom( childNode ) );\r\n\t\t} else {\r\n\t\t\tlet child = treeWalker.firstChild();\r\n\t\t\tif ( child ) {\r\n\t\t\t\twhile ( child ) {\r\n\t\t\t\t\tconst [ vnode, nextChild ] = walk( child );\r\n\t\t\t\t\tif ( vnode ) {\r\n\t\t\t\t\t\tchildren.push( vnode );\r\n\t\t\t\t\t}\r\n\t\t\t\t\tchild = nextChild || treeWalker.nextSibling();\r\n\t\t\t\t}\r\n\t\t\t\ttreeWalker.parentNode();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Restore previous namespace.\r\n\t\tif ( island ) {\r\n\t\t\tnamespaces.pop();\r\n\t\t}\r\n\r\n\t\treturn [ h( localName, props, children ) ];\r\n\t}\r\n\r\n\treturn walk( treeWalker.currentNode );\r\n}\r\n"],"mappings":"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","ignoreList":[]}