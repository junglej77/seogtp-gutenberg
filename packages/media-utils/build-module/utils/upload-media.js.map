{"version":3,"names":["__","sprintf","createBlobURL","revokeBlobURL","uploadToServer","validateMimeType","validateMimeTypeForUser","validateFileSize","UploadError","uploadMedia","wpAllowedMimeTypes","allowedTypes","additionalData","filesList","maxUploadFileSize","onError","onFileChange","signal","validFiles","filesSet","setAndUpdateFiles","index","value","url","filter","attachment","mediaFile","error","push","map","file","message","Error","name","code","cause","undefined"],"sources":["@wordpress/media-utils/src/utils/upload-media.ts"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { __, sprintf } from '@wordpress/i18n';\r\nimport { createBlobURL, revokeBlobURL } from '@wordpress/blob';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport type {\r\n\tAdditionalData,\r\n\tAttachment,\r\n\tOnChangeHandler,\r\n\tOnErrorHandler,\r\n\tOnSuccessHandler,\r\n} from './types';\r\nimport { uploadToServer } from './upload-to-server';\r\nimport { validateMimeType } from './validate-mime-type';\r\nimport { validateMimeTypeForUser } from './validate-mime-type-for-user';\r\nimport { validateFileSize } from './validate-file-size';\r\nimport { UploadError } from './upload-error';\r\n\r\ninterface UploadMediaArgs {\r\n\t// Additional data to include in the request.\r\n\tadditionalData?: AdditionalData;\r\n\t// Array with the types of media that can be uploaded, if unset all types are allowed.\r\n\tallowedTypes?: string[];\r\n\t// List of files.\r\n\tfilesList: File[];\r\n\t// Maximum upload size in bytes allowed for the site.\r\n\tmaxUploadFileSize?: number;\r\n\t// Function called when an error happens.\r\n\tonError?: OnErrorHandler;\r\n\t// Function called each time a file or a temporary representation of the file is available.\r\n\tonFileChange?: OnChangeHandler;\r\n\t// Function called once a file has completely finished uploading, including thumbnails.\r\n\tonSuccess?: OnSuccessHandler;\r\n\t// List of allowed mime types and file extensions.\r\n\twpAllowedMimeTypes?: Record< string, string > | null;\r\n\t// Abort signal.\r\n\tsignal?: AbortSignal;\r\n}\r\n\r\n/**\r\n * Upload a media file when the file upload button is activated\r\n * or when adding a file to the editor via drag & drop.\r\n *\r\n * @param $0                    Parameters object passed to the function.\r\n * @param $0.allowedTypes       Array with the types of media that can be uploaded, if unset all types are allowed.\r\n * @param $0.additionalData     Additional data to include in the request.\r\n * @param $0.filesList          List of files.\r\n * @param $0.maxUploadFileSize  Maximum upload size in bytes allowed for the site.\r\n * @param $0.onError            Function called when an error happens.\r\n * @param $0.onFileChange       Function called each time a file or a temporary representation of the file is available.\r\n * @param $0.wpAllowedMimeTypes List of allowed mime types and file extensions.\r\n * @param $0.signal             Abort signal.\r\n */\r\nexport function uploadMedia( {\r\n\twpAllowedMimeTypes,\r\n\tallowedTypes,\r\n\tadditionalData = {},\r\n\tfilesList,\r\n\tmaxUploadFileSize,\r\n\tonError,\r\n\tonFileChange,\r\n\tsignal,\r\n}: UploadMediaArgs ) {\r\n\tconst validFiles = [];\r\n\r\n\tconst filesSet: Array< Partial< Attachment > | null > = [];\r\n\tconst setAndUpdateFiles = ( index: number, value: Attachment | null ) => {\r\n\t\tif ( filesSet[ index ]?.url ) {\r\n\t\t\trevokeBlobURL( filesSet[ index ].url );\r\n\t\t}\r\n\t\tfilesSet[ index ] = value;\r\n\t\tonFileChange?.(\r\n\t\t\tfilesSet.filter( ( attachment ) => attachment !== null )\r\n\t\t);\r\n\t};\r\n\r\n\tfor ( const mediaFile of filesList ) {\r\n\t\t// Verify if user is allowed to upload this mime type.\r\n\t\t// Defer to the server when type not detected.\r\n\t\ttry {\r\n\t\t\tvalidateMimeTypeForUser( mediaFile, wpAllowedMimeTypes );\r\n\t\t} catch ( error: unknown ) {\r\n\t\t\tonError?.( error as Error );\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Check if the caller (e.g. a block) supports this mime type.\r\n\t\t// Defer to the server when type not detected.\r\n\t\ttry {\r\n\t\t\tvalidateMimeType( mediaFile, allowedTypes );\r\n\t\t} catch ( error: unknown ) {\r\n\t\t\tonError?.( error as Error );\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Verify if file is greater than the maximum file upload size allowed for the site.\r\n\t\ttry {\r\n\t\t\tvalidateFileSize( mediaFile, maxUploadFileSize );\r\n\t\t} catch ( error: unknown ) {\r\n\t\t\tonError?.( error as Error );\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tvalidFiles.push( mediaFile );\r\n\r\n\t\t// Set temporary URL to create placeholder media file, this is replaced\r\n\t\t// with final file from media gallery when upload is `done` below.\r\n\t\tfilesSet.push( { url: createBlobURL( mediaFile ) } );\r\n\t\tonFileChange?.( filesSet as Array< Partial< Attachment > > );\r\n\t}\r\n\r\n\tvalidFiles.map( async ( file, index ) => {\r\n\t\ttry {\r\n\t\t\tconst attachment = await uploadToServer(\r\n\t\t\t\tfile,\r\n\t\t\t\tadditionalData,\r\n\t\t\t\tsignal\r\n\t\t\t);\r\n\t\t\tsetAndUpdateFiles( index, attachment );\r\n\t\t} catch ( error ) {\r\n\t\t\t// Reset to empty on failure.\r\n\t\t\tsetAndUpdateFiles( index, null );\r\n\r\n\t\t\tlet message;\r\n\t\t\tif ( error instanceof Error ) {\r\n\t\t\t\tmessage = error.message;\r\n\t\t\t} else {\r\n\t\t\t\tmessage = sprintf(\r\n\t\t\t\t\t// translators: %s: file name\r\n\t\t\t\t\t__( 'Error while uploading file %s to the media library.' ),\r\n\t\t\t\t\tfile.name\r\n\t\t\t\t);\r\n\t\t\t}\r\n\r\n\t\t\tonError?.(\r\n\t\t\t\tnew UploadError( {\r\n\t\t\t\t\tcode: 'GENERAL',\r\n\t\t\t\t\tmessage,\r\n\t\t\t\t\tfile,\r\n\t\t\t\t\tcause: error instanceof Error ? error : undefined,\r\n\t\t\t\t} )\r\n\t\t\t);\r\n\t\t}\r\n\t} );\r\n}\r\n"],"mappings":"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","ignoreList":[]}