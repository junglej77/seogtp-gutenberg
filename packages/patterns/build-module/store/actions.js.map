{"version":3,"names":["getBlockType","cloneBlock","store","coreStore","blockEditorStore","PATTERN_SYNC_TYPES","createPattern","title","syncType","content","categories","registry","meta","unsynced","wp_pattern_sync_status","undefined","reusableBlock","status","wp_pattern_category","updatedRecord","dispatch","saveEntityRecord","createPatternFromFile","file","fileContent","text","parsedContent","JSON","parse","e","Error","__file","syncStatus","pattern","convertSyncedPatternToStatic","clientId","patternBlock","select","getBlock","existingOverrides","attributes","cloneBlocksAndRemoveBindings","blocks","map","block","metadata","id","bindings","name","attributeName","value","Object","entries","keys","length","innerBlocks","patternInnerBlocks","getBlocks","replaceBlocks","setEditingPattern","isEditing","type"],"sources":["@wordpress/patterns/src/store/actions.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\n\r\nimport { getBlockType, cloneBlock } from '@wordpress/blocks';\r\nimport { store as coreStore } from '@wordpress/core-data';\r\nimport { store as blockEditorStore } from '@wordpress/block-editor';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { PATTERN_SYNC_TYPES } from '../constants';\r\n\r\n/**\r\n * Returns a generator converting one or more static blocks into a pattern, or creating a new empty pattern.\r\n *\r\n * @param {string}             title        Pattern title.\r\n * @param {'full'|'unsynced'}  syncType     They way block is synced, 'full' or 'unsynced'.\r\n * @param {string|undefined}   [content]    Optional serialized content of blocks to convert to pattern.\r\n * @param {number[]|undefined} [categories] Ids of any selected categories.\r\n */\r\nexport const createPattern =\r\n\t( title, syncType, content, categories ) =>\r\n\tasync ( { registry } ) => {\r\n\t\tconst meta =\r\n\t\t\tsyncType === PATTERN_SYNC_TYPES.unsynced\r\n\t\t\t\t? {\r\n\t\t\t\t\t\twp_pattern_sync_status: syncType,\r\n\t\t\t\t  }\r\n\t\t\t\t: undefined;\r\n\r\n\t\tconst reusableBlock = {\r\n\t\t\ttitle,\r\n\t\t\tcontent,\r\n\t\t\tstatus: 'publish',\r\n\t\t\tmeta,\r\n\t\t\twp_pattern_category: categories,\r\n\t\t};\r\n\r\n\t\tconst updatedRecord = await registry\r\n\t\t\t.dispatch( coreStore )\r\n\t\t\t.saveEntityRecord( 'postType', 'wp_block', reusableBlock );\r\n\r\n\t\treturn updatedRecord;\r\n\t};\r\n\r\n/**\r\n * Create a pattern from a JSON file.\r\n * @param {File}               file         The JSON file instance of the pattern.\r\n * @param {number[]|undefined} [categories] Ids of any selected categories.\r\n */\r\nexport const createPatternFromFile =\r\n\t( file, categories ) =>\r\n\tasync ( { dispatch } ) => {\r\n\t\tconst fileContent = await file.text();\r\n\t\t/** @type {import('./types').PatternJSON} */\r\n\t\tlet parsedContent;\r\n\t\ttry {\r\n\t\t\tparsedContent = JSON.parse( fileContent );\r\n\t\t} catch ( e ) {\r\n\t\t\tthrow new Error( 'Invalid JSON file' );\r\n\t\t}\r\n\t\tif (\r\n\t\t\tparsedContent.__file !== 'wp_block' ||\r\n\t\t\t! parsedContent.title ||\r\n\t\t\t! parsedContent.content ||\r\n\t\t\ttypeof parsedContent.title !== 'string' ||\r\n\t\t\ttypeof parsedContent.content !== 'string' ||\r\n\t\t\t( parsedContent.syncStatus &&\r\n\t\t\t\ttypeof parsedContent.syncStatus !== 'string' )\r\n\t\t) {\r\n\t\t\tthrow new Error( 'Invalid pattern JSON file' );\r\n\t\t}\r\n\r\n\t\tconst pattern = await dispatch.createPattern(\r\n\t\t\tparsedContent.title,\r\n\t\t\tparsedContent.syncStatus,\r\n\t\t\tparsedContent.content,\r\n\t\t\tcategories\r\n\t\t);\r\n\r\n\t\treturn pattern;\r\n\t};\r\n\r\n/**\r\n * Returns a generator converting a synced pattern block into a static block.\r\n *\r\n * @param {string} clientId The client ID of the block to attach.\r\n */\r\nexport const convertSyncedPatternToStatic =\r\n\t( clientId ) =>\r\n\t( { registry } ) => {\r\n\t\tconst patternBlock = registry\r\n\t\t\t.select( blockEditorStore )\r\n\t\t\t.getBlock( clientId );\r\n\t\tconst existingOverrides = patternBlock.attributes?.content;\r\n\r\n\t\tfunction cloneBlocksAndRemoveBindings( blocks ) {\r\n\t\t\treturn blocks.map( ( block ) => {\r\n\t\t\t\tlet metadata = block.attributes.metadata;\r\n\t\t\t\tif ( metadata ) {\r\n\t\t\t\t\tmetadata = { ...metadata };\r\n\t\t\t\t\tdelete metadata.id;\r\n\t\t\t\t\tdelete metadata.bindings;\r\n\t\t\t\t\t// Use overridden values of the pattern block if they exist.\r\n\t\t\t\t\tif ( existingOverrides?.[ metadata.name ] ) {\r\n\t\t\t\t\t\t// Iterate over each overriden attribute.\r\n\t\t\t\t\t\tfor ( const [ attributeName, value ] of Object.entries(\r\n\t\t\t\t\t\t\texistingOverrides[ metadata.name ]\r\n\t\t\t\t\t\t) ) {\r\n\t\t\t\t\t\t\t// Skip if the attribute does not exist in the block type.\r\n\t\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t\t! getBlockType( block.name )?.attributes[\r\n\t\t\t\t\t\t\t\t\tattributeName\r\n\t\t\t\t\t\t\t\t]\r\n\t\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// Update the block attribute with the override value.\r\n\t\t\t\t\t\t\tblock.attributes[ attributeName ] = value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn cloneBlock(\r\n\t\t\t\t\tblock,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tmetadata:\r\n\t\t\t\t\t\t\tmetadata && Object.keys( metadata ).length > 0\r\n\t\t\t\t\t\t\t\t? metadata\r\n\t\t\t\t\t\t\t\t: undefined,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tcloneBlocksAndRemoveBindings( block.innerBlocks )\r\n\t\t\t\t);\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\tconst patternInnerBlocks = registry\r\n\t\t\t.select( blockEditorStore )\r\n\t\t\t.getBlocks( patternBlock.clientId );\r\n\r\n\t\tregistry\r\n\t\t\t.dispatch( blockEditorStore )\r\n\t\t\t.replaceBlocks(\r\n\t\t\t\tpatternBlock.clientId,\r\n\t\t\t\tcloneBlocksAndRemoveBindings( patternInnerBlocks )\r\n\t\t\t);\r\n\t};\r\n\r\n/**\r\n * Returns an action descriptor for SET_EDITING_PATTERN action.\r\n *\r\n * @param {string}  clientId  The clientID of the pattern to target.\r\n * @param {boolean} isEditing Whether the block should be in editing state.\r\n * @return {Object} Action descriptor.\r\n */\r\nexport function setEditingPattern( clientId, isEditing ) {\r\n\treturn {\r\n\t\ttype: 'SET_EDITING_PATTERN',\r\n\t\tclientId,\r\n\t\tisEditing,\r\n\t};\r\n}\r\n"],"mappings":"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","ignoreList":[]}