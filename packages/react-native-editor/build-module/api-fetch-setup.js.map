{"version":3,"names":["fetchRequest","postRequest","apiFetch","applyFilters","SUPPORTED_METHODS","SUPPORTED_ENDPOINTS","GET","POST","DISABLED_CACHING_ENDPOINTS","setTimeoutPromise","delay","Promise","resolve","setTimeout","fetchHandler","path","method","data","parse","retries","retryCount","isMethodSupported","reject","isPathSupported","responsePromise","shouldEnableCaching","parseResponse","response","isStringResponse","body","JSON","stringify","Response","headers","then","catch","error","console","warn","code","includes","supportedEndpoints","some","pattern","test","disabledEndpoints","setFetchHandler","options"],"sources":["@wordpress/react-native-editor/src/api-fetch-setup.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { fetchRequest, postRequest } from '@wordpress/react-native-bridge';\r\nimport apiFetch from '@wordpress/api-fetch';\r\nimport { applyFilters } from '@wordpress/hooks';\r\n\r\nconst SUPPORTED_METHODS = [ 'GET', 'POST' ];\r\n// Please add only wp.org API paths here!\r\nconst SUPPORTED_ENDPOINTS = {\r\n\t// Temporarily disabling themes endpoint calls within the editor.\r\n\t// Issue: https://github.com/wordpress-mobile/WordPress-Android/issues/21034\r\n\t// The editor's GET requests to the themes endpoint are not functioning as expected.\r\n\t// This is likely due to the method used for performing GET requests within the host Android app.\r\n\t// TODO: Investigate and resolve the issue with GET requests from the editor.\r\n\t// Until then, themes endpoint calls are disabled to prevent unexpected behavior.\r\n\tGET: [\r\n\t\t/wp\\/v2\\/(media|categories|blocks)\\/?\\d*?.*/i,\r\n\t\t/wp\\/v2\\/search\\?.*/i,\r\n\t\t/oembed\\/1\\.0\\/proxy\\?.*/i,\r\n\t],\r\n\tPOST: [],\r\n};\r\n\r\n// [ONLY ON ANDROID] The requests made to these endpoints won't be cached.\r\nconst DISABLED_CACHING_ENDPOINTS = [\r\n\t/wp\\/v2\\/(blocks)\\/?\\d*?.*/i,\r\n\t/oembed\\/1\\.0\\/proxy\\?.*/i,\r\n];\r\n\r\nconst setTimeoutPromise = ( delay ) =>\r\n\tnew Promise( ( resolve ) => setTimeout( resolve, delay ) );\r\n\r\nconst fetchHandler = (\r\n\t{ path, method = 'GET', data, parse },\r\n\tretries = 20,\r\n\tretryCount = 1\r\n) => {\r\n\tif ( ! isMethodSupported( method ) ) {\r\n\t\treturn Promise.reject( `Unsupported method: ${ method }` );\r\n\t}\r\n\r\n\tif ( ! isPathSupported( path, method ) ) {\r\n\t\treturn Promise.reject(\r\n\t\t\t`Unsupported path for method ${ method }: ${ path }`\r\n\t\t);\r\n\t}\r\n\r\n\tlet responsePromise;\r\n\tswitch ( method ) {\r\n\t\tcase 'GET':\r\n\t\t\tresponsePromise = fetchRequest( path, shouldEnableCaching( path ) );\r\n\t\t\tbreak;\r\n\t\tcase 'POST':\r\n\t\t\tresponsePromise = postRequest( path, data );\r\n\t\t\tbreak;\r\n\t}\r\n\r\n\tconst parseResponse = ( response ) => {\r\n\t\tconst isStringResponse = typeof response === 'string';\r\n\r\n\t\t// If the 'parse' parameter is false, return the response as a new Response object\r\n\t\t// with the JSON string. This is necessary because one of the middlewares in the API\r\n\t\t// fetch library expects the response to be a JavaScript Response object with JSON\r\n\t\t// functionality. By doing this, we ensure that the response is handled correctly\r\n\t\t// by fetch-all-middleware.\r\n\t\tif ( parse === false ) {\r\n\t\t\tconst body = isStringResponse\r\n\t\t\t\t? response\r\n\t\t\t\t: JSON.stringify( response );\r\n\t\t\treturn new Response( body, {\r\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\tif ( isStringResponse ) {\r\n\t\t\tresponse = JSON.parse( response );\r\n\t\t}\r\n\t\treturn response;\r\n\t};\r\n\r\n\treturn responsePromise.then( parseResponse ).catch( ( error ) => {\r\n\t\t// eslint-disable-next-line no-console\r\n\t\tconsole.warn( 'Network Error: ', JSON.stringify( error, null, 2 ) );\r\n\t\tif ( error.code >= 400 && error.code < 600 ) {\r\n\t\t\treturn error;\r\n\t\t} else if ( retries === 0 ) {\r\n\t\t\treturn Promise.reject( error );\r\n\t\t}\r\n\t\treturn setTimeoutPromise( 1000 * retryCount ).then( () =>\r\n\t\t\tfetchHandler( { path }, retries - 1, retryCount + 1 )\r\n\t\t);\r\n\t} );\r\n};\r\n\r\nexport const isMethodSupported = ( method ) =>\r\n\tSUPPORTED_METHODS.includes( method );\r\n\r\nexport const isPathSupported = ( path, method ) => {\r\n\tconst supportedEndpoints = applyFilters(\r\n\t\t'native.supported_endpoints',\r\n\t\tSUPPORTED_ENDPOINTS\r\n\t);\r\n\treturn supportedEndpoints[ method ].some( ( pattern ) =>\r\n\t\tpattern.test( path )\r\n\t);\r\n};\r\n\r\nexport const shouldEnableCaching = ( path ) => {\r\n\tconst disabledEndpoints = applyFilters(\r\n\t\t'native.disabled_caching_endpoints',\r\n\t\tDISABLED_CACHING_ENDPOINTS\r\n\t);\r\n\r\n\treturn ! disabledEndpoints.some( ( pattern ) => pattern.test( path ) );\r\n};\r\n\r\nexport default () => {\r\n\tapiFetch.setFetchHandler( ( options ) => fetchHandler( options ) );\r\n};\r\n"],"mappings":"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","ignoreList":[]}