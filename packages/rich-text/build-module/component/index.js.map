{"version":3,"names":["useRef","useLayoutEffect","useReducer","useMergeRefs","useRefEffect","useRegistry","create","RichTextData","apply","toHTMLString","useDefaultStyle","useBoundaryStyle","useEventListeners","useRichText","value","selectionStart","selectionEnd","placeholder","onSelectionChange","preserveWhiteSpace","onChange","__unstableDisableFormats","disableFormats","__unstableIsSelected","isSelected","__unstableDependencies","__unstableAfterParse","__unstableBeforeSerialize","__unstableAddInvisibleFormats","registry","forceRender","ref","createRecord","ownerDocument","defaultView","current","selection","getSelection","range","rangeCount","getRangeAt","element","__unstableIsEditableTree","applyRecord","newRecord","domOnly","prepareEditableTree","__unstableDomOnly","_valueRef","recordRef","setRecordFromProps","fromHTMLString","empty","text","formats","replacements","Array","length","start","end","hadSelectionUpdateRef","activeFormats","undefined","handleChange","newFormats","batch","__unstableFormats","__unstableText","applyFromProps","didMountRef","activeElement","focus","mergedRefs","record","getValue","__experimentalRichText"],"sources":["@wordpress/rich-text/src/component/index.js"],"sourcesContent":["/**\r\n * WordPress dependencies\r\n */\r\nimport { useRef, useLayoutEffect, useReducer } from '@wordpress/element';\r\nimport { useMergeRefs, useRefEffect } from '@wordpress/compose';\r\nimport { useRegistry } from '@wordpress/data';\r\n\r\n/**\r\n * Internal dependencies\r\n */\r\nimport { create, RichTextData } from '../create';\r\nimport { apply } from '../to-dom';\r\nimport { toHTMLString } from '../to-html-string';\r\nimport { useDefaultStyle } from './use-default-style';\r\nimport { useBoundaryStyle } from './use-boundary-style';\r\nimport { useEventListeners } from './event-listeners';\r\n\r\nexport function useRichText( {\r\n\tvalue = '',\r\n\tselectionStart,\r\n\tselectionEnd,\r\n\tplaceholder,\r\n\tonSelectionChange,\r\n\tpreserveWhiteSpace,\r\n\tonChange,\r\n\t__unstableDisableFormats: disableFormats,\r\n\t__unstableIsSelected: isSelected,\r\n\t__unstableDependencies = [],\r\n\t__unstableAfterParse,\r\n\t__unstableBeforeSerialize,\r\n\t__unstableAddInvisibleFormats,\r\n} ) {\r\n\tconst registry = useRegistry();\r\n\tconst [ , forceRender ] = useReducer( () => ( {} ) );\r\n\tconst ref = useRef();\r\n\r\n\tfunction createRecord() {\r\n\t\tconst {\r\n\t\t\townerDocument: { defaultView },\r\n\t\t} = ref.current;\r\n\t\tconst selection = defaultView.getSelection();\r\n\t\tconst range =\r\n\t\t\tselection.rangeCount > 0 ? selection.getRangeAt( 0 ) : null;\r\n\r\n\t\treturn create( {\r\n\t\t\telement: ref.current,\r\n\t\t\trange,\r\n\t\t\t__unstableIsEditableTree: true,\r\n\t\t} );\r\n\t}\r\n\r\n\tfunction applyRecord( newRecord, { domOnly } = {} ) {\r\n\t\tapply( {\r\n\t\t\tvalue: newRecord,\r\n\t\t\tcurrent: ref.current,\r\n\t\t\tprepareEditableTree: __unstableAddInvisibleFormats,\r\n\t\t\t__unstableDomOnly: domOnly,\r\n\t\t\tplaceholder,\r\n\t\t} );\r\n\t}\r\n\r\n\t// Internal values are updated synchronously, unlike props and state.\r\n\tconst _valueRef = useRef( value );\r\n\tconst recordRef = useRef();\r\n\r\n\tfunction setRecordFromProps() {\r\n\t\t_valueRef.current = value;\r\n\t\trecordRef.current = value;\r\n\t\tif ( ! ( value instanceof RichTextData ) ) {\r\n\t\t\trecordRef.current = value\r\n\t\t\t\t? RichTextData.fromHTMLString( value, { preserveWhiteSpace } )\r\n\t\t\t\t: RichTextData.empty();\r\n\t\t}\r\n\t\t// To do: make rich text internally work with RichTextData.\r\n\t\trecordRef.current = {\r\n\t\t\ttext: recordRef.current.text,\r\n\t\t\tformats: recordRef.current.formats,\r\n\t\t\treplacements: recordRef.current.replacements,\r\n\t\t};\r\n\t\tif ( disableFormats ) {\r\n\t\t\trecordRef.current.formats = Array( value.length );\r\n\t\t\trecordRef.current.replacements = Array( value.length );\r\n\t\t}\r\n\t\tif ( __unstableAfterParse ) {\r\n\t\t\trecordRef.current.formats = __unstableAfterParse(\r\n\t\t\t\trecordRef.current\r\n\t\t\t);\r\n\t\t}\r\n\t\trecordRef.current.start = selectionStart;\r\n\t\trecordRef.current.end = selectionEnd;\r\n\t}\r\n\r\n\tconst hadSelectionUpdateRef = useRef( false );\r\n\r\n\tif ( ! recordRef.current ) {\r\n\t\thadSelectionUpdateRef.current = isSelected;\r\n\t\tsetRecordFromProps();\r\n\t} else if (\r\n\t\tselectionStart !== recordRef.current.start ||\r\n\t\tselectionEnd !== recordRef.current.end\r\n\t) {\r\n\t\thadSelectionUpdateRef.current = isSelected;\r\n\t\trecordRef.current = {\r\n\t\t\t...recordRef.current,\r\n\t\t\tstart: selectionStart,\r\n\t\t\tend: selectionEnd,\r\n\t\t\tactiveFormats: undefined,\r\n\t\t};\r\n\t}\r\n\r\n\t/**\r\n\t * Sync the value to global state. The node tree and selection will also be\r\n\t * updated if differences are found.\r\n\t *\r\n\t * @param {Object} newRecord The record to sync and apply.\r\n\t */\r\n\tfunction handleChange( newRecord ) {\r\n\t\trecordRef.current = newRecord;\r\n\t\tapplyRecord( newRecord );\r\n\r\n\t\tif ( disableFormats ) {\r\n\t\t\t_valueRef.current = newRecord.text;\r\n\t\t} else {\r\n\t\t\tconst newFormats = __unstableBeforeSerialize\r\n\t\t\t\t? __unstableBeforeSerialize( newRecord )\r\n\t\t\t\t: newRecord.formats;\r\n\t\t\tnewRecord = { ...newRecord, formats: newFormats };\r\n\t\t\tif ( typeof value === 'string' ) {\r\n\t\t\t\t_valueRef.current = toHTMLString( {\r\n\t\t\t\t\tvalue: newRecord,\r\n\t\t\t\t\tpreserveWhiteSpace,\r\n\t\t\t\t} );\r\n\t\t\t} else {\r\n\t\t\t\t_valueRef.current = new RichTextData( newRecord );\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst { start, end, formats, text } = recordRef.current;\r\n\r\n\t\t// Selection must be updated first, so it is recorded in history when\r\n\t\t// the content change happens.\r\n\t\t// We batch both calls to only attempt to rerender once.\r\n\t\tregistry.batch( () => {\r\n\t\t\tonSelectionChange( start, end );\r\n\t\t\tonChange( _valueRef.current, {\r\n\t\t\t\t__unstableFormats: formats,\r\n\t\t\t\t__unstableText: text,\r\n\t\t\t} );\r\n\t\t} );\r\n\t\tforceRender();\r\n\t}\r\n\r\n\tfunction applyFromProps() {\r\n\t\tsetRecordFromProps();\r\n\t\tapplyRecord( recordRef.current );\r\n\t}\r\n\r\n\tconst didMountRef = useRef( false );\r\n\r\n\t// Value updates must happen synchonously to avoid overwriting newer values.\r\n\tuseLayoutEffect( () => {\r\n\t\tif ( didMountRef.current && value !== _valueRef.current ) {\r\n\t\t\tapplyFromProps();\r\n\t\t\tforceRender();\r\n\t\t}\r\n\t}, [ value ] );\r\n\r\n\t// Value updates must happen synchonously to avoid overwriting newer values.\r\n\tuseLayoutEffect( () => {\r\n\t\tif ( ! hadSelectionUpdateRef.current ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ( ref.current.ownerDocument.activeElement !== ref.current ) {\r\n\t\t\tref.current.focus();\r\n\t\t}\r\n\r\n\t\tapplyRecord( recordRef.current );\r\n\t\thadSelectionUpdateRef.current = false;\r\n\t}, [ hadSelectionUpdateRef.current ] );\r\n\r\n\tconst mergedRefs = useMergeRefs( [\r\n\t\tref,\r\n\t\tuseDefaultStyle(),\r\n\t\tuseBoundaryStyle( { record: recordRef } ),\r\n\t\tuseEventListeners( {\r\n\t\t\trecord: recordRef,\r\n\t\t\thandleChange,\r\n\t\t\tapplyRecord,\r\n\t\t\tcreateRecord,\r\n\t\t\tisSelected,\r\n\t\t\tonSelectionChange,\r\n\t\t\tforceRender,\r\n\t\t} ),\r\n\t\tuseRefEffect( () => {\r\n\t\t\tapplyFromProps();\r\n\t\t\tdidMountRef.current = true;\r\n\t\t}, [ placeholder, ...__unstableDependencies ] ),\r\n\t] );\r\n\r\n\treturn {\r\n\t\tvalue: recordRef.current,\r\n\t\t// A function to get the most recent value so event handlers in\r\n\t\t// useRichText implementations have access to it. For example when\r\n\t\t// listening to input events, we internally update the state, but this\r\n\t\t// state is not yet available to the input event handler because React\r\n\t\t// may re-render asynchronously.\r\n\t\tgetValue: () => recordRef.current,\r\n\t\tonChange: handleChange,\r\n\t\tref: mergedRefs,\r\n\t};\r\n}\r\n\r\nexport default function __experimentalRichText() {}\r\n"],"mappings":"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","ignoreList":[]}