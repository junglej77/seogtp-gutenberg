{"version":3,"names":["Y","createSyncProvider","connectLocal","connectRemote","config","listeners","docs","register","objectType","objectConfig","bootstrap","objectId","handleChanges","doc","Doc","updateHandler","data","fromCRDTDoc","on","destroyLocalConnection","loadRemotely","fetch","then","transact","applyChangesToDoc","off","update","discard"],"sources":["@wordpress/sync/src/provider.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\n// @ts-ignore\r\nimport * as Y from 'yjs';\r\n\r\n/** @typedef {import('./types').ObjectType} ObjectType */\r\n/** @typedef {import('./types').ObjectID} ObjectID */\r\n/** @typedef {import('./types').ObjectConfig} ObjectConfig */\r\n/** @typedef {import('./types').CRDTDoc} CRDTDoc */\r\n/** @typedef {import('./types').ConnectDoc} ConnectDoc */\r\n/** @typedef {import('./types').SyncProvider} SyncProvider */\r\n\r\n/**\r\n * Create a sync provider.\r\n *\r\n * @param {ConnectDoc} connectLocal  Connect the document to a local database.\r\n * @param {ConnectDoc} connectRemote Connect the document to a remote sync connection.\r\n * @return {SyncProvider} Sync provider.\r\n */\r\nexport const createSyncProvider = ( connectLocal, connectRemote ) => {\r\n\t/**\r\n\t * @type {Record<string,ObjectConfig>}\r\n\t */\r\n\tconst config = {};\r\n\r\n\t/**\r\n\t * @type {Record<string,Record<string,()=>void>>}\r\n\t */\r\n\tconst listeners = {};\r\n\r\n\t/**\r\n\t * @type {Record<string,Record<string,CRDTDoc>>}\r\n\t */\r\n\tconst docs = {};\r\n\r\n\t/**\r\n\t * Registeres an object type.\r\n\t *\r\n\t * @param {ObjectType}   objectType   Object type to register.\r\n\t * @param {ObjectConfig} objectConfig Object config.\r\n\t */\r\n\tfunction register( objectType, objectConfig ) {\r\n\t\tconfig[ objectType ] = objectConfig;\r\n\t}\r\n\r\n\t/**\r\n\t * Fetch data from local database or remote source.\r\n\t *\r\n\t * @param {ObjectType} objectType    Object type to load.\r\n\t * @param {ObjectID}   objectId      Object ID to load.\r\n\t * @param {Function}   handleChanges Callback to call when data changes.\r\n\t */\r\n\tasync function bootstrap( objectType, objectId, handleChanges ) {\r\n\t\tconst doc = new Y.Doc();\r\n\t\tdocs[ objectType ] = docs[ objectType ] || {};\r\n\t\tdocs[ objectType ][ objectId ] = doc;\r\n\r\n\t\tconst updateHandler = () => {\r\n\t\t\tconst data = config[ objectType ].fromCRDTDoc( doc );\r\n\t\t\thandleChanges( data );\r\n\t\t};\r\n\t\tdoc.on( 'update', updateHandler );\r\n\r\n\t\t// connect to locally saved database.\r\n\t\tconst destroyLocalConnection = await connectLocal(\r\n\t\t\tobjectId,\r\n\t\t\tobjectType,\r\n\t\t\tdoc\r\n\t\t);\r\n\r\n\t\t// Once the database syncing is done, start the remote syncing\r\n\t\tif ( connectRemote ) {\r\n\t\t\tawait connectRemote( objectId, objectType, doc );\r\n\t\t}\r\n\r\n\t\tconst loadRemotely = config[ objectType ].fetch;\r\n\t\tif ( loadRemotely ) {\r\n\t\t\tloadRemotely( objectId ).then( ( data ) => {\r\n\t\t\t\tdoc.transact( () => {\r\n\t\t\t\t\tconfig[ objectType ].applyChangesToDoc( doc, data );\r\n\t\t\t\t} );\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\tlisteners[ objectType ] = listeners[ objectType ] || {};\r\n\t\tlisteners[ objectType ][ objectId ] = () => {\r\n\t\t\tdestroyLocalConnection();\r\n\t\t\tdoc.off( 'update', updateHandler );\r\n\t\t};\r\n\t}\r\n\r\n\t/**\r\n\t * Fetch data from local database or remote source.\r\n\t *\r\n\t * @param {ObjectType} objectType Object type to load.\r\n\t * @param {ObjectID}   objectId   Object ID to load.\r\n\t * @param {any}        data       Updates to make.\r\n\t */\r\n\tasync function update( objectType, objectId, data ) {\r\n\t\tconst doc = docs[ objectType ][ objectId ];\r\n\t\tif ( ! doc ) {\r\n\t\t\tthrow 'Error doc ' + objectType + ' ' + objectId + ' not found';\r\n\t\t}\r\n\t\tdoc.transact( () => {\r\n\t\t\tconfig[ objectType ].applyChangesToDoc( doc, data );\r\n\t\t} );\r\n\t}\r\n\r\n\t/**\r\n\t * Stop updating a document and discard it.\r\n\t *\r\n\t * @param {ObjectType} objectType Object type to load.\r\n\t * @param {ObjectID}   objectId   Object ID to load.\r\n\t */\r\n\tasync function discard( objectType, objectId ) {\r\n\t\tif ( listeners?.[ objectType ]?.[ objectId ] ) {\r\n\t\t\tlisteners[ objectType ][ objectId ]();\r\n\t\t}\r\n\t}\r\n\r\n\treturn {\r\n\t\tregister,\r\n\t\tbootstrap,\r\n\t\tupdate,\r\n\t\tdiscard,\r\n\t};\r\n};\r\n"],"mappings":"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","ignoreList":[]}