{"version":3,"names":["clsx","useRefEffect","useEffect","useState","Disabled","Placeholder","Spinner","__","apiFetch","jsx","_jsx","Fragment","_Fragment","jsxs","_jsxs","Preview","idBase","instance","isVisible","isLoaded","setIsLoaded","srcDoc","setSrcDoc","abortController","window","AbortController","undefined","fetchPreviewHTML","restRoute","path","method","signal","data","then","response","preview","catch","error","name","abort","ref","iframe","setHeight","_iframe$contentDocume","_iframe$contentDocume2","height","Math","max","contentDocument","documentElement","offsetHeight","body","style","IntersectionObserver","ownerDocument","defaultView","intersectionObserver","entry","isIntersecting","threshold","observe","addEventListener","disconnect","removeEventListener","children","className","tabIndex","title","onLoad","event","target","overflow"],"sources":["@wordpress/widgets/src/blocks/legacy-widget/edit/preview.js"],"sourcesContent":["/**\r\n * External dependencies\r\n */\r\nimport clsx from 'clsx';\r\n\r\n/**\r\n * WordPress dependencies\r\n */\r\nimport { useRefEffect } from '@wordpress/compose';\r\nimport { useEffect, useState } from '@wordpress/element';\r\nimport { Disabled, Placeholder, Spinner } from '@wordpress/components';\r\nimport { __ } from '@wordpress/i18n';\r\nimport apiFetch from '@wordpress/api-fetch';\r\n\r\nexport default function Preview( { idBase, instance, isVisible } ) {\r\n\tconst [ isLoaded, setIsLoaded ] = useState( false );\r\n\tconst [ srcDoc, setSrcDoc ] = useState( '' );\r\n\r\n\tuseEffect( () => {\r\n\t\tconst abortController =\r\n\t\t\ttypeof window.AbortController === 'undefined'\r\n\t\t\t\t? undefined\r\n\t\t\t\t: new window.AbortController();\r\n\r\n\t\tasync function fetchPreviewHTML() {\r\n\t\t\tconst restRoute = `/wp/v2/widget-types/${ idBase }/render`;\r\n\t\t\treturn await apiFetch( {\r\n\t\t\t\tpath: restRoute,\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\tsignal: abortController?.signal,\r\n\t\t\t\tdata: instance ? { instance } : {},\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\tfetchPreviewHTML()\r\n\t\t\t.then( ( response ) => {\r\n\t\t\t\tsetSrcDoc( response.preview );\r\n\t\t\t} )\r\n\t\t\t.catch( ( error ) => {\r\n\t\t\t\tif ( 'AbortError' === error.name ) {\r\n\t\t\t\t\t// We don't want to log aborted requests.\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tthrow error;\r\n\t\t\t} );\r\n\r\n\t\treturn () => abortController?.abort();\r\n\t}, [ idBase, instance ] );\r\n\r\n\t// Resize the iframe on either the load event, or when the iframe becomes visible.\r\n\tconst ref = useRefEffect(\r\n\t\t( iframe ) => {\r\n\t\t\t// Only set height if the iframe is loaded,\r\n\t\t\t// or it will grow to an unexpected large height in Safari if it's hidden initially.\r\n\t\t\tif ( ! isLoaded ) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// If the preview frame has another origin then this won't work.\r\n\t\t\t// One possible solution is to add custom script to call `postMessage` in the preview frame.\r\n\t\t\t// Or, better yet, we migrate away from iframe.\r\n\t\t\tfunction setHeight() {\r\n\t\t\t\t// Pick the maximum of these two values to account for margin collapsing.\r\n\t\t\t\tconst height = Math.max(\r\n\t\t\t\t\tiframe.contentDocument.documentElement?.offsetHeight ?? 0,\r\n\t\t\t\t\tiframe.contentDocument.body?.offsetHeight ?? 0\r\n\t\t\t\t);\r\n\r\n\t\t\t\t// Fallback to a height of 100px if the height cannot be determined.\r\n\t\t\t\t// This ensures the block is still selectable. 100px should hopefully\r\n\t\t\t\t// be not so big that it's annoying, and not so small that nothing\r\n\t\t\t\t// can be seen.\r\n\t\t\t\tiframe.style.height = `${ height !== 0 ? height : 100 }px`;\r\n\t\t\t}\r\n\r\n\t\t\tconst { IntersectionObserver } = iframe.ownerDocument.defaultView;\r\n\r\n\t\t\t// Observe for intersections that might cause a change in the height of\r\n\t\t\t// the iframe, e.g. a Widget Area becoming expanded.\r\n\t\t\tconst intersectionObserver = new IntersectionObserver(\r\n\t\t\t\t( [ entry ] ) => {\r\n\t\t\t\t\tif ( entry.isIntersecting ) {\r\n\t\t\t\t\t\tsetHeight();\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tthreshold: 1,\r\n\t\t\t\t}\r\n\t\t\t);\r\n\t\t\tintersectionObserver.observe( iframe );\r\n\r\n\t\t\tiframe.addEventListener( 'load', setHeight );\r\n\r\n\t\t\treturn () => {\r\n\t\t\t\tintersectionObserver.disconnect();\r\n\t\t\t\tiframe.removeEventListener( 'load', setHeight );\r\n\t\t\t};\r\n\t\t},\r\n\t\t[ isLoaded ]\r\n\t);\r\n\r\n\treturn (\r\n\t\t<>\r\n\t\t\t{ /*\r\n\t\t\tWhile the iframe contents are loading, we move the iframe off-screen\r\n\t\t\tand display a placeholder instead. This ensures that the user\r\n\t\t\tdoesn't see the iframe resize (which looks really janky). We have to\r\n\t\t\tmove the iframe off-screen instead of hiding it because web browsers\r\n\t\t\twill not trigger onLoad if the iframe is hidden.\r\n\t\t\t*/ }\r\n\t\t\t{ isVisible && ! isLoaded && (\r\n\t\t\t\t<Placeholder>\r\n\t\t\t\t\t<Spinner />\r\n\t\t\t\t</Placeholder>\r\n\t\t\t) }\r\n\t\t\t<div\r\n\t\t\t\tclassName={ clsx( 'wp-block-legacy-widget__edit-preview', {\r\n\t\t\t\t\t'is-offscreen': ! isVisible || ! isLoaded,\r\n\t\t\t\t} ) }\r\n\t\t\t>\r\n\t\t\t\t<Disabled>\r\n\t\t\t\t\t{ /*\r\n\t\t\t\t\tWe use an iframe so that the widget has an opportunity to\r\n\t\t\t\t\tload scripts and styles that it needs to run.\r\n\t\t\t\t\t*/ }\r\n\t\t\t\t\t<iframe\r\n\t\t\t\t\t\tref={ ref }\r\n\t\t\t\t\t\tclassName=\"wp-block-legacy-widget__edit-preview-iframe\"\r\n\t\t\t\t\t\ttabIndex=\"-1\"\r\n\t\t\t\t\t\ttitle={ __( 'Legacy Widget Preview' ) }\r\n\t\t\t\t\t\tsrcDoc={ srcDoc }\r\n\t\t\t\t\t\tonLoad={ ( event ) => {\r\n\t\t\t\t\t\t\t// To hide the scrollbars of the preview frame for some edge cases,\r\n\t\t\t\t\t\t\t// such as negative margins in the Gallery Legacy Widget.\r\n\t\t\t\t\t\t\t// It can't be scrolled anyway.\r\n\t\t\t\t\t\t\t// TODO: Ideally, this should be fixed in core.\r\n\t\t\t\t\t\t\tevent.target.contentDocument.body.style.overflow =\r\n\t\t\t\t\t\t\t\t'hidden';\r\n\r\n\t\t\t\t\t\t\tsetIsLoaded( true );\r\n\t\t\t\t\t\t} }\r\n\t\t\t\t\t\theight={ 100 }\r\n\t\t\t\t\t/>\r\n\t\t\t\t</Disabled>\r\n\t\t\t</div>\r\n\t\t</>\r\n\t);\r\n}\r\n"],"mappings":"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","ignoreList":[]}